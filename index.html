<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIFFERS Bot v7 - Market Scanner</title>
    <style>
        :root{--bg:#0a0e17;--card:#1a2235;--border:#2a3549;--text:#f1f5f9;--muted:#64748b;--green:#10b981;--red:#ef4444;--cyan:#06b6d4;--yellow:#f59e0b;--purple:#a855f7;--orange:#f97316;--blue:#3b82f6}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);padding:8px;font-size:12px}
        .container{max-width:1600px;margin:0 auto}
        .header{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:2px solid var(--cyan);margin-bottom:8px}
        .header h1{font-size:16px;color:var(--cyan)}
        .status{display:flex;align-items:center;gap:8px}
        .dot{width:10px;height:10px;border-radius:50%;background:var(--muted)}
        .dot.on{background:var(--green);box-shadow:0 0 10px var(--green)}
        .balance{font-family:monospace;font-size:14px;color:var(--green)}
        .time{font-size:10px;color:var(--muted)}
        
        .grid{display:grid;grid-template-columns:260px 1fr 300px;gap:8px}
        @media(max-width:1200px){.grid{grid-template-columns:1fr}}
        
        .card{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:10px;margin-bottom:6px}
        .card h3{font-size:9px;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px}
        .card.highlight{border:2px solid var(--cyan);background:rgba(6,182,212,0.05)}
        .card.scanner{border:2px solid var(--purple);background:rgba(168,85,247,0.05)}
        .card.paused{border:2px solid var(--red)!important;background:rgba(239,68,68,0.1)!important}
        .card.simulated{border:2px solid var(--yellow);background:rgba(245,158,11,0.05)}
        
        label{display:block;font-size:9px;color:var(--muted);margin-bottom:2px}
        input,select{width:100%;padding:5px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:11px;margin-bottom:4px}
        .row{display:grid;grid-template-columns:1fr 1fr;gap:4px}
        
        button{padding:6px 10px;border:none;border-radius:5px;font-weight:700;cursor:pointer;font-size:10px;text-transform:uppercase;transition:all 0.2s}
        .btn-blue{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;width:100%}
        .btn-cyan{background:var(--cyan);color:black}
        .btn-green{background:var(--green);color:white}
        .btn-red{background:var(--red);color:white}
        .btn-purple{background:var(--purple);color:white}
        .btn-orange{background:var(--orange);color:white}
        
        .digit-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;margin:8px 0}
        .digit-box{background:var(--bg);border:2px solid var(--border);border-radius:6px;padding:8px 4px;text-align:center;transition:all 0.2s;position:relative}
        .digit-box.coldest{border-color:var(--cyan)!important;background:rgba(6,182,212,0.25)!important;box-shadow:0 0 15px rgba(6,182,212,0.5)}
        .digit-box.just-occurred{border-color:var(--yellow)!important;background:rgba(245,158,11,0.4)!important;transform:scale(1.05)}
        .digit-box.doubled{border-color:var(--red)!important;background:rgba(239,68,68,0.4)!important;transform:scale(1.08);animation:pulse-double 0.5s ease-in-out infinite}
        .digit-box.tripled{border-color:#a855f7!important;background:rgba(168,85,247,0.5)!important;transform:scale(1.1);animation:pulse-triple 0.3s ease-in-out infinite}
        @keyframes pulse-triple{0%,100%{transform:scale(1.1)}50%{transform:scale(1.15)}}
        @keyframes pulse-double{0%,100%{transform:scale(1.08)}50%{transform:scale(1.12)}}
        .digit-num{font-size:20px;font-weight:700}
        .digit-pct{font-size:12px;color:var(--muted);margin-top:2px;font-weight:600}
        .digit-pct.cold{color:var(--cyan);font-weight:700}
        
        .scanner-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
        .scanner-metric{background:var(--bg);padding:8px;border-radius:4px;text-align:center}
        .scanner-metric .value{font-size:16px;font-weight:700;font-family:monospace}
        .scanner-metric .label{font-size:8px;color:var(--muted);text-transform:uppercase}
        .scanner-metric.good .value{color:var(--green)}
        .scanner-metric.caution .value{color:var(--yellow)}
        .scanner-metric.bad .value{color:var(--red)}
        
        .health-bar{height:8px;background:var(--bg);border-radius:4px;overflow:hidden;margin:4px 0}
        .health-fill{height:100%;transition:width 0.3s,background 0.3s}
        .health-fill.good{background:var(--green)}
        .health-fill.caution{background:var(--yellow)}
        .health-fill.bad{background:var(--red)}
        
        .verdict{padding:10px;border-radius:6px;text-align:center;font-weight:700;margin:8px 0}
        .verdict.good{background:rgba(16,185,129,0.2);border:2px solid var(--green);color:var(--green)}
        .verdict.caution{background:rgba(245,158,11,0.2);border:2px solid var(--yellow);color:var(--yellow)}
        .verdict.bad{background:rgba(239,68,68,0.2);border:2px solid var(--red);color:var(--red)}
        .verdict.scouting{background:rgba(168,85,247,0.2);border:2px solid var(--purple);color:var(--purple)}
        
        .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin:6px 0}
        .stat{background:var(--bg);padding:6px;border-radius:4px;text-align:center}
        .stat-val{font-size:14px;font-weight:700;font-family:monospace}
        .stat-val.pos{color:var(--green)}
        .stat-val.neg{color:var(--red)}
        .stat-label{font-size:7px;color:var(--muted);text-transform:uppercase}
        
        .log{background:var(--bg);border-radius:4px;padding:4px;max-height:120px;overflow-y:auto;font-family:monospace;font-size:8px}
        .log div{padding:1px 0;border-bottom:1px solid var(--border)}
        .log .win{color:var(--green)}
        .log .loss{color:var(--red)}
        .log .info{color:var(--cyan)}
        .log .alert{color:var(--yellow)}
        .log .trade{color:var(--orange);font-weight:bold}
        .log .scanner{color:var(--purple)}
        
        .sim-trades{max-height:150px;overflow-y:auto}
        .sim-trade{display:flex;justify-content:space-between;padding:4px 6px;background:var(--bg);margin-bottom:2px;border-radius:4px;font-size:9px;border-left:3px solid var(--border);opacity:0.8}
        .sim-trade.win{border-left-color:var(--green)}
        .sim-trade.loss{border-left-color:var(--red)}
        
        .trades{max-height:150px;overflow-y:auto}
        .trade-row{display:flex;justify-content:space-between;padding:4px 6px;background:var(--bg);margin-bottom:2px;border-radius:4px;font-size:9px;border-left:3px solid var(--border)}
        .trade-row.win{border-left-color:var(--green)}
        .trade-row.loss{border-left-color:var(--red)}
        
        .scout-progress{height:6px;background:var(--bg);border-radius:3px;overflow:hidden;margin:6px 0}
        .scout-fill{height:100%;background:var(--purple);transition:width 0.5s}
        
        .entry-mode{padding:6px;background:var(--bg);border-radius:4px;margin:4px 0}
        .entry-mode label{display:flex;align-items:center;gap:6px;padding:3px;cursor:pointer;font-size:9px;color:var(--text)}
        .entry-mode input[type="radio"]{width:auto;margin:0}
        .entry-mode .recommended{color:var(--green);font-size:8px}
        
        .session-limits{padding:6px;background:rgba(239,68,68,0.1);border:1px solid var(--red);border-radius:4px;margin-top:4px}
        .session-limits h4{font-size:8px;color:var(--red);margin-bottom:4px}
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üéØ DIFFERS Bot v7 - Market Scanner</h1>
        <div class="status">
            <span class="time" id="torontoTime">--:--:-- EST</span>
            <span class="balance" id="balance">$0.00</span>
            <div class="dot" id="dot"></div>
            <span id="status">Offline</span>
        </div>
    </div>
    
    <div class="grid">
        <!-- LEFT COLUMN -->
        <div>
            <div class="card">
                <h3>üîå Connection</h3>
                <label>API Token</label>
                <input type="password" id="token">
                <button class="btn-blue" onclick="connect()">Connect</button>
            </div>
            
            <div class="card">
                <h3>‚öôÔ∏è Settings</h3>
                <div class="row">
                    <div><label>Stake ($)</label><input type="number" id="stake" value="10" min="1"></div>
                    <div><label>Symbol</label>
                        <select id="symbol" onchange="changePair()">
                            <optgroup label="Volatility (1s)">
                                <option value="1HZ10V">Vol 10 (1s)</option>
                                <option value="1HZ25V">Vol 25 (1s)</option>
                                <option value="1HZ50V">Vol 50 (1s)</option>
                                <option value="1HZ75V">Vol 75 (1s)</option>
                                <option value="1HZ100V" selected>Vol 100 (1s)</option>
                            </optgroup>
                            <optgroup label="Jump Indices">
                                <option value="JD10">Jump 10</option>
                                <option value="JD25">Jump 25</option>
                                <option value="JD50">Jump 50</option>
                                <option value="JD75">Jump 75</option>
                                <option value="JD100">Jump 100</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <label>Ticks to Analyze</label>
                <input type="number" id="ticksToAnalyze" value="100" min="30" max="500">
            </div>
            
            <!-- STRATEGY 1 -->
            <div class="card" id="strat1Card">
                <h3>üî∑ Strategy 1: Two-Phase Doubles</h3>
                <label style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
                    <input type="checkbox" id="strat1Enabled" checked style="width:auto">
                    <span style="font-size:10px;font-weight:600">Enabled</span>
                </label>
                
                <div class="entry-mode">
                    <div style="font-size:8px;color:var(--muted);margin-bottom:2px">ENTRY MODE:</div>
                    <label><input type="radio" name="s1EntryMode" value="phase1"> Phase 1 Only</label>
                    <label><input type="radio" name="s1EntryMode" value="scanner"> Scanner Only</label>
                    <label><input type="radio" name="s1EntryMode" value="both" checked> Scanner + Phase 1 <span class="recommended">‚òÖ</span></label>
                </div>
                
                <div class="row">
                    <div><label>Triple ‚â§%</label><input type="number" id="tripleThreshold" value="7" step="0.5"></div>
                    <div><label>Double ‚â§%</label><input type="number" id="doubleColdThreshold" value="8" step="0.5"></div>
                </div>
                <div class="row">
                    <div><label>Trades/Cycle</label><input type="number" id="tradesPerCycle" value="3" min="1" max="10"></div>
                    <div><label>Cooldown (s)</label><input type="number" id="tripleCooldown" value="5" min="0"></div>
                </div>
                
                <div class="session-limits">
                    <h4>üéØ Session Limits</h4>
                    <div class="row">
                        <div><label>Win Target</label><input type="number" id="s1WinTarget" value="8" min="0"></div>
                        <div><label>Max Trades</label><input type="number" id="s1MaxTrades" value="15" min="0"></div>
                    </div>
                    <label style="display:flex;align-items:center;gap:4px;margin-top:2px">
                        <input type="checkbox" id="s1StopOnLoss" checked style="width:auto">Stop on loss
                    </label>
                </div>
            </div>
            
            <!-- STRATEGY 2 -->
            <div class="card" id="strat2Card">
                <h3>üî∂ Strategy 2: Coldest + Confirm</h3>
                <label style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
                    <input type="checkbox" id="strat2Enabled" style="width:auto">
                    <span style="font-size:10px;font-weight:600">Enabled</span>
                </label>
                
                <div class="entry-mode">
                    <div style="font-size:8px;color:var(--muted);margin-bottom:2px">ENTRY MODE:</div>
                    <label><input type="radio" name="s2EntryMode" value="shadow"> Shadow Only</label>
                    <label><input type="radio" name="s2EntryMode" value="scanner" checked> Scanner Only <span class="recommended">‚òÖ</span></label>
                    <label><input type="radio" name="s2EntryMode" value="both"> Scanner + Shadow</label>
                </div>
                
                <div class="row">
                    <div><label>Coldest ‚â§%</label><input type="number" id="strat2Threshold" value="6" step="0.5"></div>
                    <div><label>Stability (s)</label><input type="number" id="strat2Stability" value="3" min="1"></div>
                </div>
                
                <div class="session-limits">
                    <h4>üéØ Session Limits</h4>
                    <div class="row">
                        <div><label>Win Target</label><input type="number" id="s2WinTarget" value="5" min="0"></div>
                        <div><label>Max Trades</label><input type="number" id="s2MaxTrades" value="10" min="0"></div>
                    </div>
                    <label style="display:flex;align-items:center;gap:4px;margin-top:2px">
                        <input type="checkbox" id="s2StopOnLoss" checked style="width:auto">Stop on loss
                    </label>
                </div>
            </div>
            
            <div class="card">
                <h3>üìã Activity Log</h3>
                <div class="log" id="log"></div>
            </div>
        </div>
        
        <!-- MIDDLE COLUMN -->
        <div>
            <!-- Market Scanner -->
            <div class="card scanner" id="scannerPanel">
                <h3>üìä MARKET HEALTH SCANNER <span id="scannerStatus" style="float:right;color:var(--purple)">IDLE</span></h3>
                
                <div id="scoutProgress" style="display:none">
                    <div style="font-size:10px;text-align:center;color:var(--purple);margin-bottom:4px">
                        üîç SCOUTING... <span id="scoutTime">0:00</span> / 2:00
                    </div>
                    <div class="scout-progress"><div class="scout-fill" id="scoutFill" style="width:0%"></div></div>
                </div>
                
                <div class="scanner-grid">
                    <div>
                        <div style="font-size:9px;font-weight:600;color:var(--cyan);margin-bottom:4px">Strategy 1 Health</div>
                        <div class="scanner-metric" id="s1TripleRateBox">
                            <div class="value" id="s1TripleRate">-</div>
                            <div class="label">Triple Rate (/min)</div>
                        </div>
                        <div class="scanner-metric" id="s1DoubleTripleBox" style="margin-top:4px">
                            <div class="value" id="s1DoubleTriple">-</div>
                            <div class="label">Double‚ÜíTriple %</div>
                        </div>
                        <div class="health-bar"><div class="health-fill" id="s1HealthFill" style="width:0%"></div></div>
                        <div style="text-align:center;font-size:10px;font-weight:600" id="s1HealthText">-</div>
                    </div>
                    <div>
                        <div style="font-size:9px;font-weight:600;color:var(--green);margin-bottom:4px">Strategy 2 Health</div>
                        <div class="scanner-metric" id="s2StabilityBox">
                            <div class="value" id="s2Stability">-</div>
                            <div class="label">Coldest Stability %</div>
                        </div>
                        <div class="scanner-metric" id="s2SpikeBox" style="margin-top:4px">
                            <div class="value" id="s2Spike">-</div>
                            <div class="label">Cold Spike Rate %</div>
                        </div>
                        <div class="health-bar"><div class="health-fill" id="s2HealthFill" style="width:0%"></div></div>
                        <div style="text-align:center;font-size:10px;font-weight:600" id="s2HealthText">-</div>
                    </div>
                </div>
                
                <div class="verdict scouting" id="marketVerdict">üîç Click SCOUT to analyze market</div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-top:8px">
                    <button class="btn-purple" onclick="startScout()">üîç Scout</button>
                    <button class="btn-green" onclick="startTrading()" id="startTradingBtn" disabled>‚ñ∂ Trade</button>
                    <button class="btn-red" onclick="stopTrading()">‚èπ Stop</button>
                </div>
            </div>
            
            <!-- Digit Grid -->
            <div class="card highlight">
                <h3>üî¢ Digit Frequency <span id="tickCount" style="float:right;color:var(--cyan)">0 ticks</span></h3>
                <div style="display:flex;justify-content:center;align-items:center;gap:15px;margin-bottom:6px;padding:8px;background:var(--bg);border-radius:6px">
                    <div style="text-align:center">
                        <span style="font-size:8px;color:var(--muted)">PRICE</span>
                        <div id="priceDisplay" style="font-size:14px;font-weight:600;font-family:monospace">-.-----</div>
                    </div>
                    <div style="text-align:center">
                        <span style="font-size:8px;color:var(--muted)">LAST DIGIT</span>
                        <div id="lastDigitDisplay" style="font-size:36px;font-weight:700;color:var(--yellow);text-shadow:0 0 15px var(--yellow);line-height:1">-</div>
                    </div>
                    <div style="text-align:center">
                        <span style="font-size:8px;color:var(--muted)">BALANCE</span>
                        <div id="balanceDisplay" style="font-size:14px;font-weight:700;color:var(--green);font-family:monospace">$0.00</div>
                    </div>
                </div>
                <div class="digit-grid" id="digitGrid"></div>
            </div>
            
            <!-- Trading Status -->
            <div class="card" id="tradingStatusCard" style="display:none">
                <h3 id="tradingStatusTitle">üìà TRADING ACTIVE</h3>
                <div class="stats-grid">
                    <div class="stat"><div class="stat-val" id="sessionTrades">0</div><div class="stat-label">Trades</div></div>
                    <div class="stat"><div class="stat-val" id="sessionWins">0</div><div class="stat-label">Wins</div></div>
                    <div class="stat"><div class="stat-val" id="sessionStreak">0</div><div class="stat-label">Streak</div></div>
                    <div class="stat"><div class="stat-val pos" id="sessionPL">$0</div><div class="stat-label">P/L</div></div>
                </div>
                <div style="font-size:9px;text-align:center;margin-top:4px" id="tradingNote"></div>
            </div>
            
            <!-- Real Trades -->
            <div class="card">
                <h3>üí∞ Real Trades <span id="realTradeCount" style="float:right;color:var(--green)">0</span></h3>
                <div class="trades" id="realTrades">
                    <div style="text-align:center;color:var(--muted);padding:15px;font-size:10px">No trades yet</div>
                </div>
            </div>
        </div>
        
        <!-- RIGHT COLUMN -->
        <div>
            <!-- Simulated Trades -->
            <div class="card simulated">
                <h3>üëª SIMULATED TRADES (During Pause)</h3>
                <div style="font-size:8px;color:var(--muted);margin-bottom:4px">Trades that WOULD have happened while paused</div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px">
                    <div style="background:var(--bg);padding:6px;border-radius:4px;text-align:center">
                        <div style="font-size:8px;color:var(--cyan)">S1 Simulated</div>
                        <div style="font-size:11px;font-weight:600" id="s1SimSummary">0W/0L = $0</div>
                    </div>
                    <div style="background:var(--bg);padding:6px;border-radius:4px;text-align:center">
                        <div style="font-size:8px;color:var(--green)">S2 Simulated</div>
                        <div style="font-size:11px;font-weight:600" id="s2SimSummary">0W/0L = $0</div>
                    </div>
                </div>
                
                <div id="scannerImpact" style="text-align:center;padding:8px;background:var(--bg);border-radius:4px;margin-bottom:6px;display:none">
                    <div style="font-size:9px;font-weight:700" id="scannerImpactText">Scanner Impact: $0</div>
                </div>
                
                <div class="sim-trades" id="simTradesList">
                    <div style="text-align:center;color:var(--muted);padding:10px;font-size:9px">No simulated trades</div>
                </div>
            </div>
            
            <!-- Session Data Recorder -->
            <div class="card">
                <h3>üìä SESSION DATA RECORDER</h3>
                <div style="background:var(--bg);padding:8px;border-radius:4px;margin-bottom:6px">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;text-align:center">
                        <div>
                            <div style="font-size:8px;color:var(--muted)">TICKS RECORDED</div>
                            <div style="font-size:16px;font-weight:700;color:var(--cyan)" id="ticksRecorded">0</div>
                        </div>
                        <div>
                            <div style="font-size:8px;color:var(--muted)">DURATION</div>
                            <div style="font-size:16px;font-weight:700;color:var(--cyan)" id="sessionDuration">0:00</div>
                        </div>
                    </div>
                    <div style="text-align:center;margin-top:4px">
                        <div style="font-size:8px;color:var(--muted)">MARKET HEALTHY</div>
                        <div style="font-size:14px;font-weight:600;color:var(--green)" id="healthyPercent">--%</div>
                    </div>
                </div>
                
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px">
                    <button class="btn-cyan" onclick="downloadTickData()">üì• Ticks CSV</button>
                    <button class="btn-orange" onclick="downloadTradeLog()">üì• Trades CSV</button>
                </div>
                <button class="btn-blue" onclick="downloadActivityLog()" style="width:100%;margin-top:4px">üì• Activity Log</button>
            </div>
            
            <!-- Scanner Thresholds -->
            <div class="card">
                <h3>üéöÔ∏è Scanner Thresholds</h3>
                <div style="font-size:8px;color:var(--cyan);margin-bottom:2px">Strategy 1</div>
                <div class="row">
                    <div><label>Max Triple/min</label><input type="number" id="scannerS1TripleMax" value="2.0" step="0.5"></div>
                    <div><label>Max D‚ÜíT %</label><input type="number" id="scannerS1DTMax" value="25"></div>
                </div>
                <div style="font-size:8px;color:var(--green);margin:4px 0 2px">Strategy 2</div>
                <div class="row">
                    <div><label>Min Stability %</label><input type="number" id="scannerS2StabilityMin" value="70"></div>
                    <div><label>Max Spike %</label><input type="number" id="scannerS2SpikeMax" value="20"></div>
                </div>
            </div>
            
            <!-- Total Stats -->
            <div class="card">
                <h3>üìà Session Summary</h3>
                <div class="stats-grid" style="grid-template-columns:1fr 1fr">
                    <div class="stat"><div class="stat-val" id="totalTrades">0</div><div class="stat-label">Trades</div></div>
                    <div class="stat"><div class="stat-val" id="totalWins">0</div><div class="stat-label">Wins</div></div>
                    <div class="stat"><div class="stat-val" id="winRate">0%</div><div class="stat-label">Win Rate</div></div>
                    <div class="stat"><div class="stat-val pos" id="totalPL">$0</div><div class="stat-label">P/L</div></div>
                </div>
                <div style="text-align:center;margin-top:4px">
                    <span style="font-size:9px;color:var(--muted)">Best Streak: </span>
                    <span style="font-size:12px;font-weight:700;color:var(--orange)" id="bestStreak">0</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Init digit grid
const digitGrid = document.getElementById('digitGrid');
for (let i = 0; i < 10; i++) {
    digitGrid.innerHTML += `<div class="digit-box" id="digit-${i}"><div class="digit-num">${i}</div><div class="digit-pct" id="pct-${i}">--%</div></div>`;
}

// STATE
const state = {
    ws: null, connected: false, ticks: [], pendingContracts: new Map(), pipSize: 2,
    isTrading: false, isPaused: false, pauseReason: '',
    lastPriceDigit: null, consecutiveCount: 1,
    currentTradeDigit: null, currentTradeStrategy: null, currentTradeFreq: null,
    
    s1: { phase: 1, tradeCount: 0, cycleResults: [], cyclesCompleted: 0, sessionTrades: 0, sessionWins: 0, sessionPL: 0, currentStreak: 0, cooldownUntil: null, limitReached: false },
    s2: { coldestDigit: null, stableSince: null, isStable: false, lastColdest: null, sessionTrades: 0, sessionWins: 0, sessionPL: 0, currentStreak: 0, waitingConfirm: false, confirmDigit: null, limitReached: false },
    
    scanner: {
        isScoutPhase: false, scoutStartTime: null, scoutDuration: 120000,
        tripleRate: 0, doubleToTripleRate: 0, recentTriples: [], recentDoubles: [],
        coldestStability: 0, coldSpikeRate: 0, coldestHistory: [], coldAppearances: [],
        s1Health: 0, s2Health: 0, s1Healthy: false, s2Healthy: false
    },
    
    simulated: { 
        s1Trades: [], s2Trades: [], 
        s1Summary: { trades: 0, wins: 0, losses: 0, pl: 0 }, 
        s2Summary: { trades: 0, wins: 0, losses: 0, pl: 0 },
        // S1 simulated state (mirrors real S1)
        s1State: { phase: 1, tradeCount: 0, cooldownUntil: null },
        // S2 simulated state (mirrors real S2)
        s2State: { stableSince: null, isStable: false, lastColdest: null, waitingConfirm: false, confirmDigit: null },
        // Pending simulated trades (to check result on next tick)
        pendingS1: null, // { digit, freq, time }
        pendingS2: null  // { digit, freq, time }
    },
    session: { startTime: null, tickLog: [], tradeLog: [], healthyTicks: 0, totalTicks: 0 },
    
    currentStreak: 0, bestStreak: 0, activityLog: [], totalTrades: 0, totalWins: 0, totalPL: 0
};

// HELPERS
function extractDigit(quote, pipSize) { return Math.round(quote * Math.pow(10, pipSize)) % 10; }

function log(msg, type = '') {
    const el = document.getElementById('log');
    const time = new Date().toLocaleTimeString('en-US', { timeZone: 'America/Toronto' });
    state.activityLog.push({ time: new Date().toLocaleString('en-US', { timeZone: 'America/Toronto' }), message: msg, type });
    if (state.activityLog.length > 5000) state.activityLog.shift();
    el.innerHTML = `<div class="${type}">[${time}] ${msg}</div>` + el.innerHTML;
    if (el.children.length > 80) el.removeChild(el.lastChild);
}

function getTimestamp() { return new Date().toLocaleString('en-US', { timeZone: 'America/Toronto' }); }

function updateTorontoTime() {
    const t = new Date().toLocaleString('en-US', { timeZone: 'America/Toronto', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
    document.getElementById('torontoTime').textContent = t + ' EST';
}
setInterval(updateTorontoTime, 1000);

// CONNECTION
function connect() {
    const token = document.getElementById('token').value;
    if (!token) return log('Enter API token', 'loss');
    
    state.ws = new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=1089');
    state.ws.onopen = () => { log('üîå Connected', 'info'); state.ws.send(JSON.stringify({ authorize: token })); };
    
    state.ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);
        if (data.error) return log(`Error: ${data.error.message}`, 'loss');
        
        if (data.authorize) {
            state.connected = true;
            document.getElementById('dot').classList.add('on');
            document.getElementById('status').textContent = 'Online';
            document.getElementById('balance').textContent = '$' + parseFloat(data.authorize.balance).toFixed(2);
            document.getElementById('balanceDisplay').textContent = '$' + parseFloat(data.authorize.balance).toFixed(2);
            log(`‚úÖ Authorized`, 'win');
            state.ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
            subscribeTicks();
        }
        if (data.balance) {
            document.getElementById('balance').textContent = '$' + parseFloat(data.balance.balance).toFixed(2);
            document.getElementById('balanceDisplay').textContent = '$' + parseFloat(data.balance.balance).toFixed(2);
        }
        if (data.tick) processTick(data.tick);
        if (data.buy) {
            state.pendingContracts.set(data.buy.contract_id, { digit: state.currentTradeDigit, stake: parseFloat(document.getElementById('stake').value), strategy: state.currentTradeStrategy, freq: state.currentTradeFreq });
            state.ws.send(JSON.stringify({ proposal_open_contract: 1, contract_id: data.buy.contract_id, subscribe: 1 }));
        }
        if (data.proposal_open_contract?.status === 'won' || data.proposal_open_contract?.status === 'lost') processTradeResult(data.proposal_open_contract);
    };
    
    state.ws.onclose = () => { state.connected = false; document.getElementById('dot').classList.remove('on'); document.getElementById('status').textContent = 'Offline'; log('Disconnected', 'loss'); };
}

function subscribeTicks() {
    const symbol = document.getElementById('symbol').value;
    state.ws.send(JSON.stringify({ ticks: symbol, subscribe: 1 }));
    log(`üìä Subscribed to ${symbol}`, 'info');
}

function changePair() {
    if (state.connected) { state.ws.send(JSON.stringify({ forget_all: 'ticks' })); state.ticks = []; subscribeTicks(); }
}

// TICK PROCESSING
function processTick(tick) {
    const price = tick.quote;
    const digit = extractDigit(price, state.pipSize);
    const ticksToAnalyze = parseInt(document.getElementById('ticksToAnalyze').value) || 100;
    
    state.ticks.push({ price, digit, time: Date.now() });
    if (state.ticks.length > ticksToAnalyze + 50) state.ticks.shift();
    
    document.getElementById('priceDisplay').textContent = price.toFixed(5);
    document.getElementById('lastDigitDisplay').textContent = digit;
    document.getElementById('tickCount').textContent = Math.min(state.ticks.length, ticksToAnalyze) + ' ticks';
    
    const isDouble = (digit === state.lastPriceDigit);
    state.consecutiveCount = isDouble ? state.consecutiveCount + 1 : 1;
    const isTriple = (state.consecutiveCount === 3);
    
    updateDigitDisplay(digit, isDouble, isTriple);
    
    const recent = state.ticks.slice(-ticksToAnalyze);
    if (recent.length >= ticksToAnalyze) {
        const counts = [0,0,0,0,0,0,0,0,0,0];
        recent.forEach(t => counts[t.digit]++);
        const freqs = counts.map(c => (c / ticksToAnalyze) * 100);
        updateDigitFrequencies(freqs);
        recordTick(price, digit, freqs, isDouble, isTriple);
        updateScannerMetrics(digit, freqs, isDouble, isTriple);
        
        if (state.isTrading && !state.isPaused) processTrading(digit, freqs, isDouble, isTriple);
        else if (state.isPaused) processSimulatedTrading(digit, freqs, isDouble, isTriple);
    }
    
    state.lastPriceDigit = digit;
}

function updateDigitDisplay(currentDigit, isDouble, isTriple) {
    for (let i = 0; i < 10; i++) document.getElementById(`digit-${i}`).classList.remove('just-occurred', 'doubled', 'tripled', 'coldest');
    const box = document.getElementById(`digit-${currentDigit}`);
    box.classList.add(isTriple ? 'tripled' : (isDouble ? 'doubled' : 'just-occurred'));
}

function updateDigitFrequencies(freqs) {
    const minFreq = Math.min(...freqs);
    for (let i = 0; i < 10; i++) {
        const pctEl = document.getElementById(`pct-${i}`);
        pctEl.textContent = freqs[i].toFixed(1) + '%';
        pctEl.className = 'digit-pct' + (freqs[i] === minFreq ? ' cold' : '');
        if (freqs[i] === minFreq) document.getElementById(`digit-${i}`).classList.add('coldest');
    }
}

function recordTick(price, digit, freqs, isDouble, isTriple) {
    if (!state.session.startTime) state.session.startTime = Date.now();
    state.session.totalTicks++;
    if (state.scanner.s1Healthy || state.scanner.s2Healthy) state.session.healthyTicks++;
    
    state.session.tickLog.push({
        timestamp: getTimestamp(), price, digit,
        freq_0: freqs[0].toFixed(1), freq_1: freqs[1].toFixed(1), freq_2: freqs[2].toFixed(1), freq_3: freqs[3].toFixed(1), freq_4: freqs[4].toFixed(1),
        freq_5: freqs[5].toFixed(1), freq_6: freqs[6].toFixed(1), freq_7: freqs[7].toFixed(1), freq_8: freqs[8].toFixed(1), freq_9: freqs[9].toFixed(1),
        coldest: freqs.indexOf(Math.min(...freqs)), coldest_freq: Math.min(...freqs).toFixed(1),
        is_double: isDouble ? 'Yes' : 'No', is_triple: isTriple ? 'Yes' : 'No',
        s1_health: state.scanner.s1Health, s2_health: state.scanner.s2Health,
        market_status: state.isPaused ? 'PAUSED' : (state.isTrading ? 'TRADING' : 'IDLE')
    });
    
    if (state.session.tickLog.length > 50000) state.session.tickLog = state.session.tickLog.slice(-40000);
    document.getElementById('ticksRecorded').textContent = state.session.tickLog.length;
    
    if (state.session.startTime) {
        const d = Math.floor((Date.now() - state.session.startTime) / 1000);
        document.getElementById('sessionDuration').textContent = `${Math.floor(d/60)}:${(d%60).toString().padStart(2,'0')}`;
    }
    if (state.session.totalTicks > 0) document.getElementById('healthyPercent').textContent = (state.session.healthyTicks / state.session.totalTicks * 100).toFixed(1) + '%';
}

// SCANNER
function updateScannerMetrics(digit, freqs, isDouble, isTriple) {
    const now = Date.now(), twoMinAgo = now - 120000;
    
    if (isTriple) state.scanner.recentTriples.push(now);
    state.scanner.recentTriples = state.scanner.recentTriples.filter(t => t > twoMinAgo);
    
    if (isDouble && state.consecutiveCount === 2) state.scanner.recentDoubles.push({ time: now, digit, becameTriple: false });
    if (isTriple) { const d = state.scanner.recentDoubles.find(d => d.digit === digit && !d.becameTriple); if (d) d.becameTriple = true; }
    state.scanner.recentDoubles = state.scanner.recentDoubles.filter(d => d.time > twoMinAgo);
    
    const minutes = Math.max(0.5, Math.min(2, (now - (state.session.startTime || now)) / 60000));
    state.scanner.tripleRate = state.scanner.recentTriples.length / minutes;
    const dc = state.scanner.recentDoubles.length, tc = state.scanner.recentDoubles.filter(d => d.becameTriple).length;
    state.scanner.doubleToTripleRate = dc > 0 ? (tc / dc * 100) : 0;
    
    const coldest = freqs.indexOf(Math.min(...freqs));
    state.scanner.coldestHistory.push(coldest);
    if (state.scanner.coldestHistory.length > 20) state.scanner.coldestHistory.shift();
    
    if (state.scanner.coldestHistory.length >= 2) {
        let stable = 0;
        for (let i = 1; i < state.scanner.coldestHistory.length; i++) if (state.scanner.coldestHistory[i] === state.scanner.coldestHistory[i-1]) stable++;
        state.scanner.coldestStability = (stable / (state.scanner.coldestHistory.length - 1)) * 100;
    }
    
    const coldThreshold = parseFloat(document.getElementById('strat2Threshold').value) || 6;
    if (freqs[digit] <= coldThreshold) state.scanner.coldAppearances.push({ time: now, digit, spiked: false });
    const rc = state.scanner.coldAppearances.slice(-10);
    for (let i = 0; i < rc.length - 1; i++) for (let j = i + 1; j < rc.length; j++) if (rc[i].digit === rc[j].digit && !rc[i].spiked) rc[i].spiked = true;
    state.scanner.coldAppearances = state.scanner.coldAppearances.filter(c => c.time > twoMinAgo);
    const cc = state.scanner.coldAppearances.length, sc = state.scanner.coldAppearances.filter(c => c.spiked).length;
    state.scanner.coldSpikeRate = cc > 0 ? (sc / cc * 100) : 0;
    
    calculateHealthScores();
    updateScannerUI();
    if (state.isTrading) checkMarketHealth();
}

function calculateHealthScores() {
    const s1tm = parseFloat(document.getElementById('scannerS1TripleMax').value) || 2, s1dm = parseFloat(document.getElementById('scannerS1DTMax').value) || 25;
    const s2sm = parseFloat(document.getElementById('scannerS2StabilityMin').value) || 70, s2pm = parseFloat(document.getElementById('scannerS2SpikeMax').value) || 20;
    
    state.scanner.s1Health = Math.round((Math.max(0, 100 - state.scanner.tripleRate / s1tm * 50) + Math.max(0, 100 - state.scanner.doubleToTripleRate / s1dm * 50)) / 2);
    state.scanner.s1Healthy = state.scanner.tripleRate <= s1tm && state.scanner.doubleToTripleRate <= s1dm;
    
    state.scanner.s2Health = Math.round((Math.min(100, state.scanner.coldestStability / s2sm * 100) + Math.max(0, 100 - state.scanner.coldSpikeRate / s2pm * 50)) / 2);
    state.scanner.s2Healthy = state.scanner.coldestStability >= s2sm && state.scanner.coldSpikeRate <= s2pm;
}

function updateScannerUI() {
    document.getElementById('s1TripleRate').textContent = state.scanner.tripleRate.toFixed(1);
    document.getElementById('s1DoubleTriple').textContent = state.scanner.doubleToTripleRate.toFixed(0) + '%';
    document.getElementById('s2Stability').textContent = state.scanner.coldestStability.toFixed(0) + '%';
    document.getElementById('s2Spike').textContent = state.scanner.coldSpikeRate.toFixed(0) + '%';
    
    const s1tm = parseFloat(document.getElementById('scannerS1TripleMax').value) || 2, s1dm = parseFloat(document.getElementById('scannerS1DTMax').value) || 25;
    const s2sm = parseFloat(document.getElementById('scannerS2StabilityMin').value) || 70, s2pm = parseFloat(document.getElementById('scannerS2SpikeMax').value) || 20;
    
    setMetricClass('s1TripleRateBox', state.scanner.tripleRate <= s1tm * 0.7 ? 'good' : (state.scanner.tripleRate <= s1tm ? 'caution' : 'bad'));
    setMetricClass('s1DoubleTripleBox', state.scanner.doubleToTripleRate <= s1dm * 0.7 ? 'good' : (state.scanner.doubleToTripleRate <= s1dm ? 'caution' : 'bad'));
    setMetricClass('s2StabilityBox', state.scanner.coldestStability >= s2sm ? 'good' : (state.scanner.coldestStability >= s2sm * 0.7 ? 'caution' : 'bad'));
    setMetricClass('s2SpikeBox', state.scanner.coldSpikeRate <= s2pm * 0.7 ? 'good' : (state.scanner.coldSpikeRate <= s2pm ? 'caution' : 'bad'));
    
    document.getElementById('s1HealthFill').style.width = state.scanner.s1Health + '%';
    document.getElementById('s1HealthFill').className = 'health-fill ' + (state.scanner.s1Healthy ? 'good' : (state.scanner.s1Health >= 50 ? 'caution' : 'bad'));
    document.getElementById('s1HealthText').textContent = state.scanner.s1Health + '% ' + (state.scanner.s1Healthy ? '‚úÖ' : '‚ùå');
    document.getElementById('s1HealthText').style.color = state.scanner.s1Healthy ? 'var(--green)' : 'var(--red)';
    
    document.getElementById('s2HealthFill').style.width = state.scanner.s2Health + '%';
    document.getElementById('s2HealthFill').className = 'health-fill ' + (state.scanner.s2Healthy ? 'good' : (state.scanner.s2Health >= 50 ? 'caution' : 'bad'));
    document.getElementById('s2HealthText').textContent = state.scanner.s2Health + '% ' + (state.scanner.s2Healthy ? '‚úÖ' : '‚ùå');
    document.getElementById('s2HealthText').style.color = state.scanner.s2Healthy ? 'var(--green)' : 'var(--red)';
    
    if (!state.scanner.isScoutPhase && state.isTrading) updateMarketVerdict();
}

function setMetricClass(id, cls) { const el = document.getElementById(id); el.classList.remove('good', 'caution', 'bad'); el.classList.add(cls); }

function updateMarketVerdict() {
    const v = document.getElementById('marketVerdict');
    if (state.isPaused) { v.className = 'verdict bad'; v.innerHTML = `‚è∏Ô∏è PAUSED - ${state.pauseReason}<br><span style="font-size:10px">Simulating trades...</span>`; }
    else { v.className = 'verdict good'; v.innerHTML = '‚úÖ TRADING ACTIVE'; }
}

function checkMarketHealth() {
    const s1e = document.getElementById('strat1Enabled').checked, s2e = document.getElementById('strat2Enabled').checked;
    const s1m = document.querySelector('input[name="s1EntryMode"]:checked').value, s2m = document.querySelector('input[name="s2EntryMode"]:checked').value;
    const s1ns = s1m === 'scanner' || s1m === 'both', s2ns = s2m === 'scanner' || s2m === 'both';
    
    let shouldPause = false, reason = '';
    if (s1e && s1ns && !state.scanner.s1Healthy && !state.s1.limitReached) { shouldPause = true; reason = 'S1 unhealthy'; }
    if (s2e && s2ns && !state.scanner.s2Healthy && !state.s2.limitReached) { reason = shouldPause ? 'S1 & S2 unhealthy' : 'S2 unhealthy'; shouldPause = true; }
    
    if ((!s1e || state.s1.limitReached) && (!s2e || state.s2.limitReached)) { stopTrading(); log('üéØ All limits reached!', 'win'); return; }
    
    if (shouldPause && !state.isPaused) { state.isPaused = true; state.pauseReason = reason; log(`‚è∏Ô∏è PAUSED: ${reason}`, 'scanner'); document.getElementById('tradingStatusCard').classList.add('paused'); document.getElementById('tradingStatusTitle').textContent = '‚è∏Ô∏è PAUSED'; }
    else if (!shouldPause && state.isPaused) { state.isPaused = false; state.pauseReason = ''; log('‚ñ∂Ô∏è RESUMED', 'scanner'); document.getElementById('tradingStatusCard').classList.remove('paused'); document.getElementById('tradingStatusTitle').textContent = 'üìà TRADING'; }
    
    updateMarketVerdict();
}

// SCOUT
function startScout() {
    if (!state.connected) return log('Connect first!', 'loss');
    const ticks = parseInt(document.getElementById('ticksToAnalyze').value) || 100;
    if (state.ticks.length < ticks) return log(`Need ${ticks} ticks first`, 'loss');
    
    state.scanner.isScoutPhase = true; state.scanner.scoutStartTime = Date.now();
    state.scanner.recentTriples = []; state.scanner.recentDoubles = []; state.scanner.coldestHistory = []; state.scanner.coldAppearances = [];
    
    document.getElementById('scoutProgress').style.display = 'block';
    document.getElementById('scannerStatus').textContent = 'SCOUTING...';
    document.getElementById('marketVerdict').className = 'verdict scouting';
    document.getElementById('marketVerdict').innerHTML = 'üîç Analyzing market...';
    log('üîç Scout started', 'scanner');
    updateScoutProgress();
}

function updateScoutProgress() {
    if (!state.scanner.isScoutPhase) return;
    const elapsed = Date.now() - state.scanner.scoutStartTime, pct = Math.min(100, elapsed / state.scanner.scoutDuration * 100);
    document.getElementById('scoutFill').style.width = pct + '%';
    const s = Math.floor(elapsed / 1000);
    document.getElementById('scoutTime').textContent = `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
    if (elapsed >= state.scanner.scoutDuration) finishScout(); else setTimeout(updateScoutProgress, 500);
}

function finishScout() {
    state.scanner.isScoutPhase = false;
    document.getElementById('scoutProgress').style.display = 'none';
    document.getElementById('scannerStatus').textContent = 'READY';
    
    let cls = 'good', txt = '‚úÖ MARKET HEALTHY';
    if (!state.scanner.s1Healthy && !state.scanner.s2Healthy) { cls = 'bad'; txt = '‚ùå MARKET UNHEALTHY'; }
    else if (!state.scanner.s1Healthy || !state.scanner.s2Healthy) { cls = 'caution'; txt = 'üü° PARTIAL - ' + (state.scanner.s1Healthy ? 'S1 OK' : 'S2 OK'); }
    
    document.getElementById('marketVerdict').className = 'verdict ' + cls;
    document.getElementById('marketVerdict').innerHTML = txt;
    document.getElementById('startTradingBtn').disabled = false;
    log(`üîç Scout done: S1=${state.scanner.s1Health}% S2=${state.scanner.s2Health}%`, 'scanner');
}

// TRADING
function startTrading() {
    if (!state.connected) return log('Connect first!', 'loss');
    if (!document.getElementById('strat1Enabled').checked && !document.getElementById('strat2Enabled').checked) return log('Enable a strategy!', 'loss');
    
    state.isTrading = true; state.isPaused = false; state.pauseReason = '';
    state.s1 = { phase: 1, tradeCount: 0, cycleResults: [], cyclesCompleted: 0, sessionTrades: 0, sessionWins: 0, sessionPL: 0, currentStreak: 0, cooldownUntil: null, limitReached: false };
    state.s2 = { coldestDigit: null, stableSince: null, isStable: false, lastColdest: null, sessionTrades: 0, sessionWins: 0, sessionPL: 0, currentStreak: 0, waitingConfirm: false, confirmDigit: null, limitReached: false };
    state.simulated = { 
        s1Trades: [], s2Trades: [], 
        s1Summary: { trades: 0, wins: 0, losses: 0, pl: 0 }, 
        s2Summary: { trades: 0, wins: 0, losses: 0, pl: 0 },
        s1State: { phase: 1, tradeCount: 0, cooldownUntil: null },
        s2State: { stableSince: null, isStable: false, lastColdest: null, waitingConfirm: false, confirmDigit: null },
        pendingS1: null,
        pendingS2: null
    };
    updateSimulatedUI();
    state.session.startTime = Date.now(); state.session.healthyTicks = 0; state.session.totalTicks = 0;
    
    document.getElementById('tradingStatusCard').style.display = 'block';
    document.getElementById('tradingStatusTitle').textContent = 'üìà TRADING';
    document.getElementById('scannerStatus').textContent = 'LIVE';
    log('‚ñ∂Ô∏è Trading started', 'trade');
    updateTradingStatus(); updateMarketVerdict();
}

function stopTrading() {
    state.isTrading = false; state.isPaused = false;
    document.getElementById('tradingStatusCard').style.display = 'none';
    document.getElementById('scannerStatus').textContent = 'STOPPED';
    document.getElementById('marketVerdict').className = 'verdict scouting';
    document.getElementById('marketVerdict').innerHTML = '‚èπ Stopped - Scout to restart';
    log('‚èπ Stopped', 'info');
}

function updateTradingStatus() {
    let t = 0, w = 0, pl = 0, s = 0;
    if (document.getElementById('strat1Enabled').checked) { t += state.s1.sessionTrades; w += state.s1.sessionWins; pl += state.s1.sessionPL; s = Math.max(s, state.s1.currentStreak); }
    if (document.getElementById('strat2Enabled').checked) { t += state.s2.sessionTrades; w += state.s2.sessionWins; pl += state.s2.sessionPL; s = Math.max(s, state.s2.currentStreak); }
    
    document.getElementById('sessionTrades').textContent = t;
    document.getElementById('sessionWins').textContent = w;
    document.getElementById('sessionStreak').textContent = s;
    document.getElementById('sessionPL').textContent = '$' + pl.toFixed(2);
    document.getElementById('sessionPL').className = 'stat-val ' + (pl >= 0 ? 'pos' : 'neg');
    
    let notes = [];
    if (state.s1.limitReached) notes.push('S1: limit');
    if (state.s2.limitReached) notes.push('S2: limit');
    document.getElementById('tradingNote').textContent = notes.join(' | ');
}

function processTrading(digit, freqs, isDouble, isTriple) {
    if (document.getElementById('strat1Enabled').checked && !state.s1.limitReached) processS1(digit, freqs, isDouble, isTriple);
    if (document.getElementById('strat2Enabled').checked && !state.s2.limitReached) processS2(digit, freqs);
}

function processS1(digit, freqs, isDouble, isTriple) {
    const mode = document.querySelector('input[name="s1EntryMode"]:checked').value;
    const tt = parseFloat(document.getElementById('tripleThreshold').value) || 7;
    const dt = parseFloat(document.getElementById('doubleColdThreshold').value) || 8;
    const tpc = parseInt(document.getElementById('tradesPerCycle').value) || 3;
    const cd = parseInt(document.getElementById('tripleCooldown').value) || 5;
    
    if ((mode === 'scanner' || mode === 'both') && !state.scanner.s1Healthy) return;
    
    if (mode !== 'scanner' && state.s1.phase === 1) {
        if (isTriple && freqs[digit] <= tt) { state.s1.phase = 2; state.s1.tradeCount = 0; log(`üìç S1: Cold triple ‚Üí Phase 2`, 'trade'); }
        return;
    }
    if (mode === 'scanner' && state.s1.phase === 1) state.s1.phase = 2;
    
    if (state.s1.phase === 2) {
        if (isTriple) { state.s1.cooldownUntil = Date.now() + cd * 1000; log(`‚è∏Ô∏è S1: Cooldown ${cd}s`, 'alert'); return; }
        if (state.s1.cooldownUntil && Date.now() < state.s1.cooldownUntil) return;
        
        if (isDouble && freqs[digit] <= dt && state.s1.tradeCount < tpc) {
            log(`üîî S1: D${digit} (${freqs[digit].toFixed(1)}%)`, 'trade');
            placeTrade(digit, freqs[digit], 'S1');
            state.s1.tradeCount++;
        }
        
        if (state.s1.tradeCount >= tpc) {
            if (mode === 'scanner') state.s1.tradeCount = 0;
            else { state.s1.phase = 1; state.s1.tradeCount = 0; state.s1.cyclesCompleted++; log('‚úÖ S1: Cycle done', 'info'); }
        }
    }
}

function processS2(digit, freqs) {
    const mode = document.querySelector('input[name="s2EntryMode"]:checked').value;
    const ct = parseFloat(document.getElementById('strat2Threshold').value) || 6;
    const ss = parseFloat(document.getElementById('strat2Stability').value) || 3;
    
    if ((mode === 'scanner' || mode === 'both') && !state.scanner.s2Healthy) return;
    
    const coldest = freqs.indexOf(Math.min(...freqs)), coldFreq = freqs[coldest];
    if (coldFreq > ct) { state.s2.stableSince = null; state.s2.isStable = false; state.s2.waitingConfirm = false; return; }
    
    if (coldest !== state.s2.lastColdest) { state.s2.stableSince = Date.now(); state.s2.isStable = false; }
    else if (state.s2.stableSince) state.s2.isStable = (Date.now() - state.s2.stableSince) / 1000 >= ss;
    state.s2.lastColdest = coldest;
    
    if (state.s2.waitingConfirm) {
        if (digit !== state.s2.confirmDigit) { log(`üîî S2: Confirmed D${state.s2.confirmDigit}`, 'trade'); placeTrade(state.s2.confirmDigit, freqs[state.s2.confirmDigit], 'S2'); }
        else log(`‚ö†Ô∏è S2: D${digit} doubled, cancel`, 'alert');
        state.s2.waitingConfirm = false; state.s2.confirmDigit = null;
        return;
    }
    
    if (state.s2.isStable && digit === coldest) { state.s2.waitingConfirm = true; state.s2.confirmDigit = coldest; log(`üëÜ S2: Tap D${coldest}`, 'info'); }
}

// SIMULATED - Mirrors exact S1 and S2 logic
function processSimulatedTrading(digit, freqs, isDouble, isTriple) {
    const stake = parseFloat(document.getElementById('stake').value) || 10;
    const PAYOUT_RATE = 0.09649; // 9.649% profit on win
    
    // First, check for pending simulated trades from previous tick
    resolvePendingSimulatedTrades(digit, stake, PAYOUT_RATE);
    
    // Then process new simulated trades
    if (document.getElementById('strat1Enabled').checked && !state.s1.limitReached) {
        processSimulatedS1(digit, freqs, isDouble, isTriple);
    }
    
    if (document.getElementById('strat2Enabled').checked && !state.s2.limitReached) {
        processSimulatedS2(digit, freqs);
    }
    
    updateSimulatedUI();
}

function resolvePendingSimulatedTrades(currentDigit, stake, PAYOUT_RATE) {
    // Resolve S1 pending trade
    if (state.simulated.pendingS1) {
        const pending = state.simulated.pendingS1;
        const won = currentDigit !== pending.digit; // DIFFERS wins if different
        const profit = won ? stake * PAYOUT_RATE : -stake;
        
        state.simulated.s1Trades.push({
            time: pending.time,
            strategy: 'S1',
            digit: pending.digit,
            freq: pending.freq,
            result: won ? 'WIN' : 'LOSS',
            profit: profit
        });
        
        state.simulated.s1Summary.trades++;
        if (won) state.simulated.s1Summary.wins++;
        else state.simulated.s1Summary.losses++;
        state.simulated.s1Summary.pl += profit;
        
        log(`üëª S1 Sim: D${pending.digit} ‚Üí ${won ? 'WIN' : 'LOSS'} ($${profit.toFixed(2)})`, 'scanner');
        state.simulated.pendingS1 = null;
    }
    
    // Resolve S2 pending trade
    if (state.simulated.pendingS2) {
        const pending = state.simulated.pendingS2;
        const won = currentDigit !== pending.digit; // DIFFERS wins if different
        const profit = won ? stake * PAYOUT_RATE : -stake;
        
        state.simulated.s2Trades.push({
            time: pending.time,
            strategy: 'S2',
            digit: pending.digit,
            freq: pending.freq,
            result: won ? 'WIN' : 'LOSS',
            profit: profit
        });
        
        state.simulated.s2Summary.trades++;
        if (won) state.simulated.s2Summary.wins++;
        else state.simulated.s2Summary.losses++;
        state.simulated.s2Summary.pl += profit;
        
        log(`üëª S2 Sim: D${pending.digit} ‚Üí ${won ? 'WIN' : 'LOSS'} ($${profit.toFixed(2)})`, 'scanner');
        state.simulated.pendingS2 = null;
    }
}

function processSimulatedS1(digit, freqs, isDouble, isTriple) {
    const mode = document.querySelector('input[name="s1EntryMode"]:checked').value;
    const tt = parseFloat(document.getElementById('tripleThreshold').value) || 7;
    const dt = parseFloat(document.getElementById('doubleColdThreshold').value) || 8;
    const tpc = parseInt(document.getElementById('tradesPerCycle').value) || 3;
    const cd = parseInt(document.getElementById('tripleCooldown').value) || 5;
    
    const simState = state.simulated.s1State;
    
    // Phase 1: Wait for cold triple (unless scanner-only mode)
    if (mode !== 'scanner' && simState.phase === 1) {
        if (isTriple && freqs[digit] <= tt) {
            simState.phase = 2;
            simState.tradeCount = 0;
            log(`üëª S1 Sim: Cold triple ‚Üí Phase 2`, 'scanner');
        }
        return;
    }
    
    // Scanner mode starts in Phase 2
    if (mode === 'scanner' && simState.phase === 1) {
        simState.phase = 2;
    }
    
    // Phase 2: Trade on cold doubles
    if (simState.phase === 2) {
        // Triple triggers cooldown
        if (isTriple) {
            simState.cooldownUntil = Date.now() + cd * 1000;
            log(`üëª S1 Sim: Triple! Cooldown ${cd}s`, 'scanner');
            return;
        }
        
        // Check cooldown
        if (simState.cooldownUntil && Date.now() < simState.cooldownUntil) {
            return;
        }
        
        // Trade on cold double
        if (isDouble && freqs[digit] <= dt && simState.tradeCount < tpc && !state.simulated.pendingS1) {
            log(`üëª S1 Sim: Placing on D${digit} (${freqs[digit].toFixed(1)}%)`, 'scanner');
            state.simulated.pendingS1 = {
                digit: digit,
                freq: freqs[digit].toFixed(1),
                time: getTimestamp()
            };
            simState.tradeCount++;
        }
        
        // Check cycle complete
        if (simState.tradeCount >= tpc) {
            if (mode === 'scanner') {
                simState.tradeCount = 0;
            } else {
                simState.phase = 1;
                simState.tradeCount = 0;
                log(`üëª S1 Sim: Cycle complete`, 'scanner');
            }
        }
    }
}

function processSimulatedS2(digit, freqs) {
    const mode = document.querySelector('input[name="s2EntryMode"]:checked').value;
    const ct = parseFloat(document.getElementById('strat2Threshold').value) || 6;
    const ss = parseFloat(document.getElementById('strat2Stability').value) || 3;
    
    const simState = state.simulated.s2State;
    
    const coldest = freqs.indexOf(Math.min(...freqs));
    const coldFreq = freqs[coldest];
    
    // Reset if not cold enough
    if (coldFreq > ct) {
        simState.stableSince = null;
        simState.isStable = false;
        simState.waitingConfirm = false;
        return;
    }
    
    // Track stability
    if (coldest !== simState.lastColdest) {
        simState.stableSince = Date.now();
        simState.isStable = false;
    } else if (simState.stableSince) {
        simState.isStable = (Date.now() - simState.stableSince) / 1000 >= ss;
    }
    simState.lastColdest = coldest;
    
    // Waiting for confirmation
    if (simState.waitingConfirm) {
        if (digit !== simState.confirmDigit) {
            // Different digit - place trade!
            if (!state.simulated.pendingS2) {
                log(`üëª S2 Sim: Confirmed! Placing on D${simState.confirmDigit}`, 'scanner');
                state.simulated.pendingS2 = {
                    digit: simState.confirmDigit,
                    freq: freqs[simState.confirmDigit].toFixed(1),
                    time: getTimestamp()
                };
            }
        } else {
            // Same digit doubled - cancel
            log(`üëª S2 Sim: D${digit} doubled, cancel`, 'scanner');
        }
        simState.waitingConfirm = false;
        simState.confirmDigit = null;
        return;
    }
    
    // Check for tap (stable coldest digit appears)
    if (simState.isStable && digit === coldest && !state.simulated.pendingS2) {
        simState.waitingConfirm = true;
        simState.confirmDigit = coldest;
        log(`üëª S2 Sim: Tap on D${coldest} - waiting confirm`, 'scanner');
    }
}

function updateSimulatedUI() {
    const s1 = state.simulated.s1Summary;
    const s2 = state.simulated.s2Summary;
    
    document.getElementById('s1SimSummary').textContent = `${s1.wins}W/${s1.losses}L = $${s1.pl.toFixed(2)}`;
    document.getElementById('s1SimSummary').style.color = s1.pl >= 0 ? 'var(--green)' : 'var(--red)';
    document.getElementById('s2SimSummary').textContent = `${s2.wins}W/${s2.losses}L = $${s2.pl.toFixed(2)}`;
    document.getElementById('s2SimSummary').style.color = s2.pl >= 0 ? 'var(--green)' : 'var(--red)';
    
    // Calculate scanner impact (negative simulated P/L = saved money, positive = cost money)
    const totalSimPL = s1.pl + s2.pl;
    const totalSimTrades = s1.trades + s2.trades;
    const impactEl = document.getElementById('scannerImpact');
    const impactTextEl = document.getElementById('scannerImpactText');
    
    if (totalSimTrades > 0) {
        impactEl.style.display = 'block';
        if (totalSimPL < 0) {
            // Negative sim P/L = scanner SAVED you money
            impactTextEl.textContent = `‚úÖ Scanner SAVED you $${Math.abs(totalSimPL).toFixed(2)}`;
            impactTextEl.style.color = 'var(--green)';
        } else {
            // Positive sim P/L = scanner COST you money (missed profits)
            impactTextEl.textContent = `‚ö†Ô∏è Scanner cost you $${totalSimPL.toFixed(2)} in missed profits`;
            impactTextEl.style.color = 'var(--yellow)';
        }
    } else {
        impactEl.style.display = 'none';
    }
    
    const all = [...state.simulated.s1Trades, ...state.simulated.s2Trades].slice(-20).reverse();
    document.getElementById('simTradesList').innerHTML = all.length ? all.map(t => `<div class="sim-trade ${t.result.toLowerCase()}"><span>${t.strategy}|D${t.digit} (${t.freq}%)</span><span>${t.result} ${t.profit >= 0 ? '+' : ''}$${t.profit.toFixed(2)}</span></div>`).join('') : '<div style="text-align:center;color:var(--muted);padding:10px;font-size:9px">No simulated trades</div>';
}

// TRADE EXECUTION
function placeTrade(digit, freq, strategy) {
    const stake = parseFloat(document.getElementById('stake').value) || 10;
    state.currentTradeDigit = digit; state.currentTradeStrategy = strategy; state.currentTradeFreq = freq;
    
    state.ws.send(JSON.stringify({ buy: 1, price: stake, parameters: { amount: stake, basis: 'stake', contract_type: 'DIGITDIFF', currency: 'USD', duration: 1, duration_unit: 't', symbol: document.getElementById('symbol').value, barrier: digit.toString() } }));
    log(`üì§ ${strategy}: DIFFERS D${digit} @ $${stake}`, 'trade');
}

function processTradeResult(contract) {
    const info = state.pendingContracts.get(contract.contract_id);
    if (!info) return;
    state.pendingContracts.delete(contract.contract_id);
    
    const won = contract.status === 'won', profit = parseFloat(contract.profit) || (won ? info.stake * 0.9649 : -info.stake);
    
    if (info.strategy === 'S1') {
        state.s1.sessionTrades++; if (won) { state.s1.sessionWins++; state.s1.currentStreak++; } else { state.s1.currentStreak = 0; if (document.getElementById('s1StopOnLoss').checked) { state.s1.limitReached = true; log('üõë S1: Stop on loss', 'loss'); } }
        state.s1.sessionPL += profit;
        const wt = parseInt(document.getElementById('s1WinTarget').value) || 0; if (wt > 0 && state.s1.currentStreak >= wt) { state.s1.limitReached = true; log(`üéØ S1: Target ${wt}!`, 'win'); }
        const mt = parseInt(document.getElementById('s1MaxTrades').value) || 0; if (mt > 0 && state.s1.sessionTrades >= mt) { state.s1.limitReached = true; log(`üéØ S1: Max ${mt}!`, 'info'); }
    } else {
        state.s2.sessionTrades++; if (won) { state.s2.sessionWins++; state.s2.currentStreak++; } else { state.s2.currentStreak = 0; if (document.getElementById('s2StopOnLoss').checked) { state.s2.limitReached = true; log('üõë S2: Stop on loss', 'loss'); } }
        state.s2.sessionPL += profit;
        const wt = parseInt(document.getElementById('s2WinTarget').value) || 0; if (wt > 0 && state.s2.currentStreak >= wt) { state.s2.limitReached = true; log(`üéØ S2: Target ${wt}!`, 'win'); }
        const mt = parseInt(document.getElementById('s2MaxTrades').value) || 0; if (mt > 0 && state.s2.sessionTrades >= mt) { state.s2.limitReached = true; log(`üéØ S2: Max ${mt}!`, 'info'); }
    }
    
    state.totalTrades++; if (won) state.totalWins++; state.totalPL += profit;
    state.currentStreak = won ? state.currentStreak + 1 : 0; state.bestStreak = Math.max(state.bestStreak, state.currentStreak);
    
    log(`${won ? '‚úÖ' : '‚ùå'} ${info.strategy}: D${info.digit} ${won ? 'WIN' : 'LOSS'} $${profit.toFixed(2)}`, won ? 'win' : 'loss');
    
    state.session.tradeLog.push({ time: getTimestamp(), strategy: info.strategy, digit: info.digit, freq: info.freq, result: won ? 'WIN' : 'LOSS', profit, streak: state.currentStreak });
    
    updateTradingStatus(); updateTotalStats(); updateRealTradesUI(info.digit, info.freq, info.strategy, won, profit); checkMarketHealth();
}

function updateTotalStats() {
    document.getElementById('totalTrades').textContent = state.totalTrades;
    document.getElementById('totalWins').textContent = state.totalWins;
    document.getElementById('winRate').textContent = state.totalTrades ? (state.totalWins / state.totalTrades * 100).toFixed(1) + '%' : '0%';
    document.getElementById('totalPL').textContent = '$' + state.totalPL.toFixed(2);
    document.getElementById('totalPL').className = 'stat-val ' + (state.totalPL >= 0 ? 'pos' : 'neg');
    document.getElementById('bestStreak').textContent = state.bestStreak;
}

function updateRealTradesUI(digit, freq, strategy, won, profit) {
    const c = document.getElementById('realTrades');
    if (state.session.tradeLog.length === 1) c.innerHTML = '';
    c.innerHTML = `<div class="trade-row ${won ? 'win' : 'loss'}"><span>${strategy}|D${digit} (${freq.toFixed(1)}%)</span><span>${won ? 'WIN' : 'LOSS'} $${profit.toFixed(2)}</span></div>` + c.innerHTML;
    document.getElementById('realTradeCount').textContent = state.session.tradeLog.length;
}

// CSV EXPORT
function downloadTickData() {
    if (!state.session.tickLog.length) return log('No data', 'loss');
    const h = Object.keys(state.session.tickLog[0]);
    const csv = [h.join(','), ...state.session.tickLog.map(r => h.map(k => r[k]).join(','))].join('\n');
    download(csv, `ticks_${ts()}.csv`, 'text/csv');
    log(`üì• ${state.session.tickLog.length} ticks`, 'info');
}

function downloadTradeLog() {
    if (!state.session.tradeLog.length) return log('No trades', 'loss');
    const h = Object.keys(state.session.tradeLog[0]);
    const csv = [h.join(','), ...state.session.tradeLog.map(r => h.map(k => r[k]).join(','))].join('\n');
    download(csv, `trades_${ts()}.csv`, 'text/csv');
    log(`üì• ${state.session.tradeLog.length} trades`, 'info');
}

function downloadActivityLog() {
    if (!state.activityLog.length) return log('No log', 'loss');
    const txt = state.activityLog.map(e => `[${e.time}] ${e.message}`).join('\n');
    download(txt, `activity_${ts()}.txt`, 'text/plain');
    log(`üì• ${state.activityLog.length} entries`, 'info');
}

function download(content, filename, type) {
    const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([content], { type })); a.download = filename; a.click();
}

function ts() { return new Date().toISOString().slice(0, 19).replace(/[:-]/g, '').replace('T', '_'); }

log('üéØ DIFFERS Bot v7 loaded', 'info');
log('üìä Connect ‚Üí Scout ‚Üí Trade', 'info');
</script>
</body>
</html>
