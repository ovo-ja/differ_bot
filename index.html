<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Two-Phase DIFFERS Bot</title>
    <style>
        :root{--bg:#0a0e17;--card:#1a2235;--border:#2a3549;--text:#f1f5f9;--muted:#64748b;--green:#10b981;--red:#ef4444;--cyan:#06b6d4;--yellow:#f59e0b;--purple:#a855f7;--orange:#f97316;--blue:#3b82f6}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);padding:10px;font-size:13px}
        .container{max-width:1400px;margin:0 auto}
        .header{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:2px solid var(--cyan);margin-bottom:10px}
        .header h1{font-size:18px;color:var(--cyan)}
        .status{display:flex;align-items:center;gap:8px}
        .dot{width:12px;height:12px;border-radius:50%;background:var(--muted)}
        .dot.on{background:var(--green);box-shadow:0 0 10px var(--green)}
        .balance{font-family:monospace;font-size:16px;color:var(--green)}
        .time{font-size:11px;color:var(--muted)}
        
        .grid{display:grid;grid-template-columns:280px 1fr 280px;gap:10px}
        @media(max-width:1200px){.grid{grid-template-columns:1fr}}
        
        .card{background:var(--card);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:8px}
        .card h3{font-size:10px;color:var(--muted);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px}
        .card.highlight{border:2px solid var(--cyan);background:rgba(6,182,212,0.05)}
        .card.warning{border:2px solid var(--yellow);background:rgba(245,158,11,0.1)}
        
        label{display:block;font-size:10px;color:var(--muted);margin-bottom:2px}
        input,select{width:100%;padding:6px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:12px;margin-bottom:6px}
        .row{display:grid;grid-template-columns:1fr 1fr;gap:6px}
        
        button{padding:8px 12px;border:none;border-radius:6px;font-weight:700;cursor:pointer;font-size:11px;text-transform:uppercase;transition:all 0.2s}
        .btn-blue{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;width:100%}
        .btn-cyan{background:var(--cyan);color:black}
        .btn-green{background:var(--green);color:white}
        .btn-red{background:var(--red);color:white}
        .btn-orange{background:var(--orange);color:white}
        .rapid-opt{flex:1;padding:8px;background:var(--bg);border:2px solid var(--border);color:var(--text);font-size:14px}
        .rapid-opt:hover{border-color:var(--orange)}
        .rapid-opt.active{border-color:var(--orange);background:rgba(249,115,22,0.2);color:var(--orange)}
        
        /* Digit Display */
        .digit-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin:10px 0}
        .digit-box{background:var(--bg);border:2px solid var(--border);border-radius:8px;padding:10px 6px;text-align:center;cursor:pointer;transition:all 0.2s;position:relative}
        .digit-box:hover{border-color:var(--cyan)}
        .digit-box.selected{border-color:var(--orange)!important;background:rgba(249,115,22,0.25)!important;box-shadow:0 0 15px rgba(249,115,22,0.4)}
        .digit-box.valid{border-color:var(--green);background:rgba(16,185,129,0.1)}
        .digit-box.valid::after{content:"‚úì";position:absolute;top:2px;right:4px;font-size:10px;color:var(--green)}
        .digit-box.coldest{border-color:var(--cyan)!important;background:rgba(6,182,212,0.25)!important;box-shadow:0 0 20px rgba(6,182,212,0.5);animation:glow 1.5s ease-in-out infinite}
        .digit-box.coldest::before{content:"‚ùÑÔ∏è";position:absolute;top:2px;left:4px;font-size:10px}
        .digit-box.just-occurred{border-color:var(--yellow)!important;background:rgba(245,158,11,0.4)!important;box-shadow:0 0 30px rgba(245,158,11,0.8),0 0 60px rgba(245,158,11,0.4);transform:scale(1.08);animation:flash-digit 0.5s ease-out}
        .digit-box.just-occurred .digit-num{color:var(--yellow);text-shadow:0 0 10px var(--yellow)}
        .digit-box.doubled{border-color:var(--red)!important;background:rgba(239,68,68,0.4)!important;box-shadow:0 0 30px rgba(239,68,68,0.8),0 0 60px rgba(239,68,68,0.4);transform:scale(1.1);animation:pulse-double 0.5s ease-in-out infinite}
        .digit-box.doubled .digit-num{color:var(--red);text-shadow:0 0 15px var(--red)}
        .digit-box.doubled .digit-status{color:var(--red)!important;font-weight:700;font-size:9px}
        .digit-box.tripled{border-color:#a855f7!important;background:rgba(168,85,247,0.5)!important;box-shadow:0 0 40px rgba(168,85,247,0.9),0 0 80px rgba(168,85,247,0.5);transform:scale(1.15);animation:pulse-triple 0.3s ease-in-out infinite}
        .digit-box.tripled .digit-num{color:#a855f7;text-shadow:0 0 20px #a855f7}
        .digit-box.tripled .digit-status{color:#a855f7!important;font-weight:700;font-size:9px}
        .digit-box.quadrupled{border-color:#ec4899!important;background:rgba(236,72,153,0.6)!important;box-shadow:0 0 50px rgba(236,72,153,1),0 0 100px rgba(236,72,153,0.6);transform:scale(1.2);animation:pulse-quad 0.2s ease-in-out infinite}
        .digit-box.quadrupled .digit-num{color:#ec4899;text-shadow:0 0 25px #ec4899}
        .digit-box.quadrupled .digit-status{color:#ec4899!important;font-weight:700;font-size:9px}
        .digit-box.quintupled{border-color:#fbbf24!important;background:rgba(251,191,36,0.6)!important;box-shadow:0 0 60px rgba(251,191,36,1),0 0 120px rgba(251,191,36,0.7);transform:scale(1.25);animation:pulse-quint 0.15s ease-in-out infinite}
        .digit-box.quintupled .digit-num{color:#fbbf24;text-shadow:0 0 30px #fbbf24}
        .digit-box.quintupled .digit-status{color:#fbbf24!important;font-weight:700;font-size:9px}
        @keyframes pulse-quint{0%,100%{transform:scale(1.25);box-shadow:0 0 60px rgba(251,191,36,1)}50%{transform:scale(1.3);box-shadow:0 0 100px rgba(251,191,36,1)}}
        @keyframes pulse-quad{0%,100%{transform:scale(1.2);box-shadow:0 0 50px rgba(236,72,153,1)}50%{transform:scale(1.25);box-shadow:0 0 80px rgba(236,72,153,1)}}
        @keyframes pulse-triple{0%,100%{transform:scale(1.15);box-shadow:0 0 40px rgba(168,85,247,0.9)}50%{transform:scale(1.2);box-shadow:0 0 70px rgba(168,85,247,1)}}
        @keyframes pulse-double{0%,100%{transform:scale(1.1);box-shadow:0 0 30px rgba(239,68,68,0.8)}50%{transform:scale(1.15);box-shadow:0 0 50px rgba(239,68,68,1)}}
        @keyframes pulse{0%,100%{transform:scale(1);opacity:1}50%{transform:scale(1.1);opacity:0.8}}
        @keyframes flash-digit{0%{transform:scale(1.15);box-shadow:0 0 50px rgba(245,158,11,1)}100%{transform:scale(1.08);box-shadow:0 0 30px rgba(245,158,11,0.8)}}
        @keyframes glow{0%,100%{box-shadow:0 0 15px rgba(6,182,212,0.4)}50%{box-shadow:0 0 25px rgba(6,182,212,0.7)}}
        .digit-num{font-size:24px;font-weight:700;transition:all 0.2s}
        .digit-pct{font-size:14px;color:var(--muted);margin-top:4px;font-weight:600}
        .digit-pct.cold{color:var(--green);font-weight:700}
        .digit-pct.coldest{color:var(--cyan);font-weight:700;font-size:15px}
        .digit-status{font-size:8px;color:var(--green);margin-top:2px;min-height:12px}
        .digit-status.coldest{color:var(--cyan);font-weight:700}
        
        /* Mode Toggle */
        .mode-toggle{display:grid;grid-template-columns:1fr 1fr;gap:4px;margin:10px 0}
        .mode-btn{padding:12px;background:var(--bg);border:2px solid var(--border);border-radius:6px;font-weight:700;cursor:pointer;text-align:center}
        .mode-btn.active{border-color:var(--cyan);background:rgba(6,182,212,0.2);color:var(--cyan)}
        
        /* Auto Mode Display */
        .auto-status{background:var(--bg);border-radius:8px;padding:15px;text-align:center;margin:10px 0}
        .auto-status.watching{border:2px solid var(--yellow);background:rgba(245,158,11,0.1)}
        .auto-status.ready{border:2px solid var(--green);background:rgba(16,185,129,0.1)}
        .auto-status.no-target{border:2px solid var(--red);background:rgba(239,68,68,0.1)}
        .auto-icon{font-size:32px;margin-bottom:5px}
        .auto-text{font-size:14px;font-weight:600}
        .auto-sub{font-size:11px;color:var(--muted);margin-top:4px}
        
        /* Manual Controls */
        .manual-controls{background:var(--bg);border-radius:8px;padding:12px;margin:10px 0}
        .trade-presets{display:flex;gap:4px;margin:8px 0}
        .preset-btn{flex:1;padding:8px;background:var(--card);border:2px solid var(--border);border-radius:4px;font-weight:700;cursor:pointer;text-align:center;font-size:12px}
        .preset-btn:hover{border-color:var(--orange)}
        .preset-btn.active{border-color:var(--orange);background:rgba(249,115,22,0.2);color:var(--orange)}
        
        .trade-buttons{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
        .single-btn{padding:15px;font-size:14px;background:linear-gradient(135deg,var(--cyan),var(--blue));color:white;border:none;border-radius:8px;cursor:pointer}
        .rapid-btn{padding:15px;font-size:14px;background:linear-gradient(135deg,var(--orange),#ea580c);color:white;border:none;border-radius:8px;cursor:pointer}
        .single-btn:hover,.rapid-btn:hover{transform:scale(1.02);box-shadow:0 0 15px rgba(6,182,212,0.4)}
        
        /* Stats */
        .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin:10px 0}
        .stat{background:var(--bg);padding:8px;border-radius:6px;text-align:center}
        .stat-val{font-size:16px;font-weight:700;font-family:monospace}
        .stat-val.pos{color:var(--green)}
        .stat-val.neg{color:var(--red)}
        .stat-label{font-size:8px;color:var(--muted);text-transform:uppercase}
        
        /* Log */
        .log{background:var(--bg);border-radius:4px;padding:6px;max-height:150px;overflow-y:auto;font-family:monospace;font-size:9px}
        .log div{padding:2px 0;border-bottom:1px solid var(--border)}
        .log .win{color:var(--green)}
        .log .loss{color:var(--red)}
        .log .info{color:var(--cyan)}
        .log .alert{color:var(--yellow)}
        .log .trade{color:var(--orange);font-weight:bold}
        
        /* Trades */
        .trades{max-height:200px;overflow-y:auto}
        .trade-row{display:flex;justify-content:space-between;padding:4px 6px;background:var(--bg);margin-bottom:2px;border-radius:4px;font-size:10px;border-left:3px solid var(--border)}
        .trade-row.win{border-left-color:var(--green)}
        .trade-row.loss{border-left-color:var(--red)}
        
        /* Ticker */
        .ticker{display:flex;flex-wrap:wrap;gap:3px;margin-top:8px;min-height:20px}
        .tick{width:18px;height:18px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700}
        .tick.win{background:var(--green);color:white}
        .tick.loss{background:var(--red);color:white}
        .tick.pending{background:var(--yellow);color:black}
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üéØ Two-Phase DIFFERS Bot</h1>
        <div class="status">
            <span class="time" id="torontoTime">--:--:-- EST</span>
            <span class="balance" id="balance">$0.00</span>
            <div class="dot" id="dot"></div>
            <span id="status">Offline</span>
        </div>
    </div>
    
    <div class="grid">
        <!-- LEFT: Connection & Settings -->
        <div>
            <div class="card">
                <h3>üîå Connection</h3>
                <label>API Token</label>
                <input type="password" id="token">
                <button class="btn-blue" id="connectBtn" onclick="connect()">Connect</button>
            </div>
            
            <div class="card">
                <h3>üìä Select Pair</h3>
                <label>Symbol</label>
                <select id="symbol" onchange="changePair()">
                    <optgroup label="Volatility (1-second)">
                        <option value="1HZ10V">Volatility 10 (1s)</option>
                        <option value="1HZ25V">Volatility 25 (1s)</option>
                        <option value="1HZ50V">Volatility 50 (1s)</option>
                        <option value="1HZ75V">Volatility 75 (1s)</option>
                        <option value="1HZ100V" selected>Volatility 100 (1s)</option>
                    </optgroup>
                    <optgroup label="Volatility (Standard)">
                        <option value="R_10">Volatility 10</option>
                        <option value="R_25">Volatility 25</option>
                        <option value="R_50">Volatility 50</option>
                        <option value="R_75">Volatility 75</option>
                        <option value="R_100">Volatility 100</option>
                    </optgroup>
                    <optgroup label="Jump Indices">
                        <option value="JD10">Jump 10</option>
                        <option value="JD25">Jump 25</option>
                        <option value="JD50">Jump 50</option>
                        <option value="JD75">Jump 75</option>
                        <option value="JD100">Jump 100</option>
                    </optgroup>
                </select>
            </div>
            
            <div class="card">
                <h3>‚öôÔ∏è Trade Settings</h3>
                <div class="row">
                    <div>
                        <label>Stake ($)</label>
                        <input type="number" id="stake" value="10" min="1">
                    </div>
                    <div>
                        <label>Ticks</label>
                        <select id="ticks">
                            <option value="1" selected>1 tick</option>
                            <option value="2">2 ticks</option>
                            <option value="3">3 ticks</option>
                            <option value="5">5 ticks</option>
                        </select>
                    </div>
                </div>
                <label>Valid Threshold (under %)</label>
                <input type="number" id="threshold" value="7" min="1" max="10">
                <label>Ticks to Analyze</label>
                <input type="number" id="ticksToAnalyze" value="100" min="30" max="500">
                
                <div style="margin-top:10px;padding-top:10px;border-top:1px solid var(--border)">
                    <label>üéØ AUTO STRATEGIES (select one or both)</label>
                    
                    <!-- STRATEGY 1: Two-Phase -->
                    <div style="margin:8px 0;padding:10px;background:var(--bg);border:2px solid var(--cyan);border-radius:6px" id="strat1Container">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                            <input type="checkbox" id="strat1Enabled" checked style="width:auto;margin:0" onchange="toggleStrat1()">
                            <span style="font-size:11px;font-weight:700;color:var(--cyan)">Strategy 1: Two-Phase</span>
                        </div>
                        
                        <div id="strat1Settings">
                            <!-- PHASE 1: Detector -->
                            <div style="padding:8px;background:rgba(6,182,212,0.1);border-radius:4px;margin-bottom:6px">
                                <div style="font-size:9px;color:var(--cyan);font-weight:600;margin-bottom:6px">üìç Phase 1: Detect (no trade)</div>
                                <div style="display:flex;align-items:center;gap:4px;margin-bottom:4px">
                                    <span style="font-size:9px;width:70px">üî•üî•üî• Triple</span>
                                    <span style="font-size:8px;color:var(--muted)">‚â§</span>
                                    <input type="number" id="tripleThreshold" value="7" min="1" max="15" step="0.5" style="width:45px;padding:2px;margin:0;font-size:10px">
                                    <span style="font-size:8px;color:var(--muted)">%</span>
                                </div>
                                <div style="display:flex;align-items:center;gap:4px;margin-bottom:4px">
                                    <span style="font-size:9px;width:70px">üí• Quad</span>
                                    <span style="font-size:8px;color:var(--muted)">‚â§</span>
                                    <input type="number" id="quadThreshold" value="9" min="1" max="15" step="0.5" style="width:45px;padding:2px;margin:0;font-size:10px">
                                    <span style="font-size:8px;color:var(--muted)">%</span>
                                </div>
                                <div style="display:flex;align-items:center;gap:4px">
                                    <span style="font-size:9px;width:70px">‚≠ê Quint</span>
                                    <span style="font-size:8px;color:var(--muted)">‚â§</span>
                                    <input type="number" id="quintThreshold" value="11" min="1" max="20" step="0.5" style="width:45px;padding:2px;margin:0;font-size:10px">
                                    <span style="font-size:8px;color:var(--muted)">%</span>
                                </div>
                            </div>
                            
                            <!-- PHASE 2: Trade -->
                            <div style="padding:8px;background:rgba(249,115,22,0.1);border-radius:4px">
                                <div style="font-size:9px;color:var(--orange);font-weight:600;margin-bottom:6px">üî• Phase 2: Trade Doubles</div>
                                <div style="display:flex;align-items:center;gap:4px;margin-bottom:4px">
                                    <span style="font-size:9px;color:var(--muted)">Threshold ‚â§</span>
                                    <input type="number" id="doubleColdThreshold" value="7" min="1" max="15" step="0.5" style="width:45px;padding:2px;margin:0;font-size:10px">
                                    <span style="font-size:8px;color:var(--muted)">%</span>
                                </div>
                                <div style="display:flex;align-items:center;gap:4px">
                                    <span style="font-size:9px;color:var(--muted)">Trades/cycle:</span>
                                    <input type="number" id="tradesPerCycle" value="5" min="1" max="20" style="width:45px;padding:2px;margin:0;font-size:10px">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- STRATEGY 2: Lowest Confidence + Confirm -->
                    <div style="margin:8px 0;padding:10px;background:var(--bg);border:2px solid var(--border);border-radius:6px" id="strat2Container">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
                            <input type="checkbox" id="strat2Enabled" style="width:auto;margin:0" onchange="toggleStrat2()">
                            <span style="font-size:11px;font-weight:700;color:var(--green)">Strategy 2: Coldest + Confirm</span>
                        </div>
                        
                        <div id="strat2Settings" style="display:none">
                            <div style="padding:8px;background:rgba(16,185,129,0.1);border-radius:4px;margin-bottom:6px">
                                <div style="font-size:9px;color:var(--green);font-weight:600;margin-bottom:6px">‚ùÑÔ∏è Track coldest digit(s)</div>
                                <div style="display:flex;align-items:center;gap:4px;margin-bottom:6px">
                                    <span style="font-size:9px;color:var(--muted)">Threshold <</span>
                                    <input type="number" id="strat2Threshold" value="5" min="1" max="10" step="0.5" style="width:45px;padding:2px;margin:0;font-size:10px">
                                    <span style="font-size:8px;color:var(--muted)">%</span>
                                </div>
                                <div style="display:flex;align-items:center;gap:4px;margin-bottom:6px">
                                    <span style="font-size:9px;color:var(--muted)">Stability</span>
                                    <input type="number" id="strat2Stability" value="3" min="1" max="10" step="0.5" style="width:45px;padding:2px;margin:0;font-size:10px">
                                    <span style="font-size:8px;color:var(--muted)">seconds</span>
                                </div>
                            </div>
                            <div style="padding:8px;background:rgba(249,115,22,0.1);border-radius:4px;margin-bottom:6px">
                                <div style="font-size:9px;color:var(--orange);font-weight:600;margin-bottom:6px">üëª Shadow Mode</div>
                                <div style="display:flex;align-items:center;gap:4px;margin-bottom:6px">
                                    <span style="font-size:9px;color:var(--muted)">Active Trades</span>
                                    <input type="number" id="strat2ActiveTrades" value="3" min="1" max="20" style="width:45px;padding:2px;margin:0;font-size:10px">
                                </div>
                                <div style="font-size:8px;color:var(--muted)">
                                    Shadow watches until loss, then trades X times
                                </div>
                            </div>
                            <div style="padding:8px;background:rgba(239,68,68,0.1);border:1px solid var(--red);border-radius:4px">
                                <div style="display:flex;align-items:center;gap:6px">
                                    <input type="checkbox" id="strat2ForceActive" style="width:auto;margin:0" onchange="toggleForceActive()">
                                    <span style="font-size:9px;color:var(--red);font-weight:600">üî• Force Active (Skip Shadow)</span>
                                </div>
                                <div style="font-size:8px;color:var(--muted);margin-top:4px">
                                    Trade immediately, no shadow mode
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="strategyStatus" style="font-size:9px;color:var(--green);margin-top:8px;padding:6px;background:var(--bg);border-radius:4px;text-align:center">
                        Active: Two-Phase
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3>üìà Session Stats</h3>
                <div class="stats-grid" style="grid-template-columns:1fr 1fr">
                    <div class="stat"><div class="stat-val" id="totalTrades">0</div><div class="stat-label">Trades</div></div>
                    <div class="stat"><div class="stat-val" id="totalWins">0</div><div class="stat-label">Wins</div></div>
                    <div class="stat"><div class="stat-val" id="winRate">0%</div><div class="stat-label">Win Rate</div></div>
                    <div class="stat"><div class="stat-val pos" id="totalPL">$0</div><div class="stat-label">P/L</div></div>
                </div>
            </div>
            
            <div class="card">
                <h3>üìã Activity Log</h3>
                <div class="log" id="log"></div>
            </div>
        </div>
        
        <!-- MIDDLE: Main Display -->
        <div>
            <!-- Digit Frequency Grid -->
            <div class="card highlight">
                <h3>üî¢ Digit Frequency <span id="tickCount" style="float:right;color:var(--cyan)">0 ticks</span></h3>
                <div style="display:flex;justify-content:center;align-items:center;gap:20px;margin-bottom:8px;padding:10px;background:var(--bg);border-radius:8px">
                    <div style="text-align:center">
                        <span style="font-size:9px;color:var(--muted)">BALANCE</span>
                        <div id="balanceDisplay" style="font-size:18px;font-weight:700;color:var(--green);font-family:monospace">$0.00</div>
                    </div>
                    <div style="text-align:center">
                        <span style="font-size:9px;color:var(--muted)">PRICE</span>
                        <div id="priceDisplay" style="font-size:16px;font-weight:600;color:var(--text);font-family:monospace">-.-----</div>
                    </div>
                    <div style="text-align:center">
                        <span style="font-size:9px;color:var(--muted)">LAST DIGIT</span>
                        <div id="lastDigitDisplay" style="font-size:48px;font-weight:700;color:var(--yellow);text-shadow:0 0 20px var(--yellow);line-height:1">-</div>
                    </div>
                </div>
                <div class="digit-grid" id="digitGrid"></div>
                <div style="font-size:9px;color:var(--muted);margin-top:4px">
                    üü° Just occurred | üî¥ DOUBLE | üü£ TRIPLE | üíó QUAD | ‚≠ê QUINT | üü¢ Valid (<span id="thresholdDisplay">7</span>%) | ‚ùÑÔ∏è Coldest
                </div>
            </div>
            
            <!-- Mode Toggle -->
            <div class="card">
                <h3>üéÆ Trading Mode</h3>
                <div class="mode-toggle">
                    <div class="mode-btn active" id="modeAuto" onclick="setMode('auto')">ü§ñ Auto Mode<br><span style="font-size:9px;font-weight:normal">Cold digit trigger</span></div>
                    <div class="mode-btn" id="modeManual" onclick="setMode('manual')">üñêÔ∏è Manual Mode<br><span style="font-size:9px;font-weight:normal">Full control</span></div>
                </div>
            </div>
            
            <!-- Auto Mode Status -->
            <div id="autoSection">
                <!-- Strategy 1 Phase Indicator -->
                <div id="strat1Indicator" style="background:var(--bg);border:2px solid var(--cyan);border-radius:8px;padding:12px;text-align:center;margin-bottom:8px">
                    <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px">STRATEGY 1: TWO-PHASE</div>
                    <div id="strat1Title" style="font-size:18px;font-weight:700;color:var(--cyan);margin:4px 0">üìç PHASE 1</div>
                    <div id="strat1Subtitle" style="font-size:10px;color:var(--muted)">Detecting signals...</div>
                    <div id="tradeCounter" style="display:none;margin-top:8px">
                        <div style="display:flex;justify-content:center;gap:5px" id="tradeDots"></div>
                        <div style="font-size:9px;color:var(--orange);margin-top:4px" id="tradeProgress">0/5 trades</div>
                    </div>
                </div>
                
                <!-- Strategy 2 Status Indicator -->
                <div id="strat2Indicator" style="background:var(--bg);border:2px solid var(--border);border-radius:8px;padding:12px;text-align:center;margin-bottom:8px;display:none">
                    <div style="font-size:9px;color:var(--muted);text-transform:uppercase;letter-spacing:1px">STRATEGY 2: COLDEST + CONFIRM</div>
                    <div id="strat2Title" style="font-size:18px;font-weight:700;color:var(--green);margin:4px 0">üëÅÔ∏è WATCHING</div>
                    <div id="strat2Subtitle" style="font-size:10px;color:var(--muted)">Looking for coldest digit...</div>
                </div>
                
                <!-- Stats Row -->
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:6px;margin-bottom:10px">
                    <div class="stat"><div class="stat-val" style="color:var(--cyan)" id="streakDisplay">0 üî•</div><div class="stat-label">Streak</div></div>
                    <div class="stat"><div class="stat-val" style="color:var(--orange)" id="bestStreakDisplay">0</div><div class="stat-label">Best</div></div>
                    <div class="stat"><div class="stat-val" style="color:var(--purple)" id="triplesCaughtDisplay">0</div><div class="stat-label">Signals</div></div>
                    <div class="stat"><div class="stat-val" id="cyclesDisplay">0</div><div class="stat-label">Cycles</div></div>
                </div>
                
                <div class="auto-status" id="autoStatus">
                    <div class="auto-icon">‚è≥</div>
                    <div class="auto-text">Collecting ticks...</div>
                    <div class="auto-sub">Need 100 ticks to start scanning</div>
                </div>
                <button class="btn-green" id="startAutoBtn" onclick="startAuto()" style="width:100%;padding:12px;display:none">‚ñ∂Ô∏è START AUTO</button>
                <button class="btn-red" id="stopAutoBtn" onclick="stopAuto()" style="width:100%;padding:12px;display:none;margin-top:6px">‚èπÔ∏è STOP AUTO</button>
            </div>
            
            <!-- Manual Mode Controls -->
            <div id="manualSection" style="display:none">
                <div class="manual-controls">
                    <div style="text-align:center;margin-bottom:8px">
                        <span style="font-size:12px;color:var(--muted)">Selected Digit:</span>
                        <span style="font-size:24px;font-weight:700;color:var(--orange);margin-left:8px" id="selectedDigitDisplay">-</span>
                    </div>
                    
                    <label>Rapid Fire Trades</label>
                    <div class="trade-presets">
                        <div class="preset-btn" onclick="setRapidCount(1)">1</div>
                        <div class="preset-btn" onclick="setRapidCount(3)">3</div>
                        <div class="preset-btn active" onclick="setRapidCount(5)">5</div>
                        <div class="preset-btn" onclick="setRapidCount(10)">10</div>
                    </div>
                    <input type="number" id="rapidCount" value="5" min="1" max="20" style="text-align:center">
                    
                    <div class="trade-buttons">
                        <button class="single-btn" id="singleBtn" onclick="placeSingleTrade()">
                            üéØ SINGLE TRADE<br><span style="font-size:10px;font-weight:normal">(1 trade)</span>
                        </button>
                        <button class="rapid-btn" id="rapidBtn" onclick="placeRapidFire()">
                            üî• RAPID FIRE<br><span style="font-size:10px;font-weight:normal" id="rapidLabel">(5 trades)</span>
                        </button>
                    </div>
                </div>
                
                <!-- Rapid Fire Results -->
                <div class="stats-grid" id="rapidStats" style="display:none">
                    <div class="stat"><div class="stat-val" id="rapidTrades">0</div><div class="stat-label">Trades</div></div>
                    <div class="stat"><div class="stat-val pos" id="rapidWins">0</div><div class="stat-label">Wins</div></div>
                    <div class="stat"><div class="stat-val neg" id="rapidLosses">0</div><div class="stat-label">Losses</div></div>
                    <div class="stat"><div class="stat-val" id="rapidPL">$0</div><div class="stat-label">P/L</div></div>
                </div>
                <div class="ticker" id="ticker"></div>
            </div>
        </div>
        
        <!-- RIGHT: History -->
        <div>
            <div class="card">
                <h3>üìú Trade History</h3>
                <div class="trades" id="trades">
                    <div style="text-align:center;color:var(--muted);padding:15px">No trades yet</div>
                </div>
            </div>
            
            <div class="card">
                <h3>üéØ Auto Triggers</h3>
                <div class="trades" id="triggers">
                    <div style="text-align:center;color:var(--muted);padding:15px">No auto triggers yet</div>
                </div>
            </div>
            
            <div class="card">
                <h3>üì• Export</h3>
                <button class="btn-blue" onclick="exportCSV()" style="margin-bottom:6px">Export Trades CSV</button>
                <button class="btn-blue" onclick="exportLog()" style="margin-bottom:6px;background:linear-gradient(135deg,var(--purple),#7c3aed)">Export Activity Log</button>
                <button class="btn-blue" onclick="resetStats()">Reset Stats</button>
            </div>
        </div>
    </div>
</div>

<script>
// =============================================
// STATE
// =============================================
const state = {
    ws: null,
    connected: false,
    ticks: [],
    trades: [],
    triggers: [],
    pendingContracts: new Map(),
    pipSize: 2,
    
    // Mode
    mode: 'auto',
    autoRunning: false,
    
    // Selection
    selectedDigit: null,
    validTargets: [],
    
    // Auto mode
    currentTarget: null,
    waitingForDigit: false,
    tradePending: false,  // Prevents multiple trades while one is processing
    
    // Double detection
    lastPriceDigit: null,     // Previous tick's digit
    doubleDetected: false,    // True when same digit appears twice
    doubleDigit: null,        // Which digit just doubled
    doubleRapidCount: 1,      // How many trades to place on double (1, 2, or 3)
    
    // Consecutive count (for triple/quadruple detection)
    consecutiveCount: 1,      // How many times current digit appeared in a row
    lastTradedDigit: null,    // Which digit we just traded on (for triple detection)
    waitingForTriple: false,  // Are we watching for triple after a double trade?
    
    // TWO-PHASE SYSTEM (Strategy 1)
    currentPhase: 1,          // 1 = Waiting for Triple, 2 = Active (trading doubles)
    phase2TradeCount: 0,      // Current trade count in Phase 2 (0 to tradesPerCycle)
    phase2TradeResults: [],   // Results of trades in current cycle ['win', 'loss', ...]
    cyclesCompleted: 0,       // Total cycles completed
    triplesCaught: 0,         // Total triples that triggered Phase 2
    
    // LOWEST CONFIDENCE + CONFIRM (Strategy 2)
    strat2: {
        trackedDigit: null,           // Which digit got tapped
        trackedFreq: null,            // Its frequency when tapped
        waitingForChange: false,      // Waiting for next tick after tap
        tradesPlaced: 0,              // Total trades placed by Strategy 2
        
        // Stability tracking
        coldestDigits: [],            // Current coldest digit(s) [1, 5] or [6]
        lastColdestSet: [],           // Previous tick's coldest set
        stableSince: null,            // Timestamp when stability started
        isStable: false,              // Stable for required seconds?
        validTargets: [],             // Digits ready to trade
        
        // Shadow/Active Mode
        phase: 'shadow',              // 'shadow' or 'active'
        activeTradeCount: 0,          // Trades taken in active mode
        simulatedTradeDigit: null,    // Which digit we "traded" in shadow
        waitingForSimResult: false    // Waiting to see if sim won/lost?
    },
    
    // Win streaks
    currentStreak: 0,         // Current win streak
    bestStreak: 0,            // Best win streak ever
    
    // Activity log (for export)
    activityLog: [],          // Full log of all events
    
    // Rapid fire
    rapidCount: 5,
    rapidInProgress: false,
    rapidResults: [],
    rapidTradesPlaced: 0,
    rapidWins: 0,
    rapidLosses: 0,
    rapidPL: 0,
    
    // Stats
    totalStats: { trades: 0, wins: 0, pl: 0 }
};

// =============================================
// TORONTO TIME
// =============================================
function updateTorontoTime() {
    const now = new Date();
    const toronto = now.toLocaleString('en-US', { 
        timeZone: 'America/Toronto',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false
    });
    document.getElementById('torontoTime').textContent = toronto + ' EST';
}
setInterval(updateTorontoTime, 1000);
updateTorontoTime();

// =============================================
// HELPERS
// =============================================
function extractDigit(quote, pipSize) {
    const multiplier = Math.pow(10, pipSize);
    return Math.round(quote * multiplier) % 10;
}

function log(msg, type = '') {
    const el = document.getElementById('log');
    const time = new Date().toLocaleTimeString('en-US', { timeZone: 'America/Toronto' });
    const fullTime = new Date().toLocaleString('en-US', { timeZone: 'America/Toronto' });
    
    // Store in activity log for export
    state.activityLog.push({
        time: fullTime,
        message: msg,
        type: type
    });
    
    // Keep log from getting too large
    if (state.activityLog.length > 5000) state.activityLog.shift();
    
    el.innerHTML = `<div class="${type}">[${time}] ${msg}</div>` + el.innerHTML;
    if (el.children.length > 100) el.removeChild(el.lastChild);
}

function getTimestamp() {
    return new Date().toLocaleString('en-US', { timeZone: 'America/Toronto' });
}

// =============================================
// INIT
// =============================================
window.onload = () => {
    const grid = document.getElementById('digitGrid');
    for (let i = 0; i < 10; i++) {
        const box = document.createElement('div');
        box.className = 'digit-box';
        box.id = `digit-${i}`;
        box.innerHTML = `
            <div class="digit-num">${i}</div>
            <div class="digit-pct" id="pct-${i}">--%</div>
            <div class="digit-status" id="status-${i}"></div>
        `;
        box.onclick = () => selectDigit(i);
        grid.appendChild(box);
    }
    
    try {
        const saved = JSON.parse(localStorage.getItem('coldDigitBot') || '{}');
        if (saved.token) document.getElementById('token').value = saved.token;
        if (saved.totalStats) state.totalStats = saved.totalStats;
        updateTotalStats();
    } catch(e) {}
    
    document.getElementById('rapidCount').addEventListener('input', (e) => {
        state.rapidCount = parseInt(e.target.value) || 5;
        updateRapidLabel();
    });
    
    document.getElementById('threshold').addEventListener('input', () => {
        document.getElementById('thresholdDisplay').textContent = document.getElementById('threshold').value;
        analyzeDigits();
    });
    
    document.getElementById('ticksToAnalyze').addEventListener('input', () => {
        analyzeDigits();
    });
    
    log('Cold Digit Tracker ready!', 'info');
    
    // Initialize strategy UI state
    updateStrategyStatus();
};

function saveSettings() {
    localStorage.setItem('coldDigitBot', JSON.stringify({
        token: document.getElementById('token').value,
        totalStats: state.totalStats
    }));
}

// =============================================
// CONNECTION
// =============================================
function connect() {
    const token = document.getElementById('token').value.trim();
    if (!token) return log('Enter API token!', 'loss');
    
    saveSettings();
    log('Connecting...', 'info');
    
    state.ws = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=1089');
    state.ws.onopen = () => state.ws.send(JSON.stringify({ authorize: token }));
    state.ws.onmessage = (e) => handleMessage(JSON.parse(e.data));
    state.ws.onerror = () => log('Connection error!', 'loss');
    state.ws.onclose = () => {
        state.connected = false;
        document.getElementById('dot').classList.remove('on');
        document.getElementById('status').textContent = 'Offline';
    };
}

function handleMessage(data) {
    if (data.error) {
        log(`Error: ${data.error.message}`, 'loss');
        return;
    }
    
    if (data.authorize) {
        state.connected = true;
        document.getElementById('dot').classList.add('on');
        document.getElementById('status').textContent = 'Online';
        document.getElementById('balance').textContent = `$${data.authorize.balance.toFixed(2)}`;
        document.getElementById('balanceDisplay').textContent = `$${data.authorize.balance.toFixed(2)}`;
        document.getElementById('connectBtn').style.display = 'none';
        log(`Connected: ${data.authorize.loginid}`, 'info');
        
        subscribeToPair();
        state.ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
    }
    
    if (data.tick) handleTick(data.tick);
    
    if (data.proposal) {
        state.ws.send(JSON.stringify({ buy: data.proposal.id, price: data.proposal.ask_price }));
    }
    
    if (data.buy) {
        const digit = state.mode === 'auto' ? state.currentTarget : state.selectedDigit;
        state.pendingContracts.set(data.buy.contract_id, {
            digit: digit,
            stake: parseFloat(document.getElementById('stake').value),
            isRapid: state.rapidInProgress
        });
        state.ws.send(JSON.stringify({ 
            proposal_open_contract: 1, 
            contract_id: data.buy.contract_id, 
            subscribe: 1 
        }));
        
        if (state.rapidInProgress) {
            state.rapidTradesPlaced++;
            state.rapidResults.push('pending');
            updateRapidDisplay();
        }
    }
    
    if (data.proposal_open_contract && data.proposal_open_contract.is_sold) {
        handleResult(data.proposal_open_contract);
    }
    
    if (data.balance) {
        document.getElementById('balance').textContent = `$${data.balance.balance.toFixed(2)}`;
        document.getElementById('balanceDisplay').textContent = `$${data.balance.balance.toFixed(2)}`;
    }
}

function subscribeToPair() {
    const symbol = document.getElementById('symbol').value;
    state.ticks = [];
    state.ws.send(JSON.stringify({ forget_all: 'ticks' }));
    state.ws.send(JSON.stringify({ ticks: symbol, subscribe: 1 }));
    log(`Subscribed to ${symbol}`, 'info');
}

function changePair() {
    if (state.connected) {
        state.autoRunning = false;
        state.waitingForDigit = false;
        state.currentTarget = null;
        state.lastPriceDigit = null;
        state.doubleDetected = false;
        state.doubleDigit = null;
        state.consecutiveCount = 1;
        state.waitingForTriple = false;
        state.lastTradedDigit = null;
        subscribeToPair();
        updateAutoStatus();
    }
}

// =============================================
// TICK HANDLING
// =============================================
function handleTick(tick) {
    if (tick.pip_size !== undefined) state.pipSize = tick.pip_size;
    
    const digit = extractDigit(tick.quote, state.pipSize);
    state.ticks.push({ digit, time: Date.now() });
    if (state.ticks.length > 1000) state.ticks.shift();
    
    const ticksToAnalyze = parseInt(document.getElementById('ticksToAnalyze').value) || 100;
    document.getElementById('tickCount').textContent = `${state.ticks.length}/${ticksToAnalyze} ticks`;
    
    // Update price and digit displays
    document.getElementById('priceDisplay').textContent = tick.quote.toFixed(state.pipSize);
    document.getElementById('lastDigitDisplay').textContent = digit;
    
    // CONSECUTIVE COUNT: Track how many times same digit in a row
    if (state.lastPriceDigit !== null && digit === state.lastPriceDigit) {
        state.consecutiveCount++;
    } else {
        state.consecutiveCount = 1;
        state.waitingForTriple = false; // Reset when different digit appears
    }
    
    const isDouble = (state.consecutiveCount === 2);
    const isTriple = (state.consecutiveCount === 3);
    const isQuadruple = (state.consecutiveCount === 4);
    const isQuintuple = (state.consecutiveCount === 5);
    
    // Clear previous states
    document.querySelectorAll('.digit-box').forEach(box => {
        box.classList.remove('just-occurred', 'doubled', 'tripled', 'quadrupled', 'quintupled');
    });
    
    // Update digit status text
    for (let i = 0; i < 10; i++) {
        const statusEl = document.getElementById(`status-${i}`);
        if (statusEl && (statusEl.textContent === 'üî• DOUBLED!' || statusEl.textContent === 'üî•üî•üî• TRIPLED!' || statusEl.textContent === 'üí• QUADRUPLED!' || statusEl.textContent === '‚≠ê QUINTUPLED!')) {
            statusEl.textContent = '';
        }
    }
    
    // Get thresholds
    const tripleThreshold = parseFloat(document.getElementById('tripleThreshold').value) || 7;
    const quadThreshold = parseFloat(document.getElementById('quadThreshold').value) || 9;
    const quintThreshold = parseFloat(document.getElementById('quintThreshold').value) || 11;
    const doubleColdThreshold = parseFloat(document.getElementById('doubleColdThreshold').value) || 7;
    const recent = state.ticks.slice(-ticksToAnalyze);
    let digitFreq = 0;
    
    if (recent.length >= 50) {
        const counts = [0,0,0,0,0,0,0,0,0,0];
        recent.forEach(t => counts[t.digit]++);
        digitFreq = counts[digit] / recent.length * 100;
    }
    
    if (isQuintuple) {
        // QUINTUPLE DETECTED!
        const coldStatus = digitFreq <= quintThreshold ? ` ‚ùÑÔ∏è COLD (‚â§${quintThreshold}%)` : ` (>${quintThreshold}%)`;
        state.doubleDetected = false;
        state.doubleDigit = null;
        document.getElementById(`digit-${digit}`).classList.add('quintupled');
        document.getElementById(`status-${digit}`).textContent = '‚≠ê QUINTUPLED!';
        log(`‚≠ê‚≠ê‚≠ê‚≠ê‚≠ê QUINTUPLE: Digit ${digit} appeared 5x! Freq: ${digitFreq.toFixed(1)}%${coldStatus}`, 'alert');
    } else if (isQuadruple) {
        // QUADRUPLE DETECTED!
        const coldStatus = digitFreq <= quadThreshold ? ` ‚ùÑÔ∏è COLD (‚â§${quadThreshold}%)` : ` (>${quadThreshold}%)`;
        state.doubleDetected = false;
        state.doubleDigit = null;
        document.getElementById(`digit-${digit}`).classList.add('quadrupled');
        document.getElementById(`status-${digit}`).textContent = 'üí• QUADRUPLED!';
        log(`üí•üí•üí•üí• QUADRUPLE: Digit ${digit} appeared 4x! Freq: ${digitFreq.toFixed(1)}%${coldStatus}`, 'alert');
    } else if (isTriple) {
        // TRIPLE DETECTED!
        const coldStatus = digitFreq <= tripleThreshold ? ` ‚ùÑÔ∏è COLD (‚â§${tripleThreshold}%)` : ` (>${tripleThreshold}%)`;
        state.doubleDetected = false;
        state.doubleDigit = null;
        document.getElementById(`digit-${digit}`).classList.add('tripled');
        document.getElementById(`status-${digit}`).textContent = 'üî•üî•üî• TRIPLED!';
        log(`üî•üî•üî• TRIPLE: Digit ${digit} appeared 3x! Freq: ${digitFreq.toFixed(1)}%${coldStatus}`, 'alert');
    } else if (isDouble) {
        // DOUBLE DETECTED!
        const coldStatus = digitFreq <= doubleColdThreshold ? ` ‚ùÑÔ∏è (‚â§${doubleColdThreshold}%)` : '';
        state.doubleDetected = true;
        state.doubleDigit = digit;
        document.getElementById(`digit-${digit}`).classList.add('doubled');
        document.getElementById(`status-${digit}`).textContent = 'üî• DOUBLED!';
        log(`üî• DOUBLE: Digit ${digit} (${digitFreq.toFixed(1)}%${coldStatus})`, 'alert');
    } else {
        state.doubleDetected = false;
        state.doubleDigit = null;
        document.getElementById(`digit-${digit}`).classList.add('just-occurred');
    }
    
    // Update lastPriceDigit for next comparison
    state.lastPriceDigit = digit;
    
    analyzeDigits();
    
    // AUTO TRADING LOGIC - Process both strategies
    if (state.autoRunning && !state.tradePending && recent.length >= ticksToAnalyze) {
        
        const strat1Enabled = document.getElementById('strat1Enabled').checked;
        const strat2Enabled = document.getElementById('strat2Enabled').checked;
        
        // ==========================================
        // STRATEGY 1: TWO-PHASE SYSTEM
        // ==========================================
        if (strat1Enabled) {
            // Check if any signal condition is met (with separate thresholds)
            let signalDetected = false;
            let signalType = '';
            
            if (isQuintuple && digitFreq <= quintThreshold) {
                signalDetected = true;
                signalType = 'Quintuple';
            } else if (isQuadruple && digitFreq <= quadThreshold) {
                signalDetected = true;
                signalType = 'Quadruple';
            } else if (isTriple && digitFreq <= tripleThreshold) {
                signalDetected = true;
                signalType = 'Triple';
            }
            
            // PHASE 1: Detector Only
            if (state.currentPhase === 1) {
                if (signalDetected) {
                    state.triplesCaught++;
                    document.getElementById('triplesCaughtDisplay').textContent = state.triplesCaught;
                    
                    const thresholdUsed = isQuintuple ? quintThreshold : (isQuadruple ? quadThreshold : tripleThreshold);
                    log(`üéØ S1 SIGNAL: ${signalType}+Cold (${digitFreq.toFixed(1)}% ‚â§ ${thresholdUsed}%)! Digit ${digit}`, 'trade');
                    log(`üìç ‚Üí üî• Activating Phase 2`, 'info');
                    
                    state.triggers.push({
                        time: getTimestamp(),
                        digit: digit,
                        freq: digitFreq,
                        reason: `üéØ S1: ${signalType} Signal`
                    });
                    updateTriggerHistory();
                    
                    state.currentPhase = 2;
                    state.phase2TradeCount = 0;
                    state.phase2TradeResults = [];
                    
                    updateAutoStatus();
                    updateStrat1Indicator();
                }
            }
            // PHASE 2: Active Trading
            else if (state.currentPhase === 2) {
                const tradesPerCycle = parseInt(document.getElementById('tradesPerCycle').value) || 5;
                
                // Check for new signal (Reset counter)
                if (signalDetected) {
                    state.triplesCaught++;
                    document.getElementById('triplesCaughtDisplay').textContent = state.triplesCaught;
                    
                    const thresholdUsed = isQuintuple ? quintThreshold : (isQuadruple ? quadThreshold : tripleThreshold);
                    log(`‚ö° S1: NEW ${signalType.toUpperCase()} (${digitFreq.toFixed(1)}%) - Resetting counter`, 'alert');
                    
                    state.triggers.push({
                        time: getTimestamp(),
                        digit: digit,
                        freq: digitFreq,
                        reason: `‚ö° S1: ${signalType} Reset`
                    });
                    updateTriggerHistory();
                    
                    state.phase2TradeCount = 0;
                    state.phase2TradeResults = [];
                    
                    updateAutoStatus();
                    updateStrat1Indicator();
                }
                // Normal Double + Cold trade
                else if (isDouble && digitFreq <= doubleColdThreshold && state.phase2TradeCount < tradesPerCycle) {
                    log(`üîî S1 Phase2 (${state.phase2TradeCount + 1}/${tradesPerCycle}): Double+Cold (${digitFreq.toFixed(1)}%)! Digit ${digit}`, 'trade');
                    
                    state.currentTarget = digit;
                    triggerTwoPhaseDoubleTrade(digit, digitFreq);
                    return; // Exit to prevent Strategy 2 from also trading
                }
            }
        }
        
        // ==========================================
        // STRATEGY 2: LOWEST CONFIDENCE + CONFIRM
        // ==========================================
        if (strat2Enabled && !state.tradePending) {
            const strat2Threshold = parseFloat(document.getElementById('strat2Threshold').value) || 5;
            const stabilitySeconds = parseFloat(document.getElementById('strat2Stability').value) || 3;
            const activeTradesTarget = parseInt(document.getElementById('strat2ActiveTrades').value) || 3;
            
            // Build counts array
            const counts = [0,0,0,0,0,0,0,0,0,0];
            recent.forEach(t => counts[t.digit]++);
            
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // SHADOW MODE: Check for simulated trade result
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (state.strat2.waitingForSimResult) {
                if (digit === state.strat2.simulatedTradeDigit) {
                    // Simulated LOSS - digit matched (DIFFERS would lose)
                    log(`üëª S2 SHADOW: ‚ùå Simulated LOSS (digit ${digit} matched) - ACTIVATING!`, 'trade');
                    state.strat2.phase = 'active';
                    state.strat2.activeTradeCount = 0;
                    state.strat2.simulatedTradeDigit = null;
                    state.strat2.waitingForSimResult = false;
                    resetStrat2();
                    updateStrat2Indicator();
                } else {
                    // Simulated WIN - digit didn't match
                    log(`üëª S2 SHADOW: ‚úÖ Simulated WIN (digit ${digit} ‚â† ${state.strat2.simulatedTradeDigit}) - Continue watching`, 'info');
                    state.strat2.simulatedTradeDigit = null;
                    state.strat2.waitingForSimResult = false;
                    resetStrat2();
                    updateStrat2Indicator();
                }
                return;
            }
            
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // STEP 5: If waiting for change after tap
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (state.strat2.waitingForChange) {
                if (digit === state.strat2.trackedDigit) {
                    // DOUBLE! Cancel this setup
                    const phaseEmoji = state.strat2.phase === 'shadow' ? 'üëª' : 'üî•';
                    log(`${phaseEmoji} S2: Digit ${digit} doubled - setup cancelled`, 'loss');
                    resetStrat2();
                    updateStrat2Indicator();
                } else {
                    // DIFFERENT! This is where we trade or simulate
                    if (state.strat2.phase === 'shadow') {
                        // SHADOW MODE: Simulate the trade, wait for result
                        log(`üëª S2 SHADOW: Digit changed to ${digit}! Simulating trade on ${state.strat2.trackedDigit}...`, 'alert');
                        state.strat2.simulatedTradeDigit = state.strat2.trackedDigit;
                        state.strat2.waitingForSimResult = true;
                        state.strat2.trackedDigit = null;
                        state.strat2.trackedFreq = null;
                        state.strat2.waitingForChange = false;
                        updateStrat2Indicator();
                    } else {
                        // ACTIVE MODE: Real trade!
                        state.strat2.activeTradeCount++;
                        log(`üî• S2 ACTIVE (${state.strat2.activeTradeCount}/${activeTradesTarget}): Trading DIFFERS on ${state.strat2.trackedDigit}`, 'trade');
                        
                        state.triggers.push({
                            time: getTimestamp(),
                            digit: state.strat2.trackedDigit,
                            freq: state.strat2.trackedFreq,
                            reason: `üî• S2: Active (${state.strat2.activeTradeCount}/${activeTradesTarget})`
                        });
                        updateTriggerHistory();
                        
                        state.currentTarget = state.strat2.trackedDigit;
                        triggerStrat2Trade(state.strat2.trackedDigit, state.strat2.trackedFreq);
                        
                        // Check if active trades complete (unless force active is on)
                        const forceActive = document.getElementById('strat2ForceActive').checked;
                        if (!forceActive && state.strat2.activeTradeCount >= activeTradesTarget) {
                            log(`üî• S2 ACTIVE: ${activeTradesTarget}/${activeTradesTarget} complete ‚Üí Back to Shadow Mode`, 'info');
                            state.strat2.phase = 'shadow';
                            state.strat2.activeTradeCount = 0;
                        }
                        resetStrat2();
                    }
                }
                return; // Exit, don't process further
            }
            
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // STEP 1: Find ALL coldest digits
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const { digits: coldestDigits, freq: coldestFreq } = findColdestDigits(counts, recent.length);
            
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // STEP 2: Check if under threshold
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (coldestFreq >= strat2Threshold) {
                // Not cold enough, reset
                if (state.strat2.isStable || state.strat2.stableSince) {
                    const phaseEmoji = state.strat2.phase === 'shadow' ? 'üëª' : 'üî•';
                    log(`${phaseEmoji} S2: Coldest (${coldestFreq.toFixed(1)}%) not under ${strat2Threshold}% - resetting`, 'info');
                }
                resetStrat2();
                updateStrat2Indicator();
                return;
            }
            
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // STEP 3: Check stability
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            const phaseEmoji = state.strat2.phase === 'shadow' ? 'üëª' : 'üî•';
            
            if (sameSet(coldestDigits, state.strat2.lastColdestSet)) {
                // Same set as before, check timer
                const elapsed = (Date.now() - state.strat2.stableSince) / 1000;
                
                if (elapsed >= stabilitySeconds && !state.strat2.isStable) {
                    // Just became stable!
                    state.strat2.isStable = true;
                    state.strat2.validTargets = [...coldestDigits];
                    const targetList = coldestDigits.join(', ');
                    log(`${phaseEmoji} S2: [${targetList}] stable for ${stabilitySeconds}s - valid target(s)!`, 'trade');
                }
            } else {
                // Set changed, reset timer
                if (state.strat2.stableSince && state.strat2.lastColdestSet.length > 0) {
                    log(`${phaseEmoji} S2: Coldest changed [${state.strat2.lastColdestSet.join(',')}] ‚Üí [${coldestDigits.join(',')}] - resetting`, 'info');
                } else if (coldestDigits.length > 0) {
                    const targetList = coldestDigits.join(', ');
                    log(`${phaseEmoji} S2: Coldest is [${targetList}] (${coldestFreq.toFixed(1)}%) - stabilizing...`, 'info');
                }
                state.strat2.stableSince = Date.now();
                state.strat2.isStable = false;
                state.strat2.validTargets = [];
            }
            
            state.strat2.coldestDigits = coldestDigits;
            state.strat2.lastColdestSet = [...coldestDigits];
            
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // STEP 4: Check for tap on valid target
            // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (state.strat2.validTargets.includes(digit)) {
                // Tapped!
                state.strat2.trackedDigit = digit;
                state.strat2.trackedFreq = coldestFreq;
                state.strat2.waitingForChange = true;
                log(`${phaseEmoji} S2: Digit ${digit} tapped! Waiting for change...`, 'alert');
            }
            
            updateStrat2Indicator();
        }
    }
    
    // Update Strategy 2 indicator even when not trading
    if (state.autoRunning && document.getElementById('strat2Enabled').checked) {
        updateStrat2Indicator();
    }
}
function analyzeDigits() {
    const threshold = parseFloat(document.getElementById('threshold').value) || 7;
    const ticksToAnalyze = parseInt(document.getElementById('ticksToAnalyze').value) || 100;
    
    if (state.ticks.length < Math.min(50, ticksToAnalyze)) {
        updateAutoStatus();
        return;
    }
    
    const recent = state.ticks.slice(-ticksToAnalyze);
    const counts = [0,0,0,0,0,0,0,0,0,0];
    recent.forEach(t => counts[t.digit]++);
    
    state.validTargets = [];
    
    // Find coldest digit (lowest frequency)
    let coldestDigit = 0;
    let coldestFreq = 100;
    
    for (let i = 0; i < 10; i++) {
        const freq = counts[i] / recent.length * 100;
        if (freq < coldestFreq) {
            coldestFreq = freq;
            coldestDigit = i;
        }
        if (freq < threshold) {
            state.validTargets.push({ digit: i, freq });
        }
    }
    
    // Update UI for all digits
    for (let i = 0; i < 10; i++) {
        const freq = counts[i] / recent.length * 100;
        const isValid = freq < threshold;
        const isColdest = i === coldestDigit;
        const isSelected = i === state.selectedDigit;
        
        const box = document.getElementById(`digit-${i}`);
        const pctEl = document.getElementById(`pct-${i}`);
        const statusEl = document.getElementById(`status-${i}`);
        
        // Update percentage display
        pctEl.textContent = `${freq.toFixed(1)}%`;
        pctEl.className = 'digit-pct';
        if (isColdest) {
            pctEl.classList.add('coldest');
        } else if (isValid) {
            pctEl.classList.add('cold');
        }
        
        // Update box classes
        box.classList.remove('valid', 'coldest', 'selected');
        
        // Apply selected state first (highest priority for visual)
        if (isSelected) {
            box.classList.add('selected');
        }
        
        // Apply coldest/valid states
        if (isColdest) {
            box.classList.add('coldest');
            statusEl.textContent = '‚ùÑÔ∏è COLDEST';
            statusEl.className = 'digit-status coldest';
        } else if (isValid) {
            box.classList.add('valid');
            statusEl.textContent = 'VALID';
            statusEl.className = 'digit-status';
        } else {
            statusEl.textContent = '';
            statusEl.className = 'digit-status';
        }
    }
    
    updateAutoStatus();
    updateManualButtons();
}

// =============================================
// MODE CONTROL
// =============================================
function setMode(mode) {
    state.mode = mode;
    
    document.getElementById('modeAuto').classList.toggle('active', mode === 'auto');
    document.getElementById('modeManual').classList.toggle('active', mode === 'manual');
    
    document.getElementById('autoSection').style.display = mode === 'auto' ? 'block' : 'none';
    document.getElementById('manualSection').style.display = mode === 'manual' ? 'block' : 'none';
    
    if (mode === 'manual') stopAuto();
    
    log(`Switched to ${mode.toUpperCase()} mode`, 'info');
}

// =============================================
// AUTO MODE
// =============================================
function updateAutoStatus() {
    const statusEl = document.getElementById('autoStatus');
    const startBtn = document.getElementById('startAutoBtn');
    const stopBtn = document.getElementById('stopAutoBtn');
    const ticksToAnalyze = parseInt(document.getElementById('ticksToAnalyze').value) || 100;
    
    const strat1Enabled = document.getElementById('strat1Enabled').checked;
    const strat2Enabled = document.getElementById('strat2Enabled').checked;
    
    // Update indicators
    updateStrat1Indicator();
    updateStrat2Indicator();
    
    if (state.ticks.length < ticksToAnalyze) {
        statusEl.className = 'auto-status';
        statusEl.innerHTML = `
            <div class="auto-icon">‚è≥</div>
            <div class="auto-text">Collecting ticks...</div>
            <div class="auto-sub">${state.ticks.length}/${ticksToAnalyze} ticks</div>
        `;
        startBtn.style.display = 'none';
        stopBtn.style.display = 'none';
        return;
    }
    
    if (!state.autoRunning) {
        const anyEnabled = strat1Enabled || strat2Enabled;
        statusEl.className = 'auto-status ready';
        statusEl.innerHTML = `
            <div class="auto-icon">${anyEnabled ? '‚úÖ' : '‚ö†Ô∏è'}</div>
            <div class="auto-text">${anyEnabled ? 'Ready' : 'No Strategy Selected'}</div>
            <div class="auto-sub">${anyEnabled ? 'Click START to begin' : 'Enable at least one strategy'}</div>
        `;
        startBtn.style.display = anyEnabled ? 'block' : 'none';
        stopBtn.style.display = 'none';
    } else {
        if (state.tradePending) {
            statusEl.className = 'auto-status watching';
            statusEl.innerHTML = `
                <div class="auto-icon">‚ö°</div>
                <div class="auto-text">Trade Pending...</div>
                <div class="auto-sub">Processing DIFFERS on digit ${state.currentTarget}</div>
            `;
        } else {
            // Build status based on active strategies
            let statusParts = [];
            if (strat1Enabled) {
                statusParts.push(state.currentPhase === 1 ? 'S1: Detecting' : `S1: Phase 2 (${state.phase2TradeCount}/X)`);
            }
            if (strat2Enabled) {
                statusParts.push(state.strat2.waitingForChange ? `S2: Tracking ${state.strat2.trackedDigit}` : 'S2: Watching');
            }
            
            statusEl.className = 'auto-status watching';
            statusEl.innerHTML = `
                <div class="auto-icon">ü§ñ</div>
                <div class="auto-text">Auto Running</div>
                <div class="auto-sub">${statusParts.join(' | ')}</div>
            `;
        }
        startBtn.style.display = 'none';
        stopBtn.style.display = 'block';
    }
}

function startAuto() {
    const ticksToAnalyze = parseInt(document.getElementById('ticksToAnalyze').value) || 100;
    const strat1Enabled = document.getElementById('strat1Enabled').checked;
    const strat2Enabled = document.getElementById('strat2Enabled').checked;
    
    // Validate at least one strategy
    if (!strat1Enabled && !strat2Enabled) {
        return log('‚ùå Select at least one strategy!', 'loss');
    }
    
    if (state.ticks.length < ticksToAnalyze) return log(`Need ${ticksToAnalyze} ticks first!`, 'loss');
    
    state.autoRunning = true;
    state.tradePending = false;
    state.lastPriceDigit = null;
    state.consecutiveCount = 1;
    
    // Reset Strategy 1 state
    state.currentPhase = 1;
    state.phase2TradeCount = 0;
    state.phase2TradeResults = [];
    
    // Reset Strategy 2 state (full reset including phase)
    resetStrat2Full();
    
    log(`ü§ñ AUTO STARTED`, 'info');
    
    if (strat1Enabled) {
        const tripleThreshold = parseFloat(document.getElementById('tripleThreshold').value) || 7;
        const quadThreshold = parseFloat(document.getElementById('quadThreshold').value) || 9;
        const quintThreshold = parseFloat(document.getElementById('quintThreshold').value) || 11;
        const doubleColdThreshold = parseFloat(document.getElementById('doubleColdThreshold').value) || 7;
        const tradesPerCycle = parseInt(document.getElementById('tradesPerCycle').value) || 5;
        
        log(`üìç S1: Detect 3x‚â§${tripleThreshold}% | 4x‚â§${quadThreshold}% | 5x‚â§${quintThreshold}%`, 'info');
        log(`üî• S1: Trade Double+Cold (‚â§${doubleColdThreshold}%) x${tradesPerCycle}`, 'info');
    }
    
    if (strat2Enabled) {
        const strat2Threshold = parseFloat(document.getElementById('strat2Threshold').value) || 5;
        const stabilitySeconds = parseFloat(document.getElementById('strat2Stability').value) || 3;
        const activeTradesTarget = parseInt(document.getElementById('strat2ActiveTrades').value) || 3;
        log(`üëª S2: Shadow Mode (<${strat2Threshold}%, stable ${stabilitySeconds}s, ${activeTradesTarget} trades after loss)`, 'info');
    }
    
    updateAutoStatus();
}

function stopAuto() {
    state.autoRunning = false;
    state.tradePending = false;
    state.currentTarget = null;
    state.doubleDetected = false;
    state.doubleDigit = null;
    state.consecutiveCount = 1;
    
    // Reset Strategy 1 state
    state.currentPhase = 1;
    state.phase2TradeCount = 0;
    state.phase2TradeResults = [];
    
    // Reset Strategy 2 state (full reset including phase)
    resetStrat2Full();
    
    log('‚èπÔ∏è Auto stopped', 'info');
    updateAutoStatus();
}

function updateStrategyDisplay() {
    updateAutoStatus();
}

// STRATEGY TOGGLE FUNCTIONS
function toggleStrat1() {
    const enabled = document.getElementById('strat1Enabled').checked;
    const container = document.getElementById('strat1Container');
    const settings = document.getElementById('strat1Settings');
    const indicator = document.getElementById('strat1Indicator');
    
    container.style.borderColor = enabled ? 'var(--cyan)' : 'var(--border)';
    settings.style.display = enabled ? 'block' : 'none';
    indicator.style.display = enabled ? 'block' : 'none';
    
    updateStrategyStatus();
}

function toggleStrat2() {
    const enabled = document.getElementById('strat2Enabled').checked;
    const container = document.getElementById('strat2Container');
    const settings = document.getElementById('strat2Settings');
    const indicator = document.getElementById('strat2Indicator');
    
    container.style.borderColor = enabled ? 'var(--green)' : 'var(--border)';
    settings.style.display = enabled ? 'block' : 'none';
    indicator.style.display = enabled ? 'block' : 'none';
    
    updateStrategyStatus();
}

function toggleForceActive() {
    const forceActive = document.getElementById('strat2ForceActive').checked;
    
    if (forceActive) {
        // Force to active mode immediately
        state.strat2.phase = 'active';
        state.strat2.activeTradeCount = 0;
        state.strat2.simulatedTradeDigit = null;
        state.strat2.waitingForSimResult = false;
        log(`üî• S2: Force Active enabled - skipping shadow mode`, 'trade');
    } else {
        // Reset to shadow mode
        state.strat2.phase = 'shadow';
        state.strat2.activeTradeCount = 0;
        log(`üëª S2: Force Active disabled - back to shadow mode`, 'info');
    }
    
    if (state.autoRunning) {
        updateStrat2Indicator();
    }
}

function updateStrategyStatus() {
    const strat1 = document.getElementById('strat1Enabled').checked;
    const strat2 = document.getElementById('strat2Enabled').checked;
    const statusEl = document.getElementById('strategyStatus');
    
    if (!strat1 && !strat2) {
        statusEl.textContent = 'Select at least one strategy';
        statusEl.style.color = 'var(--red)';
    } else {
        const active = [];
        if (strat1) active.push('Two-Phase');
        if (strat2) active.push('Coldest+Confirm');
        statusEl.textContent = `Active: ${active.join(' + ')}`;
        statusEl.style.color = 'var(--green)';
    }
}

// TWO-PHASE TRADE FUNCTIONS
// Phase 1 is detection-only (no trade function needed)
// Only Phase 2 Double trades

function triggerTwoPhaseDoubleTrade(digit, freq) {
    state.tradePending = true;
    
    const tradesPerCycle = parseInt(document.getElementById('tradesPerCycle').value) || 5;
    
    state.triggers.push({
        time: getTimestamp(),
        digit: digit,
        freq: freq,
        reason: `üî• S1 Double (${state.phase2TradeCount + 1}/${tradesPerCycle})`
    });
    updateTriggerHistory();
    
    // Place the trade
    placeTrade(digit);
    
    // Increment counter
    state.phase2TradeCount++;
    state.phase2TradeResults.push('pending');
    
    // After trade processes
    setTimeout(() => {
        state.tradePending = false;
        state.doubleDetected = false;
        state.doubleDigit = null;
        
        // Check if cycle complete
        const tradesPerCycle = parseInt(document.getElementById('tradesPerCycle').value) || 5;
        if (state.phase2TradeCount >= tradesPerCycle) {
            // Cycle complete! Return to Phase 1
            state.cyclesCompleted++;
            document.getElementById('cyclesDisplay').textContent = state.cyclesCompleted;
            
            log(`‚úÖ S1: Cycle complete! Returning to Phase 1...`, 'info');
            
            state.currentPhase = 1;
            state.phase2TradeCount = 0;
            state.phase2TradeResults = [];
        }
        
        if (state.autoRunning) {
            updateAutoStatus();
            updateStrat1Indicator();
        }
    }, 2000);
}

// =============================================
// STRATEGY 2 HELPER FUNCTIONS
// =============================================

// Find ALL digits with lowest frequency
function findColdestDigits(counts, totalTicks) {
    let minFreq = 100;
    let coldest = [];
    
    for (let i = 0; i < 10; i++) {
        const freq = counts[i] / totalTicks * 100;
        if (freq < minFreq) {
            minFreq = freq;
            coldest = [i];
        } else if (Math.abs(freq - minFreq) < 0.001) { // Handle floating point comparison
            coldest.push(i);
        }
    }
    
    return { digits: coldest, freq: minFreq };
}

// Check if two arrays have same elements (order doesn't matter)
function sameSet(arr1, arr2) {
    if (!arr1 || !arr2) return false;
    if (arr1.length !== arr2.length) return false;
    const sorted1 = [...arr1].sort((a,b) => a-b);
    const sorted2 = [...arr2].sort((a,b) => a-b);
    return sorted1.every((val, i) => val === sorted2[i]);
}

// Full reset function for Strategy 2
// Reset just the setup tracking (not phase/activeTradeCount)
function resetStrat2() {
    state.strat2.coldestDigits = [];
    state.strat2.lastColdestSet = [];
    state.strat2.stableSince = null;
    state.strat2.isStable = false;
    state.strat2.validTargets = [];
    state.strat2.trackedDigit = null;
    state.strat2.trackedFreq = null;
    state.strat2.waitingForChange = false;
    state.strat2.simulatedTradeDigit = null;
    state.strat2.waitingForSimResult = false;
}

// Full reset including phase (used when stopping or starting auto)
function resetStrat2Full() {
    resetStrat2();
    const forceActive = document.getElementById('strat2ForceActive')?.checked || false;
    state.strat2.phase = forceActive ? 'active' : 'shadow';
    state.strat2.activeTradeCount = 0;
}

function triggerStrat2Trade(digit, freq) {
    state.tradePending = true;
    state.strat2.tradesPlaced++;
    
    // Place the trade
    placeTrade(digit);
    
    // After trade processes
    setTimeout(() => {
        state.tradePending = false;
        
        if (state.autoRunning) {
            updateAutoStatus();
            updateStrat2Indicator();
        }
    }, 2000);
}

// INDICATOR UPDATE FUNCTIONS
function updateStrat1Indicator() {
    const indicator = document.getElementById('strat1Indicator');
    const title = document.getElementById('strat1Title');
    const subtitle = document.getElementById('strat1Subtitle');
    const counter = document.getElementById('tradeCounter');
    const dots = document.getElementById('tradeDots');
    const progress = document.getElementById('tradeProgress');
    
    if (!document.getElementById('strat1Enabled').checked) {
        indicator.style.display = 'none';
        return;
    }
    indicator.style.display = 'block';
    
    const tradesPerCycle = parseInt(document.getElementById('tradesPerCycle').value) || 5;
    const tripleThreshold = parseFloat(document.getElementById('tripleThreshold').value) || 7;
    const quadThreshold = parseFloat(document.getElementById('quadThreshold').value) || 9;
    const quintThreshold = parseFloat(document.getElementById('quintThreshold').value) || 11;
    const doubleColdThreshold = parseFloat(document.getElementById('doubleColdThreshold').value) || 7;
    
    if (state.currentPhase === 1) {
        indicator.style.borderColor = 'var(--cyan)';
        title.style.color = 'var(--cyan)';
        title.textContent = 'üìç PHASE 1';
        subtitle.textContent = `Detect: 3x‚â§${tripleThreshold}% | 4x‚â§${quadThreshold}% | 5x‚â§${quintThreshold}%`;
        counter.style.display = 'none';
    } else {
        indicator.style.borderColor = 'var(--orange)';
        title.style.color = 'var(--orange)';
        title.textContent = 'üî• PHASE 2';
        subtitle.textContent = `Trading Double+Cold (‚â§${doubleColdThreshold}%)`;
        counter.style.display = 'block';
        
        // Build trade dots
        let dotsHtml = '';
        for (let i = 0; i < tradesPerCycle; i++) {
            let dotClass = '';
            let dotContent = i + 1;
            
            if (i < state.phase2TradeResults.length) {
                dotClass = state.phase2TradeResults[i] === 'win' ? 'background:var(--green);color:white' : (state.phase2TradeResults[i] === 'loss' ? 'background:var(--red);color:white' : 'background:var(--yellow);color:black');
                dotContent = state.phase2TradeResults[i] === 'win' ? '‚úì' : (state.phase2TradeResults[i] === 'loss' ? '‚úó' : '?');
            } else if (i === state.phase2TradeCount) {
                dotClass = 'background:var(--orange);color:black';
            } else {
                dotClass = 'background:var(--border)';
            }
            
            dotsHtml += `<div style="width:20px;height:20px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;${dotClass}">${dotContent}</div>`;
        }
        dots.innerHTML = dotsHtml;
        progress.textContent = `${state.phase2TradeCount}/${tradesPerCycle} trades`;
    }
}

function updateStrat2Indicator() {
    const indicator = document.getElementById('strat2Indicator');
    const title = document.getElementById('strat2Title');
    const subtitle = document.getElementById('strat2Subtitle');
    
    if (!document.getElementById('strat2Enabled').checked) {
        indicator.style.display = 'none';
        return;
    }
    indicator.style.display = 'block';
    
    const threshold = parseFloat(document.getElementById('strat2Threshold').value) || 5;
    const stabilitySeconds = parseFloat(document.getElementById('strat2Stability').value) || 3;
    const activeTradesTarget = parseInt(document.getElementById('strat2ActiveTrades').value) || 3;
    
    const isShadow = state.strat2.phase === 'shadow';
    const phaseLabel = isShadow ? 'üëª SHADOW' : `üî• ACTIVE (${state.strat2.activeTradeCount}/${activeTradesTarget})`;
    
    // State: Waiting for simulated result (shadow only)
    if (state.strat2.waitingForSimResult) {
        indicator.style.borderColor = 'var(--purple)';
        title.style.color = 'var(--purple)';
        title.textContent = `üëª SIM TRADE: ${state.strat2.simulatedTradeDigit}`;
        subtitle.textContent = `Waiting for result...`;
        return;
    }
    
    // State: Waiting for change after tap
    if (state.strat2.waitingForChange) {
        indicator.style.borderColor = 'var(--orange)';
        title.style.color = 'var(--orange)';
        title.textContent = `${phaseLabel}: ‚ö° ${state.strat2.trackedDigit}`;
        subtitle.textContent = `Tapped! Waiting for change...`;
        return;
    }
    
    // State: Valid targets ready
    if (state.strat2.validTargets.length > 0) {
        indicator.style.borderColor = isShadow ? 'var(--purple)' : 'var(--cyan)';
        title.style.color = isShadow ? 'var(--purple)' : 'var(--cyan)';
        title.textContent = `${phaseLabel}: üéØ ${state.strat2.validTargets.join(', ')}`;
        subtitle.textContent = `Waiting for tap...`;
        return;
    }
    
    // State: Stabilizing
    if (state.strat2.stableSince && state.strat2.coldestDigits.length > 0) {
        const elapsed = ((Date.now() - state.strat2.stableSince) / 1000).toFixed(1);
        indicator.style.borderColor = 'var(--yellow)';
        title.style.color = 'var(--yellow)';
        title.textContent = `${phaseLabel}: ‚è≥ ${state.strat2.coldestDigits.join(', ')}`;
        subtitle.textContent = `Stabilizing ${elapsed}s / ${stabilitySeconds}s`;
        return;
    }
    
    // State: Watching
    indicator.style.borderColor = isShadow ? 'var(--purple)' : 'var(--green)';
    title.style.color = isShadow ? 'var(--purple)' : 'var(--green)';
    title.textContent = `${phaseLabel}`;
    subtitle.textContent = `Looking for coldest < ${threshold}%`;
}

// Keep old function name for compatibility
function updatePhaseIndicator() {
    updateStrat1Indicator();
}

// =============================================
// MANUAL MODE
// =============================================
function selectDigit(d) {
    state.selectedDigit = d;
    document.querySelectorAll('.digit-box').forEach(box => box.classList.remove('selected'));
    document.getElementById(`digit-${d}`).classList.add('selected');
    document.getElementById('selectedDigitDisplay').textContent = d;
    updateManualButtons();
    log(`Selected digit ${d} for manual trading`, 'info');
}

function updateManualButtons() {
    // Buttons always enabled - user can trade anytime
}

function setRapidCount(count) {
    state.rapidCount = count;
    document.getElementById('rapidCount').value = count;
    document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent === String(count));
    });
    updateRapidLabel();
}

function updateRapidLabel() {
    document.getElementById('rapidLabel').textContent = `(${state.rapidCount} trades)`;
}

function placeSingleTrade() {
    if (!state.connected) {
        log('Connect first!', 'loss');
        return;
    }
    
    // If no digit selected, use coldest valid or default to 0
    let digit = state.selectedDigit;
    if (digit === null) {
        if (state.validTargets.length > 0) {
            state.validTargets.sort((a, b) => a.freq - b.freq);
            digit = state.validTargets[0].digit;
            log(`No digit selected, using coldest: ${digit}`, 'alert');
        } else {
            digit = 0;
            log(`No digit selected, using default: 0`, 'alert');
        }
        state.selectedDigit = digit;
        document.getElementById('selectedDigitDisplay').textContent = digit;
        document.getElementById(`digit-${digit}`).classList.add('selected');
    }
    
    log(`üéØ Single: DIFFERS on digit ${digit}`, 'trade');
    placeTrade(digit);
}

function placeRapidFire() {
    if (!state.connected) {
        log('Connect first!', 'loss');
        return;
    }
    
    if (state.rapidInProgress) {
        log('Rapid fire already in progress!', 'alert');
        return;
    }
    
    // If no digit selected, use coldest valid or default to 0
    let digit = state.selectedDigit;
    if (digit === null) {
        if (state.validTargets.length > 0) {
            state.validTargets.sort((a, b) => a.freq - b.freq);
            digit = state.validTargets[0].digit;
            log(`No digit selected, using coldest: ${digit}`, 'alert');
        } else {
            digit = 0;
            log(`No digit selected, using default: 0`, 'alert');
        }
        state.selectedDigit = digit;
        document.getElementById('selectedDigitDisplay').textContent = digit;
        document.getElementById(`digit-${digit}`).classList.add('selected');
    }
    
    state.rapidInProgress = true;
    state.rapidResults = [];
    state.rapidTradesPlaced = 0;
    state.rapidWins = 0;
    state.rapidLosses = 0;
    state.rapidPL = 0;
    
    document.getElementById('rapidStats').style.display = 'grid';
    document.getElementById('ticker').innerHTML = '';
    
    log(`üî• Rapid: ${state.rapidCount} DIFFERS on digit ${digit}`, 'trade');
    
    let fired = 0;
    const interval = setInterval(() => {
        if (fired >= state.rapidCount || !state.rapidInProgress) {
            clearInterval(interval);
            return;
        }
        placeTrade(state.selectedDigit);
        fired++;
    }, 150);
}

// =============================================
// TRADE EXECUTION
// =============================================
function placeTrade(digit) {
    const stake = parseFloat(document.getElementById('stake').value);
    const ticks = parseInt(document.getElementById('ticks').value);
    const symbol = document.getElementById('symbol').value;
    
    state.ws.send(JSON.stringify({
        proposal: 1,
        amount: stake.toFixed(2),
        basis: 'stake',
        contract_type: 'DIGITDIFF',
        currency: 'USD',
        duration: ticks,
        duration_unit: 't',
        symbol: symbol,
        barrier: String(digit)
    }));
}

function handleResult(contract) {
    const info = state.pendingContracts.get(contract.contract_id);
    if (!info) return;
    state.pendingContracts.delete(contract.contract_id);
    
    const profit = contract.profit;
    const isWin = profit > 0;
    
    state.totalStats.trades++;
    if (isWin) state.totalStats.wins++;
    state.totalStats.pl += profit;
    
    state.trades.push({
        time: getTimestamp(),
        digit: info.digit,
        stake: info.stake,
        result: isWin ? 'WIN' : 'LOSS',
        profit: profit
    });
    
    // Update win streak
    if (isWin) {
        state.currentStreak++;
        if (state.currentStreak > state.bestStreak) {
            state.bestStreak = state.currentStreak;
            document.getElementById('bestStreakDisplay').textContent = state.bestStreak;
        }
    } else {
        state.currentStreak = 0;
    }
    
    // Update streak display
    const streakEl = document.getElementById('streakDisplay');
    if (state.currentStreak >= 5) {
        streakEl.textContent = `${state.currentStreak} üî•üî•`;
        streakEl.style.color = 'var(--orange)';
    } else if (state.currentStreak >= 3) {
        streakEl.textContent = `${state.currentStreak} üî•`;
        streakEl.style.color = 'var(--green)';
    } else {
        streakEl.textContent = state.currentStreak;
        streakEl.style.color = 'var(--cyan)';
    }
    
    // Update Phase 2 trade results
    if (state.currentPhase === 2 && state.phase2TradeResults.length > 0) {
        const pendingIdx = state.phase2TradeResults.indexOf('pending');
        if (pendingIdx >= 0) {
            state.phase2TradeResults[pendingIdx] = isWin ? 'win' : 'loss';
            updatePhaseIndicator();
        }
    }
    
    if (info.isRapid && state.rapidInProgress) {
        if (isWin) state.rapidWins++;
        else state.rapidLosses++;
        state.rapidPL += profit;
        
        const idx = state.rapidResults.indexOf('pending');
        if (idx >= 0) state.rapidResults[idx] = isWin ? 'win' : 'loss';
        
        updateRapidDisplay();
        
        if (state.rapidWins + state.rapidLosses >= state.rapidCount) {
            state.rapidInProgress = false;
            log(`üî• Rapid done: ${state.rapidWins}W/${state.rapidLosses}L, P/L: $${state.rapidPL.toFixed(2)}`, 'info');
        }
    }
    
    log(isWin ? `‚úÖ WIN +$${profit.toFixed(2)}` : `‚ùå LOSS -$${Math.abs(profit).toFixed(2)}`, isWin ? 'win' : 'loss');
    
    updateTotalStats();
    updateTradeHistory();
    saveSettings();
}

// =============================================
// UI UPDATES
// =============================================
function updateRapidDisplay() {
    document.getElementById('rapidTrades').textContent = state.rapidTradesPlaced;
    document.getElementById('rapidWins').textContent = state.rapidWins;
    document.getElementById('rapidLosses').textContent = state.rapidLosses;
    
    const plEl = document.getElementById('rapidPL');
    plEl.textContent = `$${state.rapidPL >= 0 ? '+' : ''}${state.rapidPL.toFixed(2)}`;
    plEl.className = 'stat-val ' + (state.rapidPL >= 0 ? 'pos' : 'neg');
    
    document.getElementById('ticker').innerHTML = state.rapidResults.map(r => 
        `<div class="tick ${r}">${r === 'win' ? '‚úì' : r === 'loss' ? '‚úó' : '?'}</div>`
    ).join('');
}

function updateTotalStats() {
    document.getElementById('totalTrades').textContent = state.totalStats.trades;
    document.getElementById('totalWins').textContent = state.totalStats.wins;
    document.getElementById('winRate').textContent = 
        state.totalStats.trades > 0 ? `${(state.totalStats.wins / state.totalStats.trades * 100).toFixed(1)}%` : '0%';
    
    const plEl = document.getElementById('totalPL');
    plEl.textContent = `$${state.totalStats.pl >= 0 ? '+' : ''}${state.totalStats.pl.toFixed(2)}`;
    plEl.className = 'stat-val ' + (state.totalStats.pl >= 0 ? 'pos' : 'neg');
}

function updateTradeHistory() {
    document.getElementById('trades').innerHTML = state.trades.slice(-30).reverse().map(t => 
        `<div class="trade-row ${t.result.toLowerCase()}">
            <span>D${t.digit} | $${t.stake}</span>
            <span>${t.profit >= 0 ? '+' : ''}$${t.profit.toFixed(2)}</span>
        </div>`
    ).join('') || '<div style="text-align:center;color:var(--muted)">No trades</div>';
}

function updateTriggerHistory() {
    document.getElementById('triggers').innerHTML = state.triggers.slice(-20).reverse().map(t => 
        `<div class="trade-row">
            <span>Digit ${t.digit} (${t.freq.toFixed(1)}%)</span>
            <span style="color:var(--muted)">${t.time.split(', ')[1]}</span>
        </div>`
    ).join('') || '<div style="text-align:center;color:var(--muted)">No triggers</div>';
}

// =============================================
// EXPORT
// =============================================
function exportCSV() {
    if (!state.trades.length) return alert('No trades!');
    let csv = 'Time,Digit,Stake,Result,Profit\n';
    state.trades.forEach(t => csv += `"${t.time}",${t.digit},${t.stake},${t.result},${t.profit.toFixed(2)}\n`);
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
    a.download = `cold_digit_${new Date().toISOString().slice(0,10)}.csv`;
    a.click();
}

function exportLog() {
    if (!state.activityLog.length) return alert('No activity log!');
    let txt = 'TWO-PHASE DIFFERS BOT - ACTIVITY LOG\n';
    txt += '=====================================\n';
    txt += `Exported: ${new Date().toLocaleString('en-US', { timeZone: 'America/Toronto' })}\n`;
    txt += `Total Entries: ${state.activityLog.length}\n`;
    txt += `Triples Caught: ${state.triplesCaught}\n`;
    txt += `Cycles Completed: ${state.cyclesCompleted}\n`;
    txt += `Best Streak: ${state.bestStreak}\n`;
    txt += '=====================================\n\n';
    
    state.activityLog.forEach(entry => {
        txt += `[${entry.time}] ${entry.message}\n`;
    });
    
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([txt], { type: 'text/plain' }));
    a.download = `activity_log_${new Date().toISOString().slice(0,10)}.txt`;
    a.click();
    
    log('üì• Activity log exported!', 'info');
}

function resetStats() {
    if (!confirm('Reset stats?')) return;
    state.trades = [];
    state.triggers = [];
    state.totalStats = { trades: 0, wins: 0, pl: 0 };
    saveSettings();
    updateTotalStats();
    updateTradeHistory();
    updateTriggerHistory();
    log('Stats reset', 'info');
}
</script>
</body>
</html>
