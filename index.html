<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DIFFERS Bot v8 - Phase Sniper</title>
    <style>
        :root{--bg:#0a0e17;--card:#1a2235;--border:#2a3549;--text:#f1f5f9;--muted:#64748b;--green:#10b981;--red:#ef4444;--cyan:#06b6d4;--yellow:#f59e0b;--purple:#a855f7;--orange:#f97316;--blue:#3b82f6}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,sans-serif;background:var(--bg);color:var(--text);padding:8px;font-size:12px}
        .container{max-width:1400px;margin:0 auto}
        .header{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:2px solid var(--cyan);margin-bottom:8px;flex-wrap:wrap;gap:4px}
        .header h1{font-size:16px;color:var(--cyan)}
        .status{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
        .dot{width:10px;height:10px;border-radius:50%;background:var(--muted)}
        .dot.on{background:var(--green);box-shadow:0 0 10px var(--green)}
        .balance{font-family:monospace;font-size:14px;color:var(--green)}
        .time{font-size:10px;color:var(--muted)}
        .reconnect-badge{font-size:9px;color:var(--yellow);background:rgba(245,158,11,0.15);padding:2px 6px;border-radius:10px;display:none}
        .stale-badge{font-size:9px;color:var(--red);background:rgba(239,68,68,0.15);padding:2px 6px;border-radius:10px;display:none}

        .grid{display:grid;grid-template-columns:280px 1fr 300px;gap:8px}
        @media(max-width:1200px){.grid{grid-template-columns:1fr}}

        .card{background:var(--card);border:1px solid var(--border);border-radius:6px;padding:10px;margin-bottom:6px}
        .card h3{font-size:9px;color:var(--muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:1px}
        .card.highlight{border:2px solid var(--cyan);background:rgba(6,182,212,0.05)}

        label{display:block;font-size:9px;color:var(--muted);margin-bottom:2px}
        input,select{width:100%;padding:5px;background:var(--bg);border:1px solid var(--border);border-radius:4px;color:var(--text);font-size:11px;margin-bottom:4px}
        .row{display:grid;grid-template-columns:1fr 1fr;gap:4px}

        button{padding:6px 10px;border:none;border-radius:5px;font-weight:700;cursor:pointer;font-size:10px;text-transform:uppercase;transition:all 0.2s}
        .btn-blue{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;width:100%}
        .btn-cyan{background:var(--cyan);color:black}
        .btn-green{background:var(--green);color:white}
        .btn-red{background:var(--red);color:white}
        .btn-orange{background:var(--orange);color:white}

        .digit-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:4px;margin:8px 0}
        .digit-box{background:var(--bg);border:2px solid var(--border);border-radius:6px;padding:8px 4px;text-align:center;transition:all 0.2s}
        .digit-box.coldest{border-color:var(--cyan)!important;background:rgba(6,182,212,0.25)!important;box-shadow:0 0 15px rgba(6,182,212,0.5)}
        .digit-box.just-occurred{border-color:var(--yellow)!important;background:rgba(245,158,11,0.4)!important;transform:scale(1.05)}
        .digit-box.doubled{border-color:var(--red)!important;background:rgba(239,68,68,0.4)!important;transform:scale(1.08);animation:pulse-double 0.5s ease-in-out infinite}
        .digit-box.tripled{border-color:#a855f7!important;background:rgba(168,85,247,0.5)!important;transform:scale(1.1);animation:pulse-triple 0.3s ease-in-out infinite}
        @keyframes pulse-triple{0%,100%{transform:scale(1.1)}50%{transform:scale(1.15)}}
        @keyframes pulse-double{0%,100%{transform:scale(1.08)}50%{transform:scale(1.12)}}
        .digit-num{font-size:20px;font-weight:700}
        .digit-pct{font-size:12px;color:var(--muted);margin-top:2px;font-weight:600}
        .digit-pct.cold{color:var(--cyan);font-weight:700}

        /* Phase Banner */
        .phase-banner{padding:14px;border-radius:8px;text-align:center;font-weight:700;margin:8px 0;font-size:14px;transition:all 0.3s}
        .phase-banner.idle{background:rgba(100,116,139,0.2);border:2px solid var(--muted);color:var(--muted)}
        .phase-banner.phase1{background:rgba(245,158,11,0.2);border:2px solid var(--yellow);color:var(--yellow);animation:pulse-phase1 2s ease-in-out infinite}
        .phase-banner.phase2{background:rgba(16,185,129,0.2);border:2px solid var(--green);color:var(--green);animation:pulse-phase2 1s ease-in-out infinite}
        .phase-banner.done{background:rgba(6,182,212,0.2);border:2px solid var(--cyan);color:var(--cyan)}
        .phase-banner.session-done{background:rgba(168,85,247,0.2);border:2px solid var(--purple);color:var(--purple)}
        @keyframes pulse-phase1{0%,100%{opacity:1}50%{opacity:0.7}}
        @keyframes pulse-phase2{0%,100%{box-shadow:0 0 5px var(--green)}50%{box-shadow:0 0 20px var(--green)}}

        .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin:6px 0}
        .stat{background:var(--bg);padding:6px;border-radius:4px;text-align:center}
        .stat-val{font-size:14px;font-weight:700;font-family:monospace}
        .stat-val.pos{color:var(--green)}
        .stat-val.neg{color:var(--red)}
        .stat-label{font-size:7px;color:var(--muted);text-transform:uppercase}

        .log{background:var(--bg);border-radius:4px;padding:4px;max-height:200px;overflow-y:auto;font-family:monospace;font-size:8px}
        .log div{padding:1px 0;border-bottom:1px solid var(--border)}
        .log .win{color:var(--green)}
        .log .loss{color:var(--red)}
        .log .info{color:var(--cyan)}
        .log .alert{color:var(--yellow)}
        .log .trade{color:var(--orange);font-weight:bold}
        .log .phase{color:var(--purple);font-weight:bold}

        .trades{max-height:200px;overflow-y:auto}
        .trade-row{display:flex;justify-content:space-between;padding:4px 6px;background:var(--bg);margin-bottom:2px;border-radius:4px;font-size:9px;border-left:3px solid var(--border)}
        .trade-row.win{border-left-color:var(--green)}
        .trade-row.loss{border-left-color:var(--red)}
        .trade-row.sim{border-left-color:var(--yellow);opacity:0.7}

        .cycle-progress{margin:8px 0}
        .cycle-bar{height:10px;background:var(--bg);border-radius:5px;overflow:hidden;margin:3px 0}
        .cycle-fill{height:100%;transition:width 0.3s;border-radius:5px}
        .cycle-fill.p1{background:var(--yellow)}
        .cycle-fill.p2{background:var(--green)}
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>üéØ DIFFERS Bot v8 - Phase Sniper</h1>
        <div class="status">
            <span class="time" id="torontoTime">--:--:-- EST</span>
            <span class="balance" id="balance">$0.00</span>
            <div class="dot" id="dot"></div>
            <span id="status">Offline</span>
            <span class="reconnect-badge" id="reconnectBadge">üîÑ 0</span>
            <span class="stale-badge" id="staleBadge">‚ö†Ô∏è STALE</span>
        </div>
    </div>

    <div class="grid">
        <!-- LEFT COLUMN -->
        <div>
            <div class="card">
                <h3>üîå Connection</h3>
                <label>API Token</label>
                <input type="password" id="token">
                <button class="btn-blue" onclick="connect()">Connect</button>
                <div style="margin-top:4px;font-size:8px;color:var(--muted)" id="connectionInfo">
                    <span id="workerStatus">Worker: ‚è≥</span> |
                    <span id="wakeLockStatus">WakeLock: ‚è≥</span> |
                    <span id="idbStatus">IDB: ‚è≥</span>
                </div>
            </div>

            <div class="card">
                <h3>‚öôÔ∏è Settings</h3>
                <div class="row">
                    <div><label>Stake ($)</label><input type="number" id="stake" value="10" min="1"></div>
                    <div><label>Symbol</label>
                        <select id="symbol" onchange="changePair()">
                            <optgroup label="Volatility (1s)">
                                <option value="1HZ10V" selected>Vol 10 (1s)</option>
                                <option value="1HZ25V">Vol 25 (1s)</option>
                                <option value="1HZ50V">Vol 50 (1s)</option>
                                <option value="1HZ75V">Vol 75 (1s)</option>
                                <option value="1HZ100V">Vol 100 (1s)</option>
                            </optgroup>
                            <optgroup label="Jump Indices">
                                <option value="JD10">Jump 10</option>
                                <option value="JD25">Jump 25</option>
                                <option value="JD50">Jump 50</option>
                                <option value="JD75">Jump 75</option>
                                <option value="JD100">Jump 100</option>
                            </optgroup>
                        </select>
                    </div>
                </div>
                <label>Ticks to Analyze</label>
                <input type="number" id="ticksToAnalyze" value="100" min="30" max="500">
            </div>

            <div class="card">
                <h3>üéØ Strategy: Coldest + Confirm</h3>
                <div class="row">
                    <div><label>Coldest ‚â§%</label><input type="number" id="coldThreshold" value="6" step="0.5"></div>
                    <div><label>Stability (s)</label><input type="number" id="stability" value="3" min="1"></div>
                </div>
                <div class="row">
                    <div><label>Digit Cooldown (s)</label><input type="number" id="digitCooldown" value="10" min="0"></div>
                    <div><label>Max/Digit</label><input type="number" id="maxPerDigit" value="2" min="1" max="5"></div>
                </div>
            </div>

            <div class="card" style="border:2px solid var(--purple);background:rgba(168,85,247,0.05)">
                <h3>üîÑ Session & Cycle Config</h3>
                <div class="row">
                    <div><label>Trades per Cycle</label><input type="number" id="tradesPerCycle" value="12" min="1" max="50"></div>
                    <div><label>Cycles per Session</label><input type="number" id="cyclesPerSession" value="2" min="1" max="10"></div>
                </div>
                <div style="font-size:8px;color:var(--muted);margin-top:4px;padding:4px;background:var(--bg);border-radius:4px">
                    <div>üìã <strong>Phase 1:</strong> Shadow-trade until a <span style="color:var(--red)">LOSS</span> is detected</div>
                    <div>üìã <strong>Phase 2:</strong> Real trades begin after the loss signal</div>
                    <div>üìã Each cycle = Phase 1 ‚Üí Phase 2 ‚Üí <span id="configTradesLabel">12</span> real trades</div>
                    <div>üìã Session = <span id="configCyclesLabel">2</span> cycles then STOP</div>
                </div>
            </div>

            <div class="card">
                <h3>üî• Rapid Fire <span style="color:var(--red);font-size:7px">‚ö†Ô∏è RISKY</span></h3>
                <div style="display:flex;align-items:center;gap:8px">
                    <label style="display:flex;align-items:center;gap:4px">
                        <input type="checkbox" id="rapidFire" style="width:auto">
                        <span style="font-size:9px">Enable</span>
                    </label>
                    <div style="flex:1">
                        <label style="font-size:8px">Trades/Signal</label>
                        <input type="number" id="rapidCount" value="2" min="2" max="5" style="width:100%">
                    </div>
                </div>
                <div style="font-size:7px;color:var(--red);margin-top:2px">Places multiple trades per signal - amplifies losses</div>
            </div>

            <div class="card">
                <h3>üì± Background Mode</h3>
                <label style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
                    <input type="checkbox" id="backgroundMode" style="width:auto">
                    <span style="font-size:10px;font-weight:600;color:var(--purple)">Keep alive when locked</span>
                </label>
                <div style="font-size:8px;color:var(--muted)">Silent audio keeps bot running on mobile</div>
                <div id="backgroundStatus" style="font-size:9px;color:var(--green);margin-top:4px;display:none">üîä Keep-alive active</div>
            </div>

            <div class="card">
                <h3>üìã Activity Log</h3>
                <div class="log" id="log"></div>
            </div>
        </div>

        <!-- MIDDLE COLUMN -->
        <div>
            <!-- Phase Banner -->
            <div class="phase-banner idle" id="phaseBanner">
                ‚èπ Connect and click START
            </div>

            <!-- Cycle Progress -->
            <div class="card" id="progressCard" style="display:none">
                <h3>üìä SESSION PROGRESS</h3>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:8px">
                    <div style="background:var(--bg);padding:8px;border-radius:4px;text-align:center">
                        <div style="font-size:8px;color:var(--muted)">CYCLE</div>
                        <div style="font-size:20px;font-weight:700;color:var(--purple)" id="currentCycle">1/2</div>
                    </div>
                    <div style="background:var(--bg);padding:8px;border-radius:4px;text-align:center">
                        <div style="font-size:8px;color:var(--muted)">PHASE</div>
                        <div style="font-size:20px;font-weight:700" id="currentPhase">-</div>
                    </div>
                    <div style="background:var(--bg);padding:8px;border-radius:4px;text-align:center">
                        <div style="font-size:8px;color:var(--muted)">P2 TRADES</div>
                        <div style="font-size:20px;font-weight:700;color:var(--green)" id="cycleTradeCount">0/12</div>
                    </div>
                </div>

                <div class="cycle-progress">
                    <div style="display:flex;justify-content:space-between;font-size:8px;color:var(--muted)">
                        <span>Phase 1 (Watching)</span>
                        <span id="p1Status">Waiting for loss...</span>
                    </div>
                    <div class="cycle-bar"><div class="cycle-fill p1" id="p1Bar" style="width:0%"></div></div>
                    <div style="display:flex;justify-content:space-between;font-size:8px;color:var(--muted);margin-top:4px">
                        <span>Phase 2 (Trading)</span>
                        <span id="p2Status">-</span>
                    </div>
                    <div class="cycle-bar"><div class="cycle-fill p2" id="p2Bar" style="width:0%"></div></div>
                </div>

                <div style="text-align:center;font-size:9px;margin-top:6px">
                    <span style="color:var(--yellow)">‚óè P1 Shadow: <span id="p1SimCount">0</span></span>
                    <span style="margin:0 8px;color:var(--muted)">|</span>
                    <span style="color:var(--green)">‚óè P2 Real: <span id="p2RealCount">0</span></span>
                </div>
            </div>

            <!-- Digit Grid -->
            <div class="card highlight">
                <h3>üî¢ Digit Frequency <span id="currentMarket" style="color:var(--purple);margin-left:6px">1HZ10V</span> <span id="tickCount" style="float:right;color:var(--cyan)">0 ticks</span></h3>
                <div style="display:flex;justify-content:center;align-items:center;gap:15px;margin-bottom:6px;padding:8px;background:var(--bg);border-radius:6px">
                    <div style="text-align:center">
                        <span style="font-size:8px;color:var(--muted)">PRICE</span>
                        <div id="priceDisplay" style="font-size:14px;font-weight:600;font-family:monospace">-.-----</div>
                    </div>
                    <div style="text-align:center">
                        <span style="font-size:8px;color:var(--muted)">LAST DIGIT</span>
                        <div id="lastDigitDisplay" style="font-size:36px;font-weight:700;color:var(--yellow);text-shadow:0 0 15px var(--yellow);line-height:1">-</div>
                    </div>
                    <div style="text-align:center">
                        <span style="font-size:8px;color:var(--muted)">BALANCE</span>
                        <div id="balanceDisplay" style="font-size:14px;font-weight:700;color:var(--green);font-family:monospace">$0.00</div>
                    </div>
                </div>
                <div class="digit-grid" id="digitGrid"></div>
            </div>

            <!-- Session Stats -->
            <div class="card">
                <h3>üìà Session Stats</h3>
                <div class="stats-grid">
                    <div class="stat"><div class="stat-val" id="totalTrades">0</div><div class="stat-label">Real Trades</div></div>
                    <div class="stat"><div class="stat-val" id="totalWins">0</div><div class="stat-label">Wins</div></div>
                    <div class="stat"><div class="stat-val" id="winRate">0%</div><div class="stat-label">Win Rate</div></div>
                    <div class="stat"><div class="stat-val pos" id="totalPL">$0.00</div><div class="stat-label">P/L</div></div>
                </div>
                <div style="display:flex;justify-content:center;gap:20px;margin-top:4px">
                    <div><span style="font-size:8px;color:var(--muted)">Streak: </span><span style="font-size:12px;font-weight:700;color:var(--green)" id="currentStreak">0</span></div>
                    <div><span style="font-size:8px;color:var(--muted)">Best: </span><span style="font-size:12px;font-weight:700;color:var(--orange)" id="bestStreak">0</span></div>
                    <div><span style="font-size:8px;color:var(--muted)">P1 Losses Caught: </span><span style="font-size:12px;font-weight:700;color:var(--yellow)" id="p1LossesCaught">0</span></div>
                </div>
            </div>

            <!-- Controls -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:4px">
                <button class="btn-green" onclick="startBot()" id="startBotBtn" style="font-size:14px;padding:12px">üöÄ START BOT</button>
                <button class="btn-red" onclick="stopBot()" id="stopBotBtn" style="font-size:14px;padding:12px">‚èπ STOP</button>
            </div>
        </div>

        <!-- RIGHT COLUMN -->
        <div>
            <!-- All Trades (Real + Simulated) -->
            <div class="card">
                <h3>üí∞ Trade Log <span id="realTradeCount" style="float:right;color:var(--green)">0 real</span></h3>
                <div class="trades" id="tradeLog">
                    <div style="text-align:center;color:var(--muted);padding:15px;font-size:10px">No trades yet</div>
                </div>
            </div>

            <!-- Cycle History -->
            <div class="card">
                <h3>üîÑ Cycle History</h3>
                <div id="cycleHistory" style="font-size:9px">
                    <div style="text-align:center;color:var(--muted);padding:10px">No cycles completed</div>
                </div>
            </div>

            <!-- Session Data -->
            <div class="card">
                <h3>üìä Session Data</h3>
                <div style="background:var(--bg);padding:8px;border-radius:4px;margin-bottom:6px">
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;text-align:center">
                        <div>
                            <div style="font-size:8px;color:var(--muted)">TICKS</div>
                            <div style="font-size:16px;font-weight:700;color:var(--cyan)" id="ticksRecorded">0</div>
                        </div>
                        <div>
                            <div style="font-size:8px;color:var(--muted)">DURATION</div>
                            <div style="font-size:16px;font-weight:700;color:var(--cyan)" id="sessionDuration">0:00</div>
                        </div>
                    </div>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:4px">
                    <button class="btn-cyan" onclick="downloadTickData()">üì• Ticks CSV</button>
                    <button class="btn-orange" onclick="downloadTradeLog()">üì• Trades CSV</button>
                </div>
                <button class="btn-blue" onclick="downloadActivityLog()" style="width:100%;margin-top:4px">üì• Activity Log</button>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================
// RESILIENCE: Web Worker keep-alive (15s pings)
// ============================================================
let keepAliveWorker = null;
function initKeepAliveWorker() {
    try {
        const blob = new Blob([`
            let iv=null;
            self.onmessage=function(e){
                if(e.data==='start'){if(iv)clearInterval(iv);iv=setInterval(()=>self.postMessage('ping'),15000)}
                else if(e.data==='stop'){if(iv){clearInterval(iv);iv=null}}
            };
        `], { type: 'application/javascript' });
        keepAliveWorker = new Worker(URL.createObjectURL(blob));
        keepAliveWorker.onmessage = (e) => {
            if (e.data === 'ping' && S.ws && S.connected) {
                try { S.ws.send(JSON.stringify({ ping: 1 })); } catch(err) {}
            }
        };
        document.getElementById('workerStatus').textContent = 'Worker: ‚úÖ';
        document.getElementById('workerStatus').style.color = 'var(--green)';
    } catch(e) {
        document.getElementById('workerStatus').textContent = 'Worker: ‚ùå';
        document.getElementById('workerStatus').style.color = 'var(--red)';
    }
}

// ============================================================
// RESILIENCE: Wake Lock API
// ============================================================
let wakeLock = null;
async function acquireWakeLock() {
    try {
        if ('wakeLock' in navigator) {
            wakeLock = await navigator.wakeLock.request('screen');
            wakeLock.addEventListener('release', () => {
                document.getElementById('wakeLockStatus').textContent = 'WakeLock: üîì';
                document.getElementById('wakeLockStatus').style.color = 'var(--yellow)';
            });
            document.getElementById('wakeLockStatus').textContent = 'WakeLock: üîí';
            document.getElementById('wakeLockStatus').style.color = 'var(--green)';
        } else {
            document.getElementById('wakeLockStatus').textContent = 'WakeLock: N/A';
            document.getElementById('wakeLockStatus').style.color = 'var(--muted)';
        }
    } catch(e) {
        document.getElementById('wakeLockStatus').textContent = 'WakeLock: ‚ùå';
        document.getElementById('wakeLockStatus').style.color = 'var(--red)';
    }
}

// ============================================================
// RESILIENCE: IndexedDB auto-save (5min)
// ============================================================
const IDB_NAME = 'DiffersBot_v8';
const IDB_STORE = 'state';
let idbSaveInterval = null;

function openIDB() {
    return new Promise((resolve, reject) => {
        const req = indexedDB.open(IDB_NAME, 1);
        req.onupgradeneeded = (e) => e.target.result.createObjectStore(IDB_STORE);
        req.onsuccess = (e) => resolve(e.target.result);
        req.onerror = (e) => reject(e.target.error);
    });
}

async function saveStateToIDB() {
    try {
        const db = await openIDB();
        const tx = db.transaction(IDB_STORE, 'readwrite');
        tx.objectStore(IDB_STORE).put({
            timestamp: Date.now(),
            totalTrades: S.totalTrades, totalWins: S.totalWins, totalPL: S.totalPL,
            bestStreak: S.bestStreak, currentStreak: S.streak,
            tradeLog: S.session.tradeLog.slice(-100),
            reconnectCount: S.reconnectCount
        }, 'session');
        tx.oncomplete = () => {
            document.getElementById('idbStatus').textContent = 'IDB: ‚úÖ ' + new Date().toLocaleTimeString('en-US', { timeZone: 'America/Toronto', hour: '2-digit', minute: '2-digit' });
            document.getElementById('idbStatus').style.color = 'var(--green)';
        };
        db.close();
    } catch(e) {
        document.getElementById('idbStatus').textContent = 'IDB: ‚ùå';
        document.getElementById('idbStatus').style.color = 'var(--red)';
    }
}

function startIDBAutoSave() {
    if (idbSaveInterval) clearInterval(idbSaveInterval);
    idbSaveInterval = setInterval(saveStateToIDB, 5 * 60 * 1000);
    document.getElementById('idbStatus').textContent = 'IDB: ‚úÖ';
    document.getElementById('idbStatus').style.color = 'var(--green)';
}

// ============================================================
// Init digit grid
// ============================================================
const digitGrid = document.getElementById('digitGrid');
for (let i = 0; i < 10; i++) {
    digitGrid.innerHTML += `<div class="digit-box" id="digit-${i}"><div class="digit-num">${i}</div><div class="digit-pct" id="pct-${i}">--%</div></div>`;
}

// Update config labels
document.getElementById('tradesPerCycle').addEventListener('input', function() {
    document.getElementById('configTradesLabel').textContent = this.value;
});
document.getElementById('cyclesPerSession').addEventListener('input', function() {
    document.getElementById('configCyclesLabel').textContent = this.value;
});

// ============================================================
// STATE
// ============================================================
const S = {
    ws: null, connected: false, ticks: [], pendingContracts: new Map(), pipSize: 2,
    lastPriceDigit: null, consecutiveCount: 1,
    currentTradeDigit: null, currentTradeFreq: null,

    // Bot
    running: false,
    phase: 0, // 0=idle, 1=watching, 2=trading
    currentCycle: 0,
    cycleTradesDone: 0,
    p1SimCount: 0,
    p1LossesCaught: 0,

    // Strategy state
    strat: {
        lastColdest: null, stableSince: null, isStable: false,
        waitingConfirm: false, confirmDigit: null,
        digitCooldowns: {}, digitTradeCount: {}
    },

    // Simulated pending (Phase 1)
    simPending: null, // { digit, freq, time }

    // Session totals
    totalTrades: 0, totalWins: 0, totalPL: 0, streak: 0, bestStreak: 0,
    cycleHistory: [],

    // Connection resilience
    lastTickTime: 0, reconnectCount: 0, reconnectAttempt: 0,
    maxReconnectAttempts: 50, reconnectTimer: null, isReconnecting: false,
    mainPingInterval: null, staleCheckInterval: null, savedToken: null,

    session: { startTime: null, tickLog: [], tradeLog: [], totalTicks: 0 },
    activityLog: []
};

// ============================================================
// HELPERS
// ============================================================
function extractDigit(q, p) { return Math.round(q * Math.pow(10, p)) % 10; }

function log(msg, type = '') {
    const el = document.getElementById('log');
    const time = new Date().toLocaleTimeString('en-US', { timeZone: 'America/Toronto' });
    S.activityLog.push({ time: new Date().toLocaleString('en-US', { timeZone: 'America/Toronto' }), message: msg, type });
    if (S.activityLog.length > 5000) S.activityLog.shift();
    el.innerHTML = `<div class="${type}">[${time}] ${msg}</div>` + el.innerHTML;
    if (el.children.length > 100) el.removeChild(el.lastChild);
}

function getTimestamp() { return new Date().toLocaleString('en-US', { timeZone: 'America/Toronto' }); }

function updateTorontoTime() {
    document.getElementById('torontoTime').textContent = new Date().toLocaleString('en-US', { timeZone: 'America/Toronto', hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }) + ' EST';
}
setInterval(updateTorontoTime, 1000);

// ============================================================
// RESILIENCE: Stale detection (45s)
// ============================================================
function startStaleDetection() {
    if (S.staleCheckInterval) clearInterval(S.staleCheckInterval);
    S.staleCheckInterval = setInterval(() => {
        if (!S.connected || !S.lastTickTime) return;
        const elapsed = Date.now() - S.lastTickTime;
        if (elapsed > 45000) {
            document.getElementById('staleBadge').style.display = 'inline';
            log(`‚ö†Ô∏è STALE: No data ${Math.round(elapsed/1000)}s ‚Äî reconnecting`, 'alert');
            forceReconnect();
        } else {
            document.getElementById('staleBadge').style.display = 'none';
        }
    }, 5000);
}

// ============================================================
// RESILIENCE: Auto-reconnect (exponential backoff)
// ============================================================
function getReconnectDelay() { return Math.min(2000 * Math.pow(2, S.reconnectAttempt), 30000); }

function forceReconnect() {
    if (S.isReconnecting) return;
    S.isReconnecting = true;
    try { if (S.ws) { S.ws.onclose = null; S.ws.close(); } } catch(e) {}
    S.ws = null; S.connected = false;
    document.getElementById('dot').classList.remove('on');
    document.getElementById('status').textContent = 'Reconnecting...';
    attemptReconnect();
}

function attemptReconnect() {
    if (S.reconnectAttempt >= S.maxReconnectAttempts) {
        log(`‚ùå Max reconnect attempts reached`, 'loss');
        S.isReconnecting = false;
        document.getElementById('status').textContent = 'Failed';
        return;
    }
    const delay = getReconnectDelay();
    log(`üîÑ Reconnect ${S.reconnectAttempt + 1}/${S.maxReconnectAttempts} in ${delay/1000}s`, 'alert');

    S.reconnectTimer = setTimeout(() => {
        if (!S.savedToken) { S.isReconnecting = false; return; }
        try {
            S.ws = new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=1089');
            S.ws.onopen = () => { S.ws.send(JSON.stringify({ authorize: S.savedToken })); };
            S.ws.onmessage = handleMessage;
            S.ws.onclose = () => {
                S.connected = false;
                document.getElementById('dot').classList.remove('on');
                if (S.running) { S.reconnectAttempt++; S.isReconnecting = true; attemptReconnect(); }
            };
            S.ws.onerror = () => { S.reconnectAttempt++; attemptReconnect(); };
        } catch(e) { S.reconnectAttempt++; attemptReconnect(); }
    }, delay);
}

function updateReconnectBadge() {
    const b = document.getElementById('reconnectBadge');
    if (S.reconnectCount > 0) { b.style.display = 'inline'; b.textContent = `üîÑ ${S.reconnectCount}`; }
    else b.style.display = 'none';
}

// RESILIENCE: Main thread ping (20s)
function startMainPing() {
    if (S.mainPingInterval) clearInterval(S.mainPingInterval);
    S.mainPingInterval = setInterval(() => {
        if (S.ws && S.connected && S.ws.readyState === WebSocket.OPEN) {
            try { S.ws.send(JSON.stringify({ ping: 1 })); } catch(e) {}
        }
    }, 20000);
}

// RESILIENCE: Visibility API
document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
        if (S.running) acquireWakeLock();
        if (S.connected && S.lastTickTime && Date.now() - S.lastTickTime > 30000) {
            log('‚ö†Ô∏è Stale on refocus ‚Äî reconnecting', 'alert');
            forceReconnect();
        } else if (!S.connected && S.running) {
            forceReconnect();
        }
    } else {
        if (S.running && document.getElementById('backgroundMode').checked && audioContext && audioContext.state === 'suspended') audioContext.resume();
    }
});

// ============================================================
// CONNECTION
// ============================================================
function handleMessage(msg) {
    const data = JSON.parse(msg.data);
    if (data.error) { log(`Error: ${data.error.message}`, 'loss'); return; }

    if (data.authorize) {
        S.connected = true;
        S.isReconnecting = false;
        S.reconnectAttempt = 0;
        if (S.reconnectCount > 0 || S.savedToken) S.reconnectCount++;
        document.getElementById('dot').classList.add('on');
        document.getElementById('status').textContent = 'Online';
        document.getElementById('balance').textContent = '$' + parseFloat(data.authorize.balance).toFixed(2);
        document.getElementById('balanceDisplay').textContent = '$' + parseFloat(data.authorize.balance).toFixed(2);
        document.getElementById('staleBadge').style.display = 'none';
        updateReconnectBadge();
        if (S.reconnectCount > 1) log(`‚úÖ Re-authorized (#${S.reconnectCount})`, 'win');
        else log('‚úÖ Authorized', 'win');
        S.ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
        subscribeTicks();
        for (const [cid] of S.pendingContracts) S.ws.send(JSON.stringify({ proposal_open_contract: 1, contract_id: cid, subscribe: 1 }));
    }
    if (data.balance) {
        document.getElementById('balance').textContent = '$' + parseFloat(data.balance.balance).toFixed(2);
        document.getElementById('balanceDisplay').textContent = '$' + parseFloat(data.balance.balance).toFixed(2);
    }
    if (data.tick) processTick(data.tick);
    if (data.buy) {
        S.pendingContracts.set(data.buy.contract_id, { digit: S.currentTradeDigit, stake: parseFloat(document.getElementById('stake').value), freq: S.currentTradeFreq });
        S.ws.send(JSON.stringify({ proposal_open_contract: 1, contract_id: data.buy.contract_id, subscribe: 1 }));
    }
    if (data.proposal_open_contract?.status === 'won' || data.proposal_open_contract?.status === 'lost') processTradeResult(data.proposal_open_contract);
}

function connect() {
    const token = document.getElementById('token').value;
    if (!token) return log('Enter API token', 'loss');
    S.savedToken = token;
    S.reconnectCount = 0;
    S.ws = new WebSocket('wss://ws.binaryws.com/websockets/v3?app_id=1089');
    S.ws.onopen = () => { log('üîå Connected', 'info'); S.ws.send(JSON.stringify({ authorize: token })); };
    S.ws.onmessage = handleMessage;
    S.ws.onclose = () => {
        S.connected = false;
        document.getElementById('dot').classList.remove('on');
        document.getElementById('status').textContent = 'Disconnected';
        if (S.running) { log('‚ö†Ô∏è Lost connection ‚Äî auto-reconnecting', 'alert'); S.reconnectAttempt = 0; S.isReconnecting = true; attemptReconnect(); }
        else log('Disconnected', 'loss');
    };
    S.ws.onerror = () => log('‚ö†Ô∏è WebSocket error', 'loss');
    if (keepAliveWorker) keepAliveWorker.postMessage('start');
    startMainPing(); startStaleDetection(); startIDBAutoSave(); acquireWakeLock();
}

function subscribeTicks() {
    S.ws.send(JSON.stringify({ ticks: document.getElementById('symbol').value, subscribe: 1 }));
    document.getElementById('currentMarket').textContent = document.getElementById('symbol').value;
}

function changePair() {
    if (S.connected) { S.ws.send(JSON.stringify({ forget_all: 'ticks' })); S.ticks = []; subscribeTicks(); }
}

// ============================================================
// TICK PROCESSING
// ============================================================
function processTick(tick) {
    const price = tick.quote;
    const digit = extractDigit(price, S.pipSize);
    const ticksToAnalyze = parseInt(document.getElementById('ticksToAnalyze').value) || 100;

    S.lastTickTime = Date.now();
    S.ticks.push({ price, digit, time: Date.now() });
    if (S.ticks.length > ticksToAnalyze + 50) S.ticks.shift();

    document.getElementById('priceDisplay').textContent = price.toFixed(5);
    document.getElementById('lastDigitDisplay').textContent = digit;
    document.getElementById('tickCount').textContent = Math.min(S.ticks.length, ticksToAnalyze) + ' ticks';

    const isDouble = (digit === S.lastPriceDigit);
    S.consecutiveCount = isDouble ? S.consecutiveCount + 1 : 1;

    updateDigitDisplay(digit, isDouble, S.consecutiveCount === 3);

    const recent = S.ticks.slice(-ticksToAnalyze);
    if (recent.length >= ticksToAnalyze) {
        const counts = [0,0,0,0,0,0,0,0,0,0];
        recent.forEach(t => counts[t.digit]++);
        const freqs = counts.map(c => (c / ticksToAnalyze) * 100);
        updateDigitFrequencies(freqs);
        recordTick(price, digit, freqs, isDouble);

        if (S.running && S.phase > 0) processStrategy(digit, freqs);
    }

    S.lastPriceDigit = digit;
}

function updateDigitDisplay(currentDigit, isDouble, isTriple) {
    for (let i = 0; i < 10; i++) document.getElementById(`digit-${i}`).classList.remove('just-occurred', 'doubled', 'tripled', 'coldest');
    document.getElementById(`digit-${currentDigit}`).classList.add(isTriple ? 'tripled' : (isDouble ? 'doubled' : 'just-occurred'));
}

function updateDigitFrequencies(freqs) {
    const minFreq = Math.min(...freqs);
    for (let i = 0; i < 10; i++) {
        const el = document.getElementById(`pct-${i}`);
        el.textContent = freqs[i].toFixed(1) + '%';
        el.className = 'digit-pct' + (freqs[i] === minFreq ? ' cold' : '');
        if (freqs[i] === minFreq) document.getElementById(`digit-${i}`).classList.add('coldest');
    }
}

function recordTick(price, digit, freqs, isDouble) {
    if (!S.session.startTime) S.session.startTime = Date.now();
    S.session.totalTicks++;
    S.session.tickLog.push({
        timestamp: getTimestamp(), market: document.getElementById('symbol').value, price, digit,
        freq_0: freqs[0].toFixed(1), freq_1: freqs[1].toFixed(1), freq_2: freqs[2].toFixed(1),
        freq_3: freqs[3].toFixed(1), freq_4: freqs[4].toFixed(1), freq_5: freqs[5].toFixed(1),
        freq_6: freqs[6].toFixed(1), freq_7: freqs[7].toFixed(1), freq_8: freqs[8].toFixed(1),
        freq_9: freqs[9].toFixed(1),
        coldest: freqs.indexOf(Math.min(...freqs)), coldest_freq: Math.min(...freqs).toFixed(1),
        is_double: isDouble ? 'Yes' : 'No', phase: S.phase
    });
    if (S.session.tickLog.length > 50000) S.session.tickLog = S.session.tickLog.slice(-40000);
    document.getElementById('ticksRecorded').textContent = S.session.tickLog.length;
    if (S.session.startTime) {
        const d = Math.floor((Date.now() - S.session.startTime) / 1000);
        document.getElementById('sessionDuration').textContent = `${Math.floor(d/60)}:${(d%60).toString().padStart(2,'0')}`;
    }
}

// ============================================================
// STRATEGY: Coldest + Confirm (used in both phases)
// ============================================================
function processStrategy(digit, freqs) {
    const ct = parseFloat(document.getElementById('coldThreshold').value) || 6;
    const ss = parseFloat(document.getElementById('stability').value) || 3;
    const digitCooldown = parseInt(document.getElementById('digitCooldown').value) || 10;
    const maxPerDigit = parseInt(document.getElementById('maxPerDigit').value) || 2;
    const now = Date.now();
    const st = S.strat;

    // Resolve pending simulated trade (Phase 1)
    if (S.simPending) {
        const won = digit !== S.simPending.digit;
        if (!won) {
            // LOSS detected in Phase 1 ‚Äî transition to Phase 2!
            S.p1LossesCaught++;
            log(`‚ùåüëª P1 Shadow LOSS on D${S.simPending.digit} ‚Äî PHASE 2 ACTIVATED!`, 'phase');
            S.phase = 2;
            updatePhaseBanner();
        } else {
            log(`‚úÖüëª P1 Shadow win D${S.simPending.digit}`, 'info');
        }
        addTradeToUI(S.simPending.digit, S.simPending.freq, won, won ? 0.965 : -10, true);
        S.simPending = null;
        S.p1SimCount++;
        document.getElementById('p1SimCount').textContent = S.p1SimCount;
        updateProgressUI();
        if (S.phase === 2) return; // Don't process further this tick after transition
    }

    const coldest = freqs.indexOf(Math.min(...freqs));
    const coldFreq = freqs[coldest];

    if (coldFreq > ct) { st.stableSince = null; st.isStable = false; st.waitingConfirm = false; return; }

    if (coldest !== st.lastColdest) { st.stableSince = Date.now(); st.isStable = false; }
    else if (st.stableSince) st.isStable = (Date.now() - st.stableSince) / 1000 >= ss;
    st.lastColdest = coldest;

    if (st.waitingConfirm) {
        if (digit !== st.confirmDigit) {
            const cd = st.confirmDigit;

            if (S.phase === 1) {
                // Phase 1: No filters ‚Äî just shadow trade everything
                log(`üëª P1 Shadow: DIFFERS D${cd} (${freqs[cd].toFixed(1)}%)`, 'alert');
                S.simPending = { digit: cd, freq: freqs[cd].toFixed(1), time: getTimestamp() };
            } else if (S.phase === 2) {
                // Phase 2: Apply cooldown + max per digit
                if (st.digitCooldowns[cd] && now < st.digitCooldowns[cd]) {
                    log(`‚è≥ D${cd} cooldown (${Math.ceil((st.digitCooldowns[cd]-now)/1000)}s)`, 'info');
                    st.waitingConfirm = false; st.confirmDigit = null; return;
                }
                const dc = st.digitTradeCount[cd] || 0;
                if (dc >= maxPerDigit) {
                    log(`üö´ D${cd} max trades (${dc}/${maxPerDigit})`, 'info');
                    st.waitingConfirm = false; st.confirmDigit = null; return;
                }
                log(`üîî P2 REAL: DIFFERS D${cd} (${freqs[cd].toFixed(1)}%)`, 'trade');
                placeTrade(cd, freqs[cd]);
                st.digitCooldowns[cd] = now + (digitCooldown * 1000);
                st.digitTradeCount[cd] = dc + 1;
            }
        } else {
            log(`‚ö†Ô∏è D${digit} doubled ‚Äî cancel`, 'alert');
        }
        st.waitingConfirm = false; st.confirmDigit = null;
        return;
    }

    if (st.isStable && digit === coldest) {
        st.waitingConfirm = true;
        st.confirmDigit = coldest;
        log(`üëÜ Tap D${coldest} (${coldFreq.toFixed(1)}%) ‚Äî awaiting confirm`, 'info');
    }
}

// ============================================================
// TRADE EXECUTION
// ============================================================
function placeTrade(digit, freq) {
    const stake = parseFloat(document.getElementById('stake').value) || 10;
    S.currentTradeDigit = digit;
    S.currentTradeFreq = freq;

    let count = 1;
    if (document.getElementById('rapidFire').checked) count = parseInt(document.getElementById('rapidCount').value) || 2;

    for (let i = 0; i < count; i++) {
        S.ws.send(JSON.stringify({
            buy: 1, price: stake,
            parameters: { amount: stake, basis: 'stake', contract_type: 'DIGITDIFF', currency: 'USD', duration: 1, duration_unit: 't', symbol: document.getElementById('symbol').value, barrier: digit.toString() }
        }));
    }

    if (count > 1) log(`üì§ üî• RAPID ${count}x DIFFERS D${digit} @ $${stake}`, 'trade');
    else log(`üì§ DIFFERS D${digit} @ $${stake}`, 'trade');
}

function processTradeResult(contract) {
    const info = S.pendingContracts.get(contract.contract_id);
    if (!info) return;
    S.pendingContracts.delete(contract.contract_id);

    const won = contract.status === 'won';
    const profit = parseFloat(contract.profit) || (won ? info.stake * 0.09649 : -info.stake);

    S.totalTrades++;
    if (won) { S.totalWins++; S.streak++; } else S.streak = 0;
    S.bestStreak = Math.max(S.bestStreak, S.streak);
    S.totalPL += profit;
    S.cycleTradesDone++;

    log(`${won ? '‚úÖ' : '‚ùå'} P2: D${info.digit} ${won ? 'WIN' : 'LOSS'} $${profit.toFixed(2)}`, won ? 'win' : 'loss');

    S.session.tradeLog.push({ time: getTimestamp(), market: document.getElementById('symbol').value, phase: 2, digit: info.digit, freq: info.freq, result: won ? 'WIN' : 'LOSS', profit, streak: S.streak, cycle: S.currentCycle });

    addTradeToUI(info.digit, info.freq, won, profit, false);
    updateStats();
    updateProgressUI();
    document.getElementById('p2RealCount').textContent = S.cycleTradesDone;

    // Check if cycle is done
    const tpc = parseInt(document.getElementById('tradesPerCycle').value) || 12;
    if (S.cycleTradesDone >= tpc) {
        completeCycle();
    }
}

// ============================================================
// CYCLE & SESSION MANAGEMENT
// ============================================================
function startBot() {
    if (!S.connected) return log('Connect first!', 'loss');
    const ticksNeeded = parseInt(document.getElementById('ticksToAnalyze').value) || 100;
    if (S.ticks.length < ticksNeeded) return log(`Need ${ticksNeeded} ticks (have ${S.ticks.length})`, 'loss');

    S.running = true;
    S.currentCycle = 1;
    S.totalTrades = 0; S.totalWins = 0; S.totalPL = 0; S.streak = 0; S.bestStreak = 0;
    S.p1LossesCaught = 0; S.cycleHistory = [];
    S.session.startTime = Date.now(); S.session.tradeLog = []; S.session.totalTicks = 0;
    document.getElementById('startBotBtn').disabled = true;
    document.getElementById('progressCard').style.display = 'block';
    document.getElementById('tradeLog').innerHTML = '';

    startCycle();
    startBackgroundMode();
    log('üöÄ Bot started', 'phase');
}

function stopBot() {
    S.running = false;
    S.phase = 0;
    S.simPending = null;
    document.getElementById('startBotBtn').disabled = false;
    updatePhaseBanner();
    stopBackgroundMode();
    saveStateToIDB();
    if (S.reconnectTimer) { clearTimeout(S.reconnectTimer); S.reconnectTimer = null; }
    S.isReconnecting = false;
    log('‚èπ Bot stopped', 'info');
}

function startCycle() {
    const maxCycles = parseInt(document.getElementById('cyclesPerSession').value) || 2;
    S.phase = 1;
    S.cycleTradesDone = 0;
    S.p1SimCount = 0;
    S.simPending = null;
    resetStratState();

    log(`üîÑ CYCLE ${S.currentCycle}/${maxCycles} ‚Äî Phase 1: Watching for loss...`, 'phase');
    updatePhaseBanner();
    updateProgressUI();
    document.getElementById('p1SimCount').textContent = '0';
    document.getElementById('p2RealCount').textContent = '0';
}

function completeCycle() {
    const tpc = parseInt(document.getElementById('tradesPerCycle').value) || 12;
    const maxCycles = parseInt(document.getElementById('cyclesPerSession').value) || 2;
    const wins = S.session.tradeLog.filter(t => t.cycle === S.currentCycle && t.result === 'WIN').length;
    const losses = S.cycleTradesDone - wins;
    const pl = S.session.tradeLog.filter(t => t.cycle === S.currentCycle).reduce((s, t) => s + t.profit, 0);

    S.cycleHistory.push({ cycle: S.currentCycle, trades: S.cycleTradesDone, wins, losses, pl, p1Sims: S.p1SimCount });

    log(`‚úÖ CYCLE ${S.currentCycle} DONE: ${wins}W/${losses}L = $${pl.toFixed(2)}`, 'phase');
    updateCycleHistoryUI();

    if (S.currentCycle >= maxCycles) {
        // Session complete
        S.phase = 0;
        S.running = false;
        document.getElementById('startBotBtn').disabled = false;
        updatePhaseBanner();
        saveStateToIDB();
        log(`üèÅ SESSION COMPLETE: ${S.totalTrades} trades, ${S.totalWins}W, $${S.totalPL.toFixed(2)}`, 'phase');
    } else {
        S.currentCycle++;
        startCycle();
    }
}

function resetStratState() {
    S.strat = {
        lastColdest: null, stableSince: null, isStable: false,
        waitingConfirm: false, confirmDigit: null,
        digitCooldowns: {}, digitTradeCount: {}
    };
}

// ============================================================
// UI UPDATES
// ============================================================
function updatePhaseBanner() {
    const b = document.getElementById('phaseBanner');
    const maxCycles = parseInt(document.getElementById('cyclesPerSession').value) || 2;
    if (S.phase === 0 && !S.running) {
        if (S.cycleHistory.length > 0 && S.currentCycle >= maxCycles) {
            b.className = 'phase-banner session-done';
            b.innerHTML = `üèÅ SESSION COMPLETE ‚Äî ${S.totalTrades} trades, $${S.totalPL.toFixed(2)}`;
        } else {
            b.className = 'phase-banner idle';
            b.innerHTML = '‚èπ Connect and click START';
        }
    } else if (S.phase === 1) {
        b.className = 'phase-banner phase1';
        b.innerHTML = `üëÅÔ∏è PHASE 1 ‚Äî WATCHING (Cycle ${S.currentCycle}/${maxCycles})<br><span style="font-size:10px">Shadow-trading until a loss is detected...</span>`;
        document.getElementById('currentPhase').textContent = 'üëÅÔ∏è P1';
        document.getElementById('currentPhase').style.color = 'var(--yellow)';
    } else if (S.phase === 2) {
        b.className = 'phase-banner phase2';
        b.innerHTML = `üéØ PHASE 2 ‚Äî TRADING LIVE (Cycle ${S.currentCycle}/${maxCycles})<br><span style="font-size:10px">Loss caught! Taking real trades...</span>`;
        document.getElementById('currentPhase').textContent = 'üéØ P2';
        document.getElementById('currentPhase').style.color = 'var(--green)';
    }
}

function updateProgressUI() {
    const tpc = parseInt(document.getElementById('tradesPerCycle').value) || 12;
    const maxCycles = parseInt(document.getElementById('cyclesPerSession').value) || 2;

    document.getElementById('currentCycle').textContent = `${S.currentCycle}/${maxCycles}`;
    document.getElementById('cycleTradeCount').textContent = `${S.cycleTradesDone}/${tpc}`;

    // P1 bar: pulses while active, fills to 100% on loss found
    if (S.phase === 1) {
        document.getElementById('p1Bar').style.width = Math.min(100, S.p1SimCount * 10) + '%';
        document.getElementById('p1Status').textContent = `Watching... (${S.p1SimCount} shadow trades)`;
        document.getElementById('p2Status').textContent = 'Waiting for Phase 1...';
        document.getElementById('p2Bar').style.width = '0%';
    } else if (S.phase === 2) {
        document.getElementById('p1Bar').style.width = '100%';
        document.getElementById('p1Status').textContent = `‚úÖ Loss caught after ${S.p1SimCount} shadows`;
        document.getElementById('p2Status').textContent = `${S.cycleTradesDone}/${tpc} trades`;
        document.getElementById('p2Bar').style.width = (S.cycleTradesDone / tpc * 100) + '%';
    }

    document.getElementById('p1LossesCaught').textContent = S.p1LossesCaught;
}

function updateStats() {
    document.getElementById('totalTrades').textContent = S.totalTrades;
    document.getElementById('totalWins').textContent = S.totalWins;
    document.getElementById('winRate').textContent = S.totalTrades ? (S.totalWins / S.totalTrades * 100).toFixed(1) + '%' : '0%';
    document.getElementById('totalPL').textContent = '$' + S.totalPL.toFixed(2);
    document.getElementById('totalPL').className = 'stat-val ' + (S.totalPL >= 0 ? 'pos' : 'neg');
    document.getElementById('currentStreak').textContent = S.streak;
    document.getElementById('bestStreak').textContent = S.bestStreak;
}

function addTradeToUI(digit, freq, won, profit, isSim) {
    const c = document.getElementById('tradeLog');
    if (c.querySelector('.text-center, [style*="text-align:center"]')) c.innerHTML = '';
    const label = isSim ? 'üëªP1' : 'üéØP2';
    c.innerHTML = `<div class="trade-row ${won ? 'win' : 'loss'} ${isSim ? 'sim' : ''}"><span>${label}|D${digit} (${freq}%)</span><span>${won ? 'WIN' : 'LOSS'} ${isSim ? '(sim)' : '$' + profit.toFixed(2)}</span></div>` + c.innerHTML;
    if (!isSim) document.getElementById('realTradeCount').textContent = S.totalTrades + ' real';
}

function updateCycleHistoryUI() {
    const el = document.getElementById('cycleHistory');
    el.innerHTML = S.cycleHistory.map(c => {
        const color = c.pl >= 0 ? 'var(--green)' : 'var(--red)';
        return `<div style="background:var(--bg);padding:6px;border-radius:4px;margin-bottom:4px;display:flex;justify-content:space-between;align-items:center">
            <span>Cycle ${c.cycle}: ${c.wins}W/${c.losses}L</span>
            <span style="color:${color};font-weight:700">$${c.pl.toFixed(2)}</span>
            <span style="font-size:8px;color:var(--yellow)">${c.p1Sims} shadows</span>
        </div>`;
    }).join('');
}

// ============================================================
// BACKGROUND MODE
// ============================================================
let audioContext = null, silentOscillator = null, silentGain = null, bgInterval = null;
function startBackgroundMode() {
    if (!document.getElementById('backgroundMode').checked) return;
    try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        silentOscillator = audioContext.createOscillator(); silentOscillator.frequency.value = 1;
        silentGain = audioContext.createGain(); silentGain.gain.value = 0.001;
        silentOscillator.connect(silentGain); silentGain.connect(audioContext.destination);
        silentOscillator.start();
        bgInterval = setInterval(() => {
            if (audioContext?.state === 'suspended') audioContext.resume();
            if (silentGain) { silentGain.gain.setValueAtTime(0.002, audioContext.currentTime); silentGain.gain.setValueAtTime(0.001, audioContext.currentTime + 0.1); }
        }, 10000);
        document.getElementById('backgroundStatus').style.display = 'block';
        log('üì± Background mode on', 'info');
    } catch(e) { log('‚ö†Ô∏è Background mode failed', 'alert'); }
}
function stopBackgroundMode() {
    try {
        if (silentOscillator) { silentOscillator.stop(); silentOscillator.disconnect(); silentOscillator = null; }
        if (silentGain) { silentGain.disconnect(); silentGain = null; }
        if (audioContext) { audioContext.close(); audioContext = null; }
        if (bgInterval) { clearInterval(bgInterval); bgInterval = null; }
        document.getElementById('backgroundStatus').style.display = 'none';
    } catch(e) {}
}
document.getElementById('backgroundMode').addEventListener('change', function() {
    if (this.checked && S.running) startBackgroundMode(); else stopBackgroundMode();
});

// ============================================================
// CSV EXPORT
// ============================================================
function downloadTickData() {
    if (!S.session.tickLog.length) return log('No data', 'loss');
    const h = Object.keys(S.session.tickLog[0]);
    download([h.join(','), ...S.session.tickLog.map(r => h.map(k => r[k]).join(','))].join('\n'), `ticks_${ts()}.csv`, 'text/csv');
}
function downloadTradeLog() {
    if (!S.session.tradeLog.length) return log('No trades', 'loss');
    const h = Object.keys(S.session.tradeLog[0]);
    download([h.join(','), ...S.session.tradeLog.map(r => h.map(k => r[k]).join(','))].join('\n'), `trades_${ts()}.csv`, 'text/csv');
}
function downloadActivityLog() {
    if (!S.activityLog.length) return log('No log', 'loss');
    download(S.activityLog.map(e => `[${e.time}] ${e.message}`).join('\n'), `activity_${ts()}.txt`, 'text/plain');
}
function download(c, f, t) { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([c], { type: t })); a.download = f; a.click(); }
function ts() { return new Date().toISOString().slice(0,19).replace(/[:-]/g,'').replace('T','_'); }

// ============================================================
// INIT
// ============================================================
initKeepAliveWorker();
log('üéØ DIFFERS Bot v8 ‚Äî Phase Sniper loaded', 'info');
log('üîß Resilience: Worker ‚úì WakeLock ‚úì Stale ‚úì Reconnect ‚úì IDB ‚úì', 'info');
log('üìã Phase 1: Watch ‚Üí Phase 2: Trade after loss', 'info');
</script>
</body>
</html>
