<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéØ Post-Quad Sniper v1</title>
    <style>
        :root{--bg:#060a10;--card:#0e1219;--card2:#141b24;--border:#1c2638;--text:#c8d0dc;--dim:#4e5a6e;--green:#22d68a;--red:#f04858;--cyan:#18c8e8;--yellow:#f0b020;--purple:#a060f8;--orange:#f07830;--green-bg:rgba(34,214,138,0.08);--red-bg:rgba(240,72,88,0.08);--cyan-bg:rgba(24,200,232,0.06);--purple-bg:rgba(160,96,248,0.06);--yellow-bg:rgba(240,176,32,0.06)}
        *{margin:0;padding:0;box-sizing:border-box}
        body{font-family:system-ui,-apple-system,sans-serif;background:var(--bg);color:var(--text);padding:10px;font-size:13px}
        .container{max-width:920px;margin:0 auto}

        /* Header */
        .header{text-align:center;padding:18px;border-bottom:3px solid var(--purple);margin-bottom:15px;position:relative}
        .header h1{font-size:24px;color:#fff;letter-spacing:-0.5px;margin-bottom:2px}
        .header h1 span{color:var(--purple)}
        .header .subtitle{color:var(--dim);font-size:11px;font-family:monospace;letter-spacing:0.5px}

        /* Phase Banner */
        .phase-banner{padding:22px;border-radius:12px;text-align:center;margin-bottom:15px;transition:all 0.4s;position:relative;overflow:hidden}
        .phase-banner::before{content:'';position:absolute;top:0;left:0;right:0;bottom:0;opacity:0.04;pointer-events:none}
        .phase-banner.waiting{background:var(--card);border:2px solid var(--border)}
        .phase-banner.quad-seen{background:linear-gradient(135deg,rgba(240,72,88,0.12),rgba(240,120,48,0.08));border:2px solid var(--red);animation:quadPulse 1.5s ease-in-out 3}
        .phase-banner.sniping{background:linear-gradient(135deg,rgba(34,214,138,0.12),rgba(24,200,232,0.06));border:2px solid var(--green);animation:snipePulse 1.5s infinite}
        .phase-banner.cooldown{background:linear-gradient(135deg,rgba(24,200,232,0.1),rgba(160,96,248,0.06));border:2px solid var(--cyan)}
        .phase-banner.stopped{background:var(--card);border:2px solid var(--border)}
        .phase-banner.session-limit{background:linear-gradient(135deg,rgba(240,176,32,0.1),rgba(240,120,48,0.06));border:2px solid var(--yellow)}

        @keyframes quadPulse{0%,100%{box-shadow:0 0 0 rgba(240,72,88,0)}50%{box-shadow:0 0 40px rgba(240,72,88,0.3)}}
        @keyframes snipePulse{0%,100%{box-shadow:0 0 0 rgba(34,214,138,0)}50%{box-shadow:0 0 30px rgba(34,214,138,0.2)}}

        .phase-icon{font-size:42px;margin-bottom:6px}
        .phase-title{font-size:20px;font-weight:700;margin-bottom:4px;letter-spacing:-0.3px}
        .phase-sub{font-size:12px;color:var(--dim)}
        .phase-timer{font-family:monospace;font-size:32px;font-weight:700;margin-top:10px;color:var(--cyan);letter-spacing:2px}

        /* Tick Window Bar */
        .tick-window{margin-top:14px}
        .tick-window .tw-label{display:flex;justify-content:space-between;font-size:11px;color:var(--dim);margin-bottom:4px}
        .tick-window .tw-bar{height:10px;background:var(--border);border-radius:5px;overflow:hidden;position:relative}
        .tick-window .tw-fill{height:100%;border-radius:5px;transition:width 0.3s}
        .tick-window .tw-fill.safe{background:linear-gradient(90deg,var(--green),var(--cyan))}
        .tick-window .tw-fill.warning{background:linear-gradient(90deg,var(--yellow),var(--orange))}
        .tick-window .tw-fill.danger{background:linear-gradient(90deg,var(--orange),var(--red))}

        /* Status Bar */
        .status-bar{display:flex;justify-content:center;align-items:center;gap:12px;padding:12px;background:var(--card);border-radius:10px;margin-bottom:15px;flex-wrap:wrap;border:1px solid var(--border)}
        .status-item{text-align:center;min-width:65px}
        .status-item .label{font-size:9px;color:var(--dim);text-transform:uppercase;letter-spacing:0.5px}
        .status-item .value{font-size:14px;font-weight:700;font-family:monospace}
        .dot{width:9px;height:9px;border-radius:50%;background:var(--dim);display:inline-block;transition:all 0.3s}
        .dot.on{background:var(--green);box-shadow:0 0 10px var(--green)}

        /* Cards */
        .card{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:12px}
        .card h3{font-size:10px;color:var(--dim);margin-bottom:10px;text-transform:uppercase;letter-spacing:1.5px;font-weight:600}
        .card.highlight{border:2px solid var(--purple);background:rgba(160,96,248,0.04)}

        /* Grids */
        .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
        .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
        .row4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px}

        label{display:block;font-size:10px;color:var(--dim);margin-bottom:3px}
        input,select{width:100%;padding:8px 10px;background:var(--bg);border:1px solid var(--border);border-radius:6px;color:var(--text);font-size:12px;font-family:monospace;transition:border 0.2s}
        input:focus,select:focus{outline:none;border-color:var(--purple)}

        /* Buttons */
        button{padding:12px 16px;border:none;border-radius:8px;font-weight:700;cursor:pointer;font-size:11px;text-transform:uppercase;letter-spacing:0.5px;transition:all 0.2s}
        button:hover{transform:translateY(-1px)}
        button:active{transform:translateY(0)}
        button:disabled{opacity:0.4;cursor:not-allowed;transform:none}
        .btn-connect{background:linear-gradient(135deg,#6366f1,#8b5cf6);color:white;width:100%}
        .btn-green{background:var(--green);color:#000}
        .btn-red{background:var(--red);color:white}
        .btn-purple{background:var(--purple);color:white}
        .btn-yellow{background:var(--yellow);color:#000}
        .btn-orange{background:var(--orange);color:white}
        .btn-outline{background:transparent;border:1px solid var(--border);color:var(--dim)}
        .btn-outline:hover{border-color:var(--text);color:var(--text)}

        /* Sniper Stats */
        .sniper-stats{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;margin-bottom:15px}
        .sniper-stat{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center}
        .sniper-stat .val{font-size:22px;font-weight:700;font-family:monospace}
        .sniper-stat .val.green{color:var(--green)}
        .sniper-stat .val.red{color:var(--red)}
        .sniper-stat .val.cyan{color:var(--cyan)}
        .sniper-stat .val.yellow{color:var(--yellow)}
        .sniper-stat .val.purple{color:var(--purple)}
        .sniper-stat .lbl{font-size:9px;color:var(--dim);text-transform:uppercase;margin-top:4px;letter-spacing:0.5px}

        /* Digit Display */
        .digit-display{text-align:center;padding:16px;background:var(--bg);border-radius:10px;margin:10px 0}
        .current-digit{font-size:56px;font-weight:900;line-height:1;transition:all 0.15s}
        .streak-indicator{font-size:16px;margin-top:8px;font-weight:600}
        .streak-indicator.triple{color:var(--purple);animation:pulse 0.5s infinite}
        .streak-indicator.quad{color:var(--red);animation:pulse 0.3s infinite}
        @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.08)}}

        /* Digit Grid */
        .digit-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:5px;margin:10px 0}
        .digit-box{background:var(--bg);border:2px solid var(--border);border-radius:7px;padding:8px 4px;text-align:center;transition:all 0.2s}
        .digit-box.active{border-color:var(--yellow);background:rgba(240,176,32,0.1)}
        .digit-box.tripled{border-color:var(--purple);background:rgba(160,96,248,0.2);animation:glow 0.5s infinite}
        .digit-box.quad-glow{border-color:var(--red);background:rgba(240,72,88,0.3);animation:quadGlow 0.4s infinite}
        @keyframes glow{0%,100%{box-shadow:0 0 4px var(--purple)}50%{box-shadow:0 0 16px var(--purple)}}
        @keyframes quadGlow{0%,100%{box-shadow:0 0 4px var(--red)}50%{box-shadow:0 0 20px var(--red)}}
        .digit-num{font-size:17px;font-weight:700}
        .digit-freq{font-size:9px;color:var(--dim)}

        /* Session Tracker */
        .session-tracker{display:flex;align-items:center;gap:10px;padding:10px 14px;background:var(--card2);border-radius:8px;margin-bottom:15px;border:1px solid var(--border)}
        .session-tracker .st-label{font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:1px}
        .session-dots{display:flex;gap:8px}
        .session-dot{width:28px;height:28px;border-radius:50%;background:var(--border);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:var(--dim);transition:all 0.3s}
        .session-dot.active{background:var(--green);color:#000;box-shadow:0 0 12px rgba(34,214,138,0.4)}
        .session-dot.used{background:var(--purple);color:#fff}
        .session-dot.locked{background:var(--red-bg);border:1px solid var(--red);color:var(--red)}

        /* Trade Log */
        .trade-log{max-height:220px;overflow-y:auto;background:var(--bg);border-radius:8px;padding:8px}
        .trade-entry{display:flex;justify-content:space-between;padding:8px 10px;margin-bottom:3px;border-radius:6px;font-size:11px;border-left:4px solid var(--border);font-family:monospace}
        .trade-entry.win{border-left-color:var(--green);background:rgba(34,214,138,0.06)}
        .trade-entry.loss{border-left-color:var(--red);background:rgba(240,72,88,0.06)}
        .trade-entry.skip{border-left-color:var(--yellow);background:rgba(240,176,32,0.04)}

        /* Activity Log */
        .activity-log{max-height:180px;overflow-y:auto;font-family:monospace;font-size:10px;background:var(--bg);padding:8px;border-radius:8px}
        .activity-log div{padding:2px 0;border-bottom:1px solid rgba(28,38,56,0.5)}
        .activity-log .win{color:var(--green)}
        .activity-log .loss{color:var(--red)}
        .activity-log .info{color:var(--cyan)}
        .activity-log .alert{color:var(--yellow)}
        .activity-log .trade{color:var(--purple);font-weight:bold}
        .activity-log .cooldown{color:var(--cyan)}
        .activity-log .quad{color:var(--red);font-weight:bold}
        .activity-log .skip{color:var(--orange)}

        /* Rules Panel */
        .rules-panel{background:var(--bg);border:1px solid var(--border);border-radius:8px;padding:12px;margin-top:10px}
        .rule-row{display:flex;align-items:center;gap:8px;padding:6px 0;border-bottom:1px solid var(--border);font-size:11px}
        .rule-row:last-child{border:none}
        .rule-status{width:8px;height:8px;border-radius:50%;flex-shrink:0}
        .rule-status.active{background:var(--green);box-shadow:0 0 6px var(--green)}
        .rule-status.inactive{background:var(--dim)}
        .rule-status.triggered{background:var(--red);box-shadow:0 0 6px var(--red)}

        /* Progress bar */
        .progress-bar{height:8px;background:var(--border);border-radius:4px;overflow:hidden;margin-top:8px}
        .progress-fill{height:100%;border-radius:4px;transition:width 0.3s}

        /* Exit overlay */
        .exit-overlay{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:9999;justify-content:center;align-items:center}
        .exit-overlay.show{display:flex}
        .exit-modal{background:var(--card);border:2px solid var(--purple);border-radius:16px;padding:30px;max-width:420px;width:90%;text-align:center}
        .exit-modal h2{color:var(--purple);margin-bottom:10px;font-size:18px}
        .exit-modal p{color:var(--dim);margin-bottom:20px;font-size:12px}
        .exit-modal .data-summary{background:var(--bg);border-radius:8px;padding:12px;margin-bottom:20px;font-family:monospace;font-size:11px;text-align:left}
        .exit-modal .data-summary div{padding:3px 0;display:flex;justify-content:space-between}
        .exit-modal .data-summary .val{color:var(--cyan);font-weight:700}
        .exit-modal .btn-row{display:flex;gap:10px}
        .exit-modal .btn-row button{flex:1}

        /* Scrollbar */
        ::-webkit-scrollbar{width:5px}
        ::-webkit-scrollbar-track{background:var(--bg)}
        ::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
        ::-webkit-scrollbar-thumb:hover{background:var(--dim)}
    </style>
</head>
<body>
<div class="container">

    <!-- Header -->
    <div class="header">
        <h1>üéØ <span>Post-Quad Sniper</span> v1</h1>
        <div class="subtitle">WAIT FOR QUAD ‚Üí SNIPE 150 TICKS ‚Üí STOP ‚Üí REPEAT (MAX 2/DAY)</div>
    </div>

    <!-- Phase Banner -->
    <div class="phase-banner stopped" id="phaseBanner">
        <div class="phase-icon" id="phaseIcon">‚èπ</div>
        <div class="phase-title" id="phaseTitle">BOT STOPPED</div>
        <div class="phase-sub" id="phaseSub">Connect and start to begin watching for quads</div>
        <div class="phase-timer" id="phaseTimer" style="display:none"></div>
        <div class="tick-window" id="tickWindow" style="display:none">
            <div class="tw-label">
                <span id="twLabel">Tick Window</span>
                <span id="twCount">0 / 150</span>
            </div>
            <div class="tw-bar">
                <div class="tw-fill safe" id="twFill" style="width:0%"></div>
            </div>
        </div>
    </div>

    <!-- Session Tracker -->
    <div class="session-tracker">
        <div class="st-label">Today's Sessions</div>
        <div class="session-dots">
            <div class="session-dot" id="sessionDot1">1</div>
            <div class="session-dot" id="sessionDot2">2</div>
        </div>
        <div style="flex:1"></div>
        <div style="font-size:11px;color:var(--dim);font-family:monospace">
            <span id="sessionStatus">0 / 2 used</span>
        </div>
    </div>

    <!-- Status Bar -->
    <div class="status-bar">
        <div class="status-item">
            <div class="label">Status</div>
            <div class="value"><span class="dot" id="dot"></span> <span id="status">Offline</span></div>
        </div>
        <div class="status-item">
            <div class="label">Balance</div>
            <div class="value" id="balance" style="color:var(--green)">$0.00</div>
        </div>
        <div class="status-item">
            <div class="label">Market</div>
            <div class="value" id="marketDisplay">--</div>
        </div>
        <div class="status-item">
            <div class="label">Ticks</div>
            <div class="value" id="tickCount">0</div>
        </div>
        <div class="status-item">
            <div class="label">Reconn</div>
            <div class="value" id="reconnCount" style="color:var(--orange)">0</div>
        </div>
        <div class="status-item">
            <div class="label">Wake Lock</div>
            <div class="value" id="wakeLockStatus" style="color:var(--dim)">--</div>
        </div>
        <div class="status-item">
            <div class="label">Auto-Save</div>
            <div class="value" id="autoSaveStatus" style="color:var(--dim)">Off</div>
        </div>
    </div>

    <!-- Sniper Stats -->
    <div class="sniper-stats">
        <div class="sniper-stat">
            <div class="val purple" id="quadsObserved">0</div>
            <div class="lbl">Quads Seen</div>
        </div>
        <div class="sniper-stat">
            <div class="val" id="totalTrades">0</div>
            <div class="lbl">Trades</div>
        </div>
        <div class="sniper-stat">
            <div class="val green" id="wins">0</div>
            <div class="lbl">Wins</div>
        </div>
        <div class="sniper-stat">
            <div class="val cyan" id="winRate">0%</div>
            <div class="lbl">Win Rate</div>
        </div>
        <div class="sniper-stat">
            <div class="val green" id="pnl">$0.00</div>
            <div class="lbl">P/L</div>
        </div>
    </div>

    <!-- Connection -->
    <div class="card">
        <h3>üîå Connection</h3>
        <div class="row">
            <div>
                <label>API Token</label>
                <input type="password" id="token" placeholder="Enter your Deriv API token">
            </div>
            <div>
                <label>Symbol</label>
                <select id="symbol">
                    <option value="1HZ10V" selected>Volatility 10 (1s)</option>
                    <option value="1HZ25V">Volatility 25 (1s)</option>
                    <option value="1HZ50V">Volatility 50 (1s)</option>
                    <option value="1HZ75V">Volatility 75 (1s)</option>
                    <option value="1HZ100V">Volatility 100 (1s)</option>
                </select>
            </div>
        </div>
        <div style="margin-top:10px">
            <button class="btn-connect" onclick="connect()" id="connectBtn">üîó Connect to Deriv</button>
        </div>
    </div>

    <!-- Sniper Settings -->
    <div class="card">
        <h3>üéØ Sniper Settings</h3>
        <div class="row3">
            <div>
                <label>Tick Window (after quad)</label>
                <input type="number" id="tickWindowSize" value="150" min="50" max="500">
            </div>
            <div>
                <label>Cooldown (minutes)</label>
                <input type="number" id="cooldownMins" value="3" min="1" max="60">
            </div>
            <div>
                <label>Sessions / Day (max)</label>
                <input type="number" id="maxSessions" value="2" min="1" max="10">
            </div>
        </div>
        <div class="row3" style="margin-top:10px">
            <div>
                <label>Stake ($)</label>
                <input type="number" id="stake" value="10" min="0.35" step="0.01">
            </div>
            <div>
                <label>Max Freq % (skip hot)</label>
                <input type="number" id="maxFreq" value="16" min="8" max="25" step="1">
            </div>
            <div>
                <label>Min Triple Gap (ticks)</label>
                <input type="number" id="minTripleGap" value="20" min="0" max="100">
            </div>
        </div>

        <!-- Rules Panel -->
        <div class="rules-panel">
            <div style="font-size:10px;color:var(--dim);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px">Active Rules</div>
            <div class="rule-row">
                <div class="rule-status active" id="ruleQuad"></div>
                <span>Only trade after observing a quad</span>
            </div>
            <div class="rule-row">
                <div class="rule-status active" id="ruleWindow"></div>
                <span>Stop after tick window expires (<span id="ruleWindowVal">150</span> ticks)</span>
            </div>
            <div class="rule-row">
                <div class="rule-status active" id="ruleGap"></div>
                <span>Skip triples with gap &lt; <span id="ruleGapVal">20</span> ticks (rapid-fire filter)</span>
            </div>
            <div class="rule-row">
                <div class="rule-status active" id="ruleFreq"></div>
                <span>Skip triples where digit freq ‚â• <span id="ruleFreqVal">16</span>%</span>
            </div>
            <div class="rule-row">
                <div class="rule-status active" id="ruleLoss"></div>
                <span>Stop session on first loss (don't re-enter)</span>
            </div>
            <div class="rule-row">
                <div class="rule-status active" id="ruleSession"></div>
                <span>Max <span id="ruleSessionVal">2</span> sessions per day</span>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="card">
        <h3>üéÆ Controls</h3>
        <div class="row3">
            <button class="btn-green" onclick="startBot()" id="startBtn">‚ñ∂Ô∏è START SNIPER</button>
            <button class="btn-yellow" onclick="forceSnipe()" id="forceBtn" disabled>‚ö° FORCE SNIPE</button>
            <button class="btn-red" onclick="stopBot()" id="stopBtn">‚èπ STOP</button>
        </div>
        <div style="margin-top:8px">
            <button class="btn-outline" onclick="resetSessions()" style="width:100%">üîÑ Reset Daily Session Count</button>
        </div>
    </div>

    <!-- Live Display -->
    <div class="card highlight">
        <div class="digit-display">
            <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--dim);margin-bottom:8px">
                <span>üí∞ <span id="displayBalance" style="color:var(--green);font-weight:700">$0.00</span></span>
                <span>üìä <span id="displayPair" style="color:var(--cyan);font-weight:700">--</span></span>
            </div>
            <div id="priceDisplay" style="font-size:12px;color:var(--dim);margin-bottom:5px">Price: -.-----</div>
            <div class="current-digit" id="currentDigit" style="color:var(--yellow)">-</div>
            <div class="streak-indicator" id="streakIndicator">Waiting for data...</div>
        </div>

        <div class="digit-grid" id="digitGrid"></div>

        <!-- Snipe Window Progress -->
        <div style="margin-top:15px;padding:10px;background:var(--bg);border-radius:8px">
            <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:5px">
                <span id="progressLabel" style="color:var(--dim)">Session Progress</span>
                <span id="progressText" style="color:var(--dim)">Waiting for quad...</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width:0%;background:var(--dim)"></div>
            </div>
        </div>
    </div>

    <!-- Trade Log -->
    <div class="card">
        <h3>üí∞ Trade History</h3>
        <div class="trade-log" id="tradeLog">
            <div style="text-align:center;color:var(--dim);padding:20px;font-size:12px">No trades yet ‚Äî waiting for first quad</div>
        </div>
    </div>

    <!-- Activity Log -->
    <div class="card">
        <h3>üìã Activity Log</h3>
        <div class="activity-log" id="activityLog"></div>
    </div>

    <!-- Export -->
    <div class="card">
        <h3>üì• Export Data</h3>
        <div class="row4">
            <button class="btn-purple" onclick="exportTrades()">Trades</button>
            <button class="btn-purple" onclick="exportTicks()">Ticks</button>
            <button class="btn-purple" onclick="exportTriples()">Triples</button>
            <button class="btn-purple" onclick="exportActivity()">Activity</button>
        </div>
        <div style="margin-top:10px">
            <button class="btn-orange" onclick="exportAll()" style="width:100%">üì¶ DOWNLOAD ALL SESSION DATA</button>
        </div>
    </div>
</div>

<!-- Exit Overlay -->
<div class="exit-overlay" id="exitOverlay">
    <div class="exit-modal">
        <h2>üìä Unsaved Session Data</h2>
        <p>You have session data that hasn't been downloaded. Save before leaving?</p>
        <div class="data-summary" id="exitDataSummary"></div>
        <div class="btn-row">
            <button class="btn-green" onclick="exportAllAndLeave()">üíæ Download & Leave</button>
            <button class="btn-red" onclick="confirmLeave()">üö™ Leave</button>
        </div>
        <div style="margin-top:10px">
            <button class="btn-purple" onclick="cancelLeave()" style="width:100%">‚Üê Stay on Page</button>
        </div>
    </div>
</div>

<script>
// ============================================================
// STATE
// ============================================================
const state = {
    ws: null,
    connected: false,
    isRunning: false,

    // Phases: stopped | waiting | quad-seen | sniping | cooldown | session-limit
    phase: 'stopped',

    // Tick data
    ticks: [],
    recentDigits: [],
    frequencies: Array(10).fill(10),
    currentStreak: 1,
    lastDigit: null,

    // Full session archive
    allSessionTicks: [],
    sessionStartTime: null,

    // Triple tracking
    tripleEvents: [],
    pendingTripleEvent: null,
    lastTripleTickIndex: 0,
    lastQuadTickIndex: 0,
    digitTripleCounts: Array(10).fill(0),
    digitQuadCounts: Array(10).fill(0),
    lastTripleGap: 0,

    // === SNIPER STATE ===
    quadSeenAtTick: null,          // tick index when quad was detected
    ticksSinceQuad: 0,             // counter
    snipeWindowActive: false,
    snipeTradesThisWindow: 0,
    snipeWinsThisWindow: 0,
    lossInWindow: false,           // true = window killed by loss

    // Session tracking (max per day)
    sessionsToday: 0,
    sessionStartDate: new Date().toDateString(),

    // Trading
    pendingTrade: null,
    pendingContracts: new Map(),

    // Overall stats
    totalQuadsObserved: 0,
    totalTrades: 0,
    wins: 0,
    losses: 0,
    pnl: 0,
    winStreak: 0,
    bestWinStreak: 0,

    // Cooldown
    cooldownEndTime: null,

    // Connection
    autoReconnect: true,
    reconnectAttempts: 0,
    maxReconnectAttempts: 50,
    reconnectTimer: null,
    pingInterval: null,
    lastMessageTime: 0,
    staleCheckInterval: null,
    keepAliveWorker: null,
    savedToken: null,
    totalReconnects: 0,

    // Wake Lock
    wakeLock: null,
    wakeLockSupported: 'wakeLock' in navigator,

    // Auto-save
    autoSaveInterval: null,
    lastAutoSave: 0,
    autoSaveEnabled: true,

    // Export
    lastDownloadTime: 0,
    userWantsToLeave: false,

    // Logs
    tradeLog: [],
    activityLog: []
};

// ============================================================
// INITIALIZATION
// ============================================================
function initDigitGrid() {
    const grid = document.getElementById('digitGrid');
    grid.innerHTML = '';
    for (let i = 0; i < 10; i++) {
        const box = document.createElement('div');
        box.className = 'digit-box';
        box.id = `digit-${i}`;
        box.innerHTML = `<div class="digit-num">${i}</div><div class="digit-freq" id="freq-${i}">10.0%</div>`;
        grid.appendChild(box);
    }
}
initDigitGrid();

// Update rules display when settings change
document.getElementById('tickWindowSize').addEventListener('change', (e) => {
    document.getElementById('ruleWindowVal').textContent = e.target.value;
});
document.getElementById('minTripleGap').addEventListener('change', (e) => {
    document.getElementById('ruleGapVal').textContent = e.target.value;
});
document.getElementById('maxFreq').addEventListener('change', (e) => {
    document.getElementById('ruleFreqVal').textContent = e.target.value;
});
document.getElementById('maxSessions').addEventListener('change', (e) => {
    document.getElementById('ruleSessionVal').textContent = e.target.value;
});

// Cooldown timer
setInterval(() => {
    if (state.phase === 'cooldown' && state.cooldownEndTime) {
        const remaining = Math.max(0, state.cooldownEndTime - Date.now());
        const mins = Math.floor(remaining / 60000);
        const secs = Math.floor((remaining % 60000) / 1000);
        document.getElementById('phaseTimer').textContent =
            `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;

        const cooldownMins = parseInt(document.getElementById('cooldownMins').value) || 3;
        const totalMs = cooldownMins * 60 * 1000;
        const elapsed = totalMs - remaining;
        const pct = (elapsed / totalMs) * 100;
        document.getElementById('progressFill').style.width = pct + '%';
        document.getElementById('progressFill').style.background = 'var(--cyan)';

        if (remaining <= 0) endCooldown();
    }
}, 1000);

// ============================================================
// LOGGING
// ============================================================
function log(msg, type = 'info') {
    const time = new Date().toLocaleTimeString('en-US', { hour12: false });
    const el = document.getElementById('activityLog');
    el.innerHTML = `<div class="${type}">[${time}] ${msg}</div>` + el.innerHTML;
    if (el.children.length > 200) el.removeChild(el.lastChild);
    state.activityLog.push({ time, message: msg, type });
}

// ============================================================
// WAKE LOCK
// ============================================================
async function requestWakeLock() {
    if (!state.wakeLockSupported) {
        document.getElementById('wakeLockStatus').textContent = 'N/A';
        return;
    }
    try {
        state.wakeLock = await navigator.wakeLock.request('screen');
        document.getElementById('wakeLockStatus').textContent = 'üü¢ ON';
        document.getElementById('wakeLockStatus').style.color = 'var(--green)';
        state.wakeLock.addEventListener('release', () => {
            document.getElementById('wakeLockStatus').textContent = 'üî¥ OFF';
            document.getElementById('wakeLockStatus').style.color = 'var(--red)';
        });
    } catch(e) {
        document.getElementById('wakeLockStatus').textContent = '‚ùå';
        document.getElementById('wakeLockStatus').style.color = 'var(--red)';
    }
}

async function reacquireWakeLock() {
    if (state.wakeLockSupported && state.connected && (!state.wakeLock || state.wakeLock.released)) {
        await requestWakeLock();
    }
}

// ============================================================
// AUTO-SAVE (IndexedDB)
// ============================================================
const DB_NAME = 'PostQuadSniperV1';
const DB_STORE = 'sessions';
const DB_VERSION = 1;

function openDB() {
    return new Promise((resolve, reject) => {
        const req = indexedDB.open(DB_NAME, DB_VERSION);
        req.onupgradeneeded = (e) => {
            const db = e.target.result;
            if (!db.objectStoreNames.contains(DB_STORE)) {
                db.createObjectStore(DB_STORE, { keyPath: 'id' });
            }
        };
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
    });
}

async function autoSave() {
    if (!state.autoSaveEnabled || (state.allSessionTicks.length === 0 && state.tradeLog.length === 0)) return;
    try {
        const db = await openDB();
        const tx = db.transaction(DB_STORE, 'readwrite');
        tx.objectStore(DB_STORE).put({
            id: 'current_session',
            savedAt: new Date().toISOString(),
            savedAtMs: Date.now(),
            state: JSON.parse(JSON.stringify({
                allSessionTicks: state.allSessionTicks,
                tripleEvents: state.tripleEvents,
                tradeLog: state.tradeLog,
                totalQuadsObserved: state.totalQuadsObserved,
                totalTrades: state.totalTrades,
                wins: state.wins,
                losses: state.losses,
                pnl: state.pnl,
                winStreak: state.winStreak,
                bestWinStreak: state.bestWinStreak,
                sessionsToday: state.sessionsToday,
                totalReconnects: state.totalReconnects,
                sessionStartTime: state.sessionStartTime,
                activityLog: state.activityLog.slice(-300)
            }))
        });
        await new Promise((r, j) => { tx.oncomplete = r; tx.onerror = () => j(tx.error); });
        state.lastAutoSave = Date.now();
        document.getElementById('autoSaveStatus').textContent = new Date().toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
        document.getElementById('autoSaveStatus').style.color = 'var(--green)';
        db.close();
    } catch(e) {
        document.getElementById('autoSaveStatus').textContent = '‚ùå';
        document.getElementById('autoSaveStatus').style.color = 'var(--red)';
    }
}

function startAutoSave() {
    if (state.autoSaveInterval) clearInterval(state.autoSaveInterval);
    state.autoSaveInterval = setInterval(() => autoSave(), 5 * 60 * 1000);
    state.autoSaveEnabled = true;
    document.getElementById('autoSaveStatus').textContent = 'Active';
    document.getElementById('autoSaveStatus').style.color = 'var(--cyan)';
}

// ============================================================
// EXIT HANDLER
// ============================================================
function hasUnsavedData() {
    return state.allSessionTicks.length > 0 || state.tradeLog.length > 0;
}

window.addEventListener('beforeunload', function(e) {
    if (hasUnsavedData()) autoSave();
    if (hasUnsavedData() && (Date.now() - state.lastDownloadTime) > 120000 && !state.userWantsToLeave) {
        e.preventDefault();
        e.returnValue = '';
        return '';
    }
});

function exportAllAndLeave() {
    exportAll();
    setTimeout(() => { state.userWantsToLeave = true; document.getElementById('exitOverlay').classList.remove('show'); }, 500);
}
function confirmLeave() { state.userWantsToLeave = true; document.getElementById('exitOverlay').classList.remove('show'); }
function cancelLeave() { document.getElementById('exitOverlay').classList.remove('show'); }

// ============================================================
// CONNECTION (with auto-reconnect + Web Worker keep-alive)
// ============================================================
function createKeepAliveWorker() {
    if (state.keepAliveWorker) state.keepAliveWorker.terminate();
    const blob = new Blob([`
        let interval = null;
        self.onmessage = function(e) {
            if (e.data === 'start') { if (interval) clearInterval(interval); interval = setInterval(() => self.postMessage('ping'), 15000); }
            else if (e.data === 'stop') { if (interval) clearInterval(interval); interval = null; }
        };
    `], { type: 'application/javascript' });
    state.keepAliveWorker = new Worker(URL.createObjectURL(blob));
    state.keepAliveWorker.onmessage = () => {
        if (state.ws?.readyState === WebSocket.OPEN) state.ws.send(JSON.stringify({ ping: 1 }));
    };
}

function startStaleCheck() {
    if (state.staleCheckInterval) clearInterval(state.staleCheckInterval);
    state.staleCheckInterval = setInterval(() => {
        if (!state.connected) return;
        const staleSec = (Date.now() - state.lastMessageTime) / 1000;
        if (staleSec > 45) {
            log(`‚ö†Ô∏è Stale connection (${staleSec.toFixed(0)}s) ‚Äî forcing reconnect`, 'alert');
            state.ws?.close();
        }
    }, 10000);
}

document.addEventListener('visibilitychange', () => {
    if (document.visibilityState === 'visible') {
        reacquireWakeLock();
        if (state.savedToken) {
            const staleSec = (Date.now() - state.lastMessageTime) / 1000;
            if (staleSec > 30 && state.connected) {
                try { state.ws?.send(JSON.stringify({ ping: 1 })); } catch(e) {}
            } else if (!state.connected && state.autoReconnect) {
                attemptReconnect();
            }
        }
    }
});

function getReconnectDelay() { return Math.min(2000 * Math.pow(2, state.reconnectAttempts), 30000); }

function attemptReconnect() {
    if (state.reconnectTimer) clearTimeout(state.reconnectTimer);
    if (!state.savedToken || !state.autoReconnect) return;
    if (state.reconnectAttempts >= state.maxReconnectAttempts) {
        log(`üõë Max reconnect attempts reached`, 'loss');
        return;
    }
    const delay = getReconnectDelay();
    state.reconnectAttempts++;
    log(`üîÑ Reconnecting in ${(delay/1000).toFixed(0)}s (${state.reconnectAttempts}/${state.maxReconnectAttempts})...`, 'alert');
    document.getElementById('status').textContent = `Reconnecting...`;
    state.reconnectTimer = setTimeout(() => connectWithToken(state.savedToken), delay);
}

function connect() {
    const token = document.getElementById('token').value;
    if (!token) return log('Please enter API token', 'alert');
    state.savedToken = token;
    state.reconnectAttempts = 0;
    state.autoReconnect = true;
    connectWithToken(token);
}

function connectWithToken(token) {
    if (state.pingInterval) { clearInterval(state.pingInterval); state.pingInterval = null; }
    if (state.ws) {
        state.ws.onclose = null;
        if (state.ws.readyState === WebSocket.OPEN || state.ws.readyState === WebSocket.CONNECTING) state.ws.close();
    }

    log('Connecting...', 'info');
    document.getElementById('status').textContent = 'Connecting...';

    try {
        state.ws = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=1089');
    } catch(e) {
        log(`‚ùå WebSocket failed: ${e.message}`, 'loss');
        attemptReconnect();
        return;
    }

    state.ws.onopen = () => {
        state.ws.send(JSON.stringify({ authorize: token }));
        createKeepAliveWorker();
        state.keepAliveWorker.postMessage('start');
        if (state.pingInterval) clearInterval(state.pingInterval);
        state.pingInterval = setInterval(() => {
            if (state.ws?.readyState === WebSocket.OPEN) state.ws.send(JSON.stringify({ ping: 1 }));
        }, 20000);
        state.lastMessageTime = Date.now();
        startStaleCheck();
    };

    state.ws.onmessage = (e) => {
        state.lastMessageTime = Date.now();
        const data = JSON.parse(e.data);
        if (data.ping || data.pong) return;

        if (data.authorize) {
            state.connected = true;
            state.reconnectAttempts = 0;
            if (!state.sessionStartTime) state.sessionStartTime = Date.now();
            document.getElementById('dot').classList.add('on');
            document.getElementById('status').textContent = state.totalReconnects > 0 ? `Connected (R:${state.totalReconnects})` : 'Connected';
            log(`‚úÖ Connected!`, 'win');
            document.getElementById('balance').textContent = '$' + parseFloat(data.authorize.balance).toFixed(2);
            document.getElementById('displayBalance').textContent = '$' + parseFloat(data.authorize.balance).toFixed(2);
            subscribeTicks();
            requestWakeLock();
            startAutoSave();
        }

        if (data.tick) processTick(data.tick);
        if (data.buy) handleBuyResponse(data);
        if (data.proposal_open_contract) handleContractUpdate(data.proposal_open_contract);
        if (data.balance) {
            document.getElementById('balance').textContent = '$' + parseFloat(data.balance.balance).toFixed(2);
            document.getElementById('displayBalance').textContent = '$' + parseFloat(data.balance.balance).toFixed(2);
        }
    };

    state.ws.onclose = (e) => {
        state.connected = false;
        document.getElementById('dot').classList.remove('on');
        if (state.keepAliveWorker) state.keepAliveWorker.postMessage('stop');
        if (state.pingInterval) { clearInterval(state.pingInterval); state.pingInterval = null; }
        if (state.autoReconnect && state.savedToken) {
            state.totalReconnects++;
            document.getElementById('reconnCount').textContent = state.totalReconnects;
            log(`üî¥ Disconnected (${e.code}) ‚Äî auto-reconnecting...`, 'loss');
            attemptReconnect();
        } else {
            document.getElementById('status').textContent = 'Disconnected';
        }
    };

    state.ws.onerror = () => log('‚ö†Ô∏è WebSocket error', 'alert');
}

function subscribeTicks() {
    const symbol = document.getElementById('symbol').value;
    state.ws.send(JSON.stringify({ ticks: symbol, subscribe: 1 }));
    state.ws.send(JSON.stringify({ balance: 1, subscribe: 1 }));
    state.ws.send(JSON.stringify({ proposal_open_contract: 1, subscribe: 1 }));
    document.getElementById('marketDisplay').textContent = symbol;
    document.getElementById('displayPair').textContent = symbol;
    log(`üì° Subscribed to ${symbol}`, 'info');
}

// ============================================================
// TICK PROCESSING
// ============================================================
function processTick(tick) {
    const price = parseFloat(tick.quote);
    const digit = parseInt(tick.quote.toString().slice(-1));
    const prevDigit = state.lastDigit;

    // Display buffer
    state.ticks.push({ price, digit, epoch: tick.epoch });
    if (state.ticks.length > 500) state.ticks.shift();

    state.recentDigits.push(digit);
    if (state.recentDigits.length > 200) state.recentDigits.shift();

    // Rolling frequencies (last 100)
    const recent = state.recentDigits.slice(-100);
    const counts = Array(10).fill(0);
    recent.forEach(d => counts[d]++);
    state.frequencies = counts.map(c => (c / recent.length) * 100);

    // Streak
    let streak = 1;
    for (let i = state.recentDigits.length - 2; i >= 0; i--) {
        if (state.recentDigits[i] === digit) streak++;
        else break;
    }
    state.currentStreak = streak;
    state.lastDigit = digit;

    // Full archive
    const tickIndex = state.allSessionTicks.length;
    state.allSessionTicks.push({
        epoch: tick.epoch, price, digit, prevDigit, streak,
        freqs: [...state.frequencies],
        isTripleStart: (streak === 3),
        isQuad: (streak === 4),
        isQuintPlus: (streak >= 5),
        elapsed: state.sessionStartTime ? ((Date.now() - state.sessionStartTime) / 1000).toFixed(1) : '0'
    });

    // Triple event tracking
    trackTripleEvent(digit, streak, tick.epoch, tickIndex, prevDigit);

    // UI
    updateDigitDisplay(digit, price, streak);
    document.getElementById('tickCount').textContent = state.allSessionTicks.length;

    // === SNIPER LOGIC ===
    if (!state.isRunning || state.phase === 'stopped' || state.phase === 'cooldown' || state.phase === 'session-limit') return;

    // Track ticks since quad
    if (state.quadSeenAtTick !== null) {
        state.ticksSinceQuad = tickIndex - state.quadSeenAtTick;
    }

    // PHASE: WAITING ‚Äî watch for quads
    if (state.phase === 'waiting') {
        if (streak === 4) {
            onQuadDetected(digit, tickIndex);
        }
        return;
    }

    // PHASE: QUAD-SEEN ‚Äî brief visual pause, then auto-transition
    if (state.phase === 'quad-seen') {
        // Auto-transition to sniping after the quad resolves (next different digit)
        if (digit !== state._quadDigit) {
            startSniping();
        }
        return;
    }

    // PHASE: SNIPING ‚Äî trade triples within window
    if (state.phase === 'sniping') {
        const windowSize = parseInt(document.getElementById('tickWindowSize').value) || 150;

        // Update tick window display
        updateTickWindow(state.ticksSinceQuad, windowSize);

        // Check window expiry
        if (state.ticksSinceQuad >= windowSize) {
            endSnipeWindow('Window expired');
            return;
        }

        // Detect triple ‚Äî trade it if rules pass
        if (streak === 3 && !state.pendingTrade) {
            evaluateAndTrade(digit, tickIndex);
        }

        // Detect quad during sniping ‚Äî this is a loss scenario handled in contract update
        if (streak === 4) {
            log(`üí• QUAD D${digit} during snipe window ‚Äî if traded, loss incoming`, 'quad');
        }
    }
}

// ============================================================
// QUAD DETECTION
// ============================================================
function onQuadDetected(digit, tickIndex) {
    state.totalQuadsObserved++;
    state.quadSeenAtTick = tickIndex;
    state.ticksSinceQuad = 0;
    state._quadDigit = digit;
    state.snipeTradesThisWindow = 0;
    state.snipeWinsThisWindow = 0;
    state.lossInWindow = false;

    document.getElementById('quadsObserved').textContent = state.totalQuadsObserved;

    state.phase = 'quad-seen';
    log(`üí• QUAD DETECTED! D${digit} x4 ‚Äî preparing snipe window...`, 'quad');
    updatePhaseBanner();
}

function startSniping() {
    state.phase = 'sniping';
    state.snipeWindowActive = true;
    const windowSize = parseInt(document.getElementById('tickWindowSize').value) || 150;
    log(`üéØ SNIPE WINDOW OPEN ‚Äî trading triples for next ${windowSize} ticks`, 'trade');
    updatePhaseBanner();
    document.getElementById('tickWindow').style.display = 'block';
    document.getElementById('forceBtn').disabled = true;
}

function endSnipeWindow(reason) {
    state.snipeWindowActive = false;
    state.sessionsToday++;

    const w = state.snipeWinsThisWindow;
    const t = state.snipeTradesThisWindow;
    log(`üõë Snipe window closed: ${reason} | ${w}/${t} wins this window`, 'info');

    updateSessionDots();

    const maxSessions = parseInt(document.getElementById('maxSessions').value) || 2;
    if (state.sessionsToday >= maxSessions) {
        state.phase = 'session-limit';
        log(`üèÅ Daily session limit reached (${state.sessionsToday}/${maxSessions})`, 'alert');
        updatePhaseBanner();
        document.getElementById('tickWindow').style.display = 'none';
        return;
    }

    // Go to cooldown
    startCooldown();
}

// ============================================================
// TRADE EVALUATION (all rules checked here)
// ============================================================
function evaluateAndTrade(digit, tickIndex) {
    const maxFreq = parseFloat(document.getElementById('maxFreq').value) || 16;
    const minGap = parseInt(document.getElementById('minTripleGap').value) || 20;
    const freq = state.frequencies[digit];

    // Rule: Skip if loss already happened in this window
    if (state.lossInWindow) {
        log(`‚õî Skipping D${digit} ‚Äî loss already occurred in this window`, 'skip');
        addSkipEntry(digit, freq, 'Loss in window');
        return;
    }

    // Rule: Frequency filter
    if (freq >= maxFreq) {
        log(`‚õî Skipping D${digit} ‚Äî freq ${freq.toFixed(1)}% ‚â• ${maxFreq}% (hot)`, 'skip');
        highlightRule('ruleFreq');
        addSkipEntry(digit, freq, `Freq ${freq.toFixed(1)}% ‚â• ${maxFreq}%`);
        return;
    }

    // Rule: Triple gap filter
    const gap = tickIndex - state.lastTripleTickIndex;
    if (gap < minGap && state.lastTripleTickIndex > 0) {
        log(`‚õî Skipping D${digit} ‚Äî gap ${gap} ticks < ${minGap} (rapid-fire)`, 'skip');
        highlightRule('ruleGap');
        addSkipEntry(digit, freq, `Gap ${gap} < ${minGap}`);
        return;
    }

    // All rules passed ‚Äî TRADE!
    state.snipeTradesThisWindow++;
    log(`üéØ SNIPE #${state.snipeTradesThisWindow}: DIFFERS D${digit} (${freq.toFixed(1)}%) [${state.ticksSinceQuad} ticks post-quad]`, 'trade');

    // Mark triple event as traded
    if (state.pendingTripleEvent && state.pendingTripleEvent.digit === digit) {
        state.pendingTripleEvent.wasTradedOn = true;
    }

    placeTrade(digit, freq);
}

function highlightRule(ruleId) {
    const el = document.getElementById(ruleId);
    el.classList.remove('active');
    el.classList.add('triggered');
    setTimeout(() => { el.classList.remove('triggered'); el.classList.add('active'); }, 1500);
}

// ============================================================
// TRADING
// ============================================================
function placeTrade(digit, freq) {
    const stake = parseFloat(document.getElementById('stake').value) || 10;
    state.pendingTrade = { digit, freq, stake, time: new Date().toISOString(), ticksSinceQuad: state.ticksSinceQuad };

    state.ws.send(JSON.stringify({
        buy: 1,
        price: stake,
        parameters: {
            amount: stake,
            basis: 'stake',
            contract_type: 'DIGITDIFF',
            currency: 'USD',
            duration: 1,
            duration_unit: 't',
            symbol: document.getElementById('symbol').value,
            barrier: digit.toString()
        }
    }));
}

function handleBuyResponse(data) {
    if (data.error) {
        log(`‚ùå Buy error: ${data.error.message}`, 'loss');
        state.pendingTrade = null;
        return;
    }
    if (data.buy) {
        state.pendingContracts.set(data.buy.contract_id, state.pendingTrade);
        log(`üì§ Contract ${data.buy.contract_id} placed`, 'info');
    }
}

function handleContractUpdate(contract) {
    const info = state.pendingContracts.get(contract.contract_id);
    if (!info) return;
    if (contract.status !== 'won' && contract.status !== 'lost') return;

    state.pendingContracts.delete(contract.contract_id);
    state.pendingTrade = null;

    const won = contract.status === 'won';
    const profit = parseFloat(contract.profit) || (won ? info.stake * 0.0965 : -info.stake);

    state.totalTrades++;
    state.pnl += profit;

    if (won) {
        state.wins++;
        state.winStreak++;
        state.snipeWinsThisWindow++;
        if (state.winStreak > state.bestWinStreak) state.bestWinStreak = state.winStreak;
        log(`‚úÖ WIN! D${info.digit} ‚Üí +$${profit.toFixed(2)} [streak: ${state.winStreak}]`, 'win');
        linkTradeToTripleEvent(info.digit, profit);
    } else {
        state.losses++;
        state.winStreak = 0;
        state.lossInWindow = true;
        log(`‚ùå LOSS! D${info.digit} quad ‚Üí -$${Math.abs(profit).toFixed(2)} ‚Äî closing window`, 'loss');
        linkTradeToTripleEvent(info.digit, profit);
    }

    addTradeEntry(info, won, profit);
    updateStats();

    // On loss, immediately end snipe window
    if (!won && state.phase === 'sniping') {
        endSnipeWindow('Loss detected ‚Äî rule: stop on first loss');
    }
}

function linkTradeToTripleEvent(digit, profit) {
    for (let i = state.tripleEvents.length - 1; i >= 0; i--) {
        const te = state.tripleEvents[i];
        if (te.digit === digit && te.wasTradedOn && te.tradeProfit === null) {
            te.tradeProfit = profit;
            return;
        }
    }
    if (state.pendingTripleEvent && state.pendingTripleEvent.digit === digit && state.pendingTripleEvent.wasTradedOn) {
        state.pendingTripleEvent.tradeProfit = profit;
    }
}

// ============================================================
// TRIPLE EVENT TRACKING
// ============================================================
function trackTripleEvent(digit, streak, epoch, tickIndex, prevDigit) {
    if (streak === 3 && !state.pendingTripleEvent) {
        state.digitTripleCounts[digit]++;
        const minFreq = Math.min(...state.frequencies);
        const maxFreq = Math.max(...state.frequencies);
        const entropy = -state.frequencies.reduce((sum, f) => {
            const p = f / 100;
            return sum + (p > 0 ? p * Math.log2(p) : 0);
        }, 0);
        const prev30 = state.recentDigits.slice(-33, -3);
        const digitBeforeTriple = prev30.length > 0 ? prev30[prev30.length - 1] : null;

        state.lastTripleGap = tickIndex - state.lastTripleTickIndex;

        state.pendingTripleEvent = {
            id: state.tripleEvents.length + 1,
            epoch, time: new Date().toISOString(), digit, digitBeforeTriple,
            digitFreq: state.frequencies[digit],
            allFreqs: [...state.frequencies],
            coldestDigit: state.frequencies.indexOf(minFreq),
            coldestFreq: minFreq,
            hottestDigit: state.frequencies.indexOf(maxFreq),
            hottestFreq: maxFreq,
            entropy,
            tickIndex,
            ticksSinceLastTriple: tickIndex - state.lastTripleTickIndex,
            ticksSinceLastQuad: tickIndex - state.lastQuadTickIndex,
            ticksSinceQuadSeen: state.quadSeenAtTick !== null ? tickIndex - state.quadSeenAtTick : null,
            digitTripleCount: state.digitTripleCounts[digit],
            digitQuadCount: state.digitQuadCounts[digit],
            phase: state.phase,
            sessionNum: state.sessionsToday,
            runningWinRate: state.totalTrades > 0 ? (state.wins / state.totalTrades * 100) : 0,
            currentWinStreak: state.winStreak,
            totalTradesAtTime: state.totalTrades,
            runningPnl: state.pnl,
            maxStreak: 3,
            outcome: 'pending',
            nextDigit: null,
            wasTradedOn: false,
            tradeProfit: null
        };

        state.lastTripleTickIndex = tickIndex;

    } else if (state.pendingTripleEvent) {
        if (digit === state.pendingTripleEvent.digit) {
            state.pendingTripleEvent.maxStreak = streak;
            if (streak === 4) {
                state.pendingTripleEvent.outcome = 'quad';
                state.digitQuadCounts[digit]++;
                state.lastQuadTickIndex = tickIndex;
            }
        } else {
            if (state.pendingTripleEvent.outcome === 'pending') {
                state.pendingTripleEvent.outcome = 'bounce';
            }
            state.pendingTripleEvent.nextDigit = digit;
            state.pendingTripleEvent.resolutionEpoch = epoch;
            state.tripleEvents.push(state.pendingTripleEvent);
            state.pendingTripleEvent = null;
        }
    }
}

// ============================================================
// UI UPDATES
// ============================================================
function updateDigitDisplay(digit, price, streak) {
    document.getElementById('priceDisplay').textContent = `Price: ${price.toFixed(5)}`;
    document.getElementById('currentDigit').textContent = digit;

    const isTriple = streak >= 3;
    const isQuad = streak >= 4;
    document.getElementById('currentDigit').style.color = isQuad ? 'var(--red)' : isTriple ? 'var(--purple)' : 'var(--yellow)';

    const streakEl = document.getElementById('streakIndicator');
    if (isQuad) {
        streakEl.textContent = `üí• QUAD! (${streak}x D${digit})`;
        streakEl.className = 'streak-indicator quad';
    } else if (isTriple) {
        streakEl.textContent = `üî• TRIPLE! (${streak}x D${digit})`;
        streakEl.className = 'streak-indicator triple';
    } else if (streak === 2) {
        streakEl.textContent = `‚ö° Double (2x D${digit})`;
        streakEl.className = 'streak-indicator';
        streakEl.style.color = 'var(--orange)';
    } else {
        streakEl.textContent = `Single (D${digit})`;
        streakEl.className = 'streak-indicator';
        streakEl.style.color = 'var(--dim)';
    }

    for (let i = 0; i < 10; i++) {
        const box = document.getElementById(`digit-${i}`);
        const freqEl = document.getElementById(`freq-${i}`);
        freqEl.textContent = state.frequencies[i].toFixed(1) + '%';
        box.className = 'digit-box';
        if (i === digit) {
            if (isQuad) box.classList.add('quad-glow');
            else if (isTriple) box.classList.add('tripled');
            else box.classList.add('active');
        }
    }
}

function updateTickWindow(ticksSince, windowSize) {
    const pct = Math.min((ticksSince / windowSize) * 100, 100);
    const remaining = windowSize - ticksSince;

    document.getElementById('twLabel').textContent = `Snipe Window`;
    document.getElementById('twCount').textContent = `${ticksSince} / ${windowSize} ticks (${remaining} remaining)`;

    const fill = document.getElementById('twFill');
    fill.style.width = pct + '%';
    fill.className = 'tw-fill ' + (pct < 60 ? 'safe' : pct < 85 ? 'warning' : 'danger');

    document.getElementById('progressLabel').textContent = `Window: ${state.snipeTradesThisWindow} trades`;
    document.getElementById('progressText').textContent = `${remaining} ticks left`;
    document.getElementById('progressFill').style.width = pct + '%';
    document.getElementById('progressFill').style.background = pct < 60 ? 'var(--green)' : pct < 85 ? 'var(--yellow)' : 'var(--red)';
}

function updatePhaseBanner() {
    const banner = document.getElementById('phaseBanner');
    const icon = document.getElementById('phaseIcon');
    const title = document.getElementById('phaseTitle');
    const sub = document.getElementById('phaseSub');
    const timer = document.getElementById('phaseTimer');

    banner.className = 'phase-banner ' + state.phase;

    switch (state.phase) {
        case 'stopped':
            icon.textContent = '‚èπ'; title.textContent = 'BOT STOPPED';
            sub.textContent = 'Connect and start to begin'; timer.style.display = 'none'; break;
        case 'waiting':
            icon.textContent = '‚è≥'; title.textContent = 'WAITING FOR QUAD';
            sub.textContent = `Quads seen today: ${state.totalQuadsObserved} | Watching all triples...`;
            timer.style.display = 'none'; break;
        case 'quad-seen':
            icon.textContent = 'üí•'; title.textContent = 'QUAD DETECTED!';
            sub.textContent = `D${state._quadDigit} x4 ‚Äî preparing snipe window...`;
            timer.style.display = 'none'; break;
        case 'sniping':
            icon.textContent = 'üéØ'; title.textContent = 'SNIPING';
            sub.textContent = `${state.snipeTradesThisWindow} trades | ${state.snipeWinsThisWindow} wins | Session #${state.sessionsToday + 1}`;
            timer.style.display = 'none'; break;
        case 'cooldown':
            icon.textContent = '‚ùÑÔ∏è'; title.textContent = 'COOLDOWN';
            sub.textContent = 'Waiting before next quad watch...'; timer.style.display = 'block'; break;
        case 'session-limit':
            icon.textContent = 'üèÅ'; title.textContent = 'DAILY LIMIT REACHED';
            sub.textContent = `${state.sessionsToday} sessions completed today. Reset or wait.`;
            timer.style.display = 'none'; break;
    }
}

function updateSessionDots() {
    const maxSessions = parseInt(document.getElementById('maxSessions').value) || 2;
    for (let i = 1; i <= 2; i++) {
        const dot = document.getElementById(`sessionDot${i}`);
        dot.className = 'session-dot';
        if (i <= state.sessionsToday) dot.classList.add('used');
        else if (i === state.sessionsToday + 1 && state.phase === 'sniping') dot.classList.add('active');
        if (i > maxSessions) dot.classList.add('locked');
    }
    document.getElementById('sessionStatus').textContent = `${state.sessionsToday} / ${maxSessions} used`;
}

function updateStats() {
    document.getElementById('totalTrades').textContent = state.totalTrades;
    document.getElementById('wins').textContent = state.wins;
    document.getElementById('winRate').textContent = state.totalTrades > 0
        ? (state.wins / state.totalTrades * 100).toFixed(1) + '%' : '0%';
    document.getElementById('pnl').textContent = '$' + state.pnl.toFixed(2);
    document.getElementById('pnl').className = 'val ' + (state.pnl >= 0 ? 'green' : 'red');
}

function addTradeEntry(info, won, profit) {
    const el = document.getElementById('tradeLog');
    if (state.totalTrades === 1) el.innerHTML = '';
    const entry = document.createElement('div');
    entry.className = `trade-entry ${won ? 'win' : 'loss'}`;
    entry.innerHTML = `
        <span>S${state.sessionsToday + (state.phase === 'sniping' ? 1 : 0)} | D${info.digit} (${info.freq.toFixed(1)}%) ${info.ticksSinceQuad}t post-quad ‚Äî ${won ? 'WIN ‚úÖ' : 'LOSS ‚ùå'}</span>
        <span style="color:${won ? 'var(--green)' : 'var(--red)'}">${profit >= 0 ? '+' : ''}$${profit.toFixed(2)}</span>
    `;
    el.insertBefore(entry, el.firstChild);
    state.tradeLog.push({
        session: state.sessionsToday + (state.phase === 'sniping' ? 1 : 0),
        time: info.time, digit: info.digit, freq: info.freq.toFixed(1),
        ticksSinceQuad: info.ticksSinceQuad,
        result: won ? 'WIN' : 'LOSS', profit: profit.toFixed(2)
    });
}

function addSkipEntry(digit, freq, reason) {
    const el = document.getElementById('tradeLog');
    if (el.querySelector('div[style]') && state.totalTrades === 0) el.innerHTML = '';
    const entry = document.createElement('div');
    entry.className = 'trade-entry skip';
    entry.innerHTML = `
        <span>SKIP | D${digit} (${freq.toFixed(1)}%) ‚Äî ${reason}</span>
        <span style="color:var(--yellow)">--</span>
    `;
    el.insertBefore(entry, el.firstChild);
}

// ============================================================
// COOLDOWN
// ============================================================
function startCooldown() {
    state.phase = 'cooldown';
    const cooldownMins = parseInt(document.getElementById('cooldownMins').value) || 3;
    state.cooldownEndTime = Date.now() + (cooldownMins * 60 * 1000);
    log(`‚ùÑÔ∏è Cooldown: ${cooldownMins} minutes`, 'cooldown');
    document.getElementById('phaseTimer').style.display = 'block';
    document.getElementById('tickWindow').style.display = 'none';
    updatePhaseBanner();
}

function endCooldown() {
    state.cooldownEndTime = null;
    document.getElementById('phaseTimer').style.display = 'none';
    log(`‚úÖ Cooldown complete ‚Äî resuming quad watch`, 'win');
    startWaiting();
}

// ============================================================
// BOT CONTROLS
// ============================================================
function startBot() {
    if (!state.connected) { log('Please connect first!', 'alert'); return; }
    if (state.ticks.length < 50) { log(`Need more ticks (${state.ticks.length}/50). Wait...`, 'alert'); return; }

    // Check daily date reset
    const today = new Date().toDateString();
    if (state.sessionStartDate !== today) {
        state.sessionsToday = 0;
        state.sessionStartDate = today;
        log('üìÖ New day ‚Äî session count reset', 'info');
    }

    const maxSessions = parseInt(document.getElementById('maxSessions').value) || 2;
    if (state.sessionsToday >= maxSessions) {
        log(`üèÅ Daily limit (${maxSessions}) already reached. Reset to continue.`, 'alert');
        state.phase = 'session-limit';
        updatePhaseBanner();
        return;
    }

    state.isRunning = true;
    document.getElementById('startBtn').disabled = true;
    document.getElementById('forceBtn').disabled = false;
    log('‚ñ∂Ô∏è Sniper started! Watching for quads...', 'trade');
    startWaiting();
}

function startWaiting() {
    state.phase = 'waiting';
    state.quadSeenAtTick = null;
    state.snipeWindowActive = false;
    state.lossInWindow = false;
    document.getElementById('tickWindow').style.display = 'none';
    document.getElementById('progressLabel').textContent = 'Waiting';
    document.getElementById('progressText').textContent = 'Watching for quad...';
    document.getElementById('progressFill').style.width = '0%';
    document.getElementById('progressFill').style.background = 'var(--dim)';
    updatePhaseBanner();
    updateSessionDots();
}

function forceSnipe() {
    if (!state.connected || !state.isRunning) { log('Bot must be running!', 'alert'); return; }
    if (state.phase === 'sniping') { log('Already sniping!', 'alert'); return; }
    if (state.phase === 'session-limit') { log('Daily limit reached!', 'alert'); return; }

    const maxSessions = parseInt(document.getElementById('maxSessions').value) || 2;
    if (state.sessionsToday >= maxSessions) {
        log(`üèÅ Daily limit (${maxSessions}) reached`, 'alert');
        return;
    }

    log('‚ö° FORCE SNIPE ‚Äî bypassing quad wait (manual override)', 'alert');
    state.quadSeenAtTick = state.allSessionTicks.length;
    state.ticksSinceQuad = 0;
    state.snipeTradesThisWindow = 0;
    state.snipeWinsThisWindow = 0;
    state.lossInWindow = false;
    startSniping();
}

function stopBot() {
    state.isRunning = false;
    state.phase = 'stopped';
    state.pendingTrade = null;
    state.snipeWindowActive = false;
    state.cooldownEndTime = null;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('forceBtn').disabled = true;
    document.getElementById('phaseTimer').style.display = 'none';
    document.getElementById('tickWindow').style.display = 'none';
    updatePhaseBanner();
    log('‚èπ Sniper stopped', 'info');
}

function resetSessions() {
    state.sessionsToday = 0;
    state.sessionStartDate = new Date().toDateString();
    updateSessionDots();
    log('üîÑ Daily session count reset', 'info');
    if (state.phase === 'session-limit' && state.isRunning) {
        startWaiting();
    }
}

// ============================================================
// EXPORT FUNCTIONS
// ============================================================
function markDownload() { state.lastDownloadTime = Date.now(); }

function exportTrades() {
    if (!state.tradeLog.length) return log('No trades to export', 'alert');
    const csv = ['session,time,digit,freq,ticks_since_quad,result,profit',
        ...state.tradeLog.map(t => `${t.session},${t.time},${t.digit},${t.freq},${t.ticksSinceQuad},${t.result},${t.profit}`)
    ].join('\n');
    download(csv, `sniper_trades_${Date.now()}.csv`);
    markDownload();
}

function exportTicks() {
    if (!state.allSessionTicks.length) return log('No ticks to export', 'alert');
    const header = 'tick_num,epoch,elapsed_sec,price,digit,prev_digit,streak,is_triple_start,is_quad,is_quint_plus,' +
        Array.from({length:10}, (_,i) => `freq_d${i}`).join(',');
    const rows = state.allSessionTicks.map((t, i) => {
        const f = t.freqs || Array(10).fill(10);
        return [i, t.epoch, t.elapsed, t.price, t.digit, t.prevDigit ?? '', t.streak,
            t.isTripleStart?1:0, t.isQuad?1:0, t.isQuintPlus?1:0, ...f.map(v=>v.toFixed(1))].join(',');
    });
    download([header, ...rows].join('\n'), `sniper_ticks_${Date.now()}.csv`);
    markDownload();
}

function exportTriples() {
    if (!state.tripleEvents.length) return log('No triples to export', 'alert');
    const header = 'id,epoch,time,digit,digit_freq,outcome,max_streak,next_digit,ticks_since_quad_seen,' +
        'ticks_since_last_triple,was_traded,trade_profit,phase,session_num';
    const rows = state.tripleEvents.map(te => [
        te.id, te.epoch, te.time, te.digit, te.digitFreq.toFixed(1),
        te.outcome, te.maxStreak, te.nextDigit ?? '',
        te.ticksSinceQuadSeen ?? '', te.ticksSinceLastTriple,
        te.wasTradedOn?1:0, te.tradeProfit !== null ? te.tradeProfit.toFixed(2) : '',
        te.phase, te.sessionNum
    ].join(','));
    download([header, ...rows].join('\n'), `sniper_triples_${Date.now()}.csv`);
    markDownload();
}

function exportActivity() {
    if (!state.activityLog.length) return log('No activity to export', 'alert');
    download(state.activityLog.map(a => `[${a.time}] ${a.message}`).join('\n'), `sniper_activity_${Date.now()}.txt`);
    markDownload();
}

function exportAll() {
    const ts = Date.now();
    let count = 0;
    const bounces = state.tripleEvents.filter(e => e.outcome === 'bounce').length;
    const quads = state.tripleEvents.filter(e => e.outcome === 'quad').length;
    const summary = {
        strategy: 'Post-Quad Sniper v1',
        sessionStart: state.sessionStartTime ? new Date(state.sessionStartTime).toISOString() : null,
        sessionEnd: new Date().toISOString(),
        symbol: document.getElementById('symbol').value,
        totalTicks: state.allSessionTicks.length,
        totalTriples: state.tripleEvents.length,
        bounces, quads,
        bounceRate: state.tripleEvents.length > 0 ? (bounces/state.tripleEvents.length*100).toFixed(1)+'%' : 'N/A',
        totalQuadsObserved: state.totalQuadsObserved,
        sessionsToday: state.sessionsToday,
        totalTrades: state.totalTrades,
        wins: state.wins, losses: state.losses,
        winRate: state.totalTrades > 0 ? (state.wins/state.totalTrades*100).toFixed(1)+'%' : 'N/A',
        pnl: state.pnl.toFixed(2),
        bestWinStreak: state.bestWinStreak,
        settings: {
            tickWindow: document.getElementById('tickWindowSize').value,
            cooldownMins: document.getElementById('cooldownMins').value,
            maxSessions: document.getElementById('maxSessions').value,
            stake: document.getElementById('stake').value,
            maxFreq: document.getElementById('maxFreq').value,
            minTripleGap: document.getElementById('minTripleGap').value
        }
    };
    download(JSON.stringify(summary, null, 2), `sniper_summary_${ts}.json`);
    count++;
    if (state.allSessionTicks.length > 0) { exportTicks(); count++; }
    if (state.tripleEvents.length > 0) { exportTriples(); count++; }
    if (state.tradeLog.length > 0) { exportTrades(); count++; }
    if (state.activityLog.length > 0) { exportActivity(); count++; }
    markDownload();
    log(`üì¶ All data exported (${count} files)`, 'win');
}

function download(content, filename) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([content], { type: 'text/plain' }));
    a.download = filename;
    a.click();
}

log('üéØ Post-Quad Sniper v1 ready. Connect to start.', 'info');
</script>
</body>
</html>
